# 25.04.14 TIL

### ë¬´ì¤‘ë‹¨ ë°°í¬  ì„¤ê³„ í•™ìŠµ

- ë°°í¬ íë¦„

```java
ë¹Œë“œ â†’ í…ŒìŠ¤íŠ¸ â†’ í—¬ìŠ¤ì²´í¬ â†’ Nginx ìŠ¤ìœ„ì¹­ â†’ ì´ì „ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ
```

- ë””ë ‰í„°ë¦¬ êµ¬ì¡° (ì˜ˆì‹œ)

```bash
/srv/app/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â””â”€â”€ ...
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â””â”€â”€ ...
â”œâ”€â”€ nginx/
â”‚   â””â”€â”€ app.conf
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ deploy_backend.sh
â”‚   â””â”€â”€ deploy_frontend.sh

```

- ë°±ì—”ë“œ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ deploy_backend.sh
    
    ```bash
    #!/usr/bin/env bash
    set -euo pipefail
    
    APP_NAME=backend
    BUILD_DIR=/srv/app/backend
    PORT1=8081
    PORT2=8082
    
    cd $BUILD_DIR
    
    ### 1. í˜„ì¬ ì‚¬ìš©ì¤‘ì¸ í¬íŠ¸ í™•ì¸
    CURRENT_PORT=$(docker ps --format '{{.Ports}}' | grep "$PORT1" && echo $PORT1 || echo $PORT2)
    NEW_PORT=$([ "$CURRENT_PORT" == "$PORT1" ] && echo $PORT2 || echo $PORT1)
    
    echo "â–¶ï¸ í˜„ì¬ ì‚¬ìš©ì¤‘ì¸ í¬íŠ¸: $CURRENT_PORT"
    echo "â¡ï¸ ìƒˆ ì»¨í…Œì´ë„ˆ í¬íŠ¸: $NEW_PORT"
    
    ### 2. ë¹Œë“œ
    ./gradlew build -x test
    
    ### 3. í…ŒìŠ¤íŠ¸
    ./gradlew test
    
    ### 4. Docker ë¹Œë“œ ë° ì‹¤í–‰
    docker build -t $APP_NAME:latest .
    docker run -d --rm --name ${APP_NAME}-${NEW_PORT} -p ${NEW_PORT}:8080 \
      --health-cmd="curl -f http://localhost:8080/health || exit 1" \
      --health-interval=10s --health-retries=3 \
      $APP_NAME:latest
    
    ### 5. í—¬ìŠ¤ì²´í¬ ëŒ€ê¸°
    echo -n "â³ í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° "
    until docker inspect --format='{{.State.Health.Status}}' ${APP_NAME}-${NEW_PORT} | grep -q "healthy"; do
      echo -n "."
      sleep 2
    done
    echo "âœ… í—¬ì‹œ"
    
    ### 6. Nginx upstream ë³€ê²½
    echo "server 127.0.0.1:${NEW_PORT};" | sudo tee /etc/nginx/conf.d/upstream_backend.conf > /dev/null
    sudo nginx -s reload
    
    ### 7. ì´ì „ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ
    docker rm -f $(docker ps -q -f name=${APP_NAME}-${CURRENT_PORT}) || true
    
    echo "âœ… ë°±ì—”ë“œ ë¬´ì¤‘ë‹¨ ë°°í¬ ì™„ë£Œ!"
    
    ```
    
- í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ deploy_frontend.sh
    
    ```bash
    #!/usr/bin/env bash
    set -euo pipefail
    
    APP_NAME=frontend
    BUILD_DIR=/srv/app/frontend
    PORT1=3001
    PORT2=3002
    
    cd $BUILD_DIR
    
    ### 1. í˜„ì¬ ì‚¬ìš©ì¤‘ì¸ í¬íŠ¸ í™•ì¸
    CURRENT_PORT=$(docker ps --format '{{.Ports}}' | grep "$PORT1" && echo $PORT1 || echo $PORT2)
    NEW_PORT=$([ "$CURRENT_PORT" == "$PORT1" ] && echo $PORT2 || echo $PORT1)
    
    echo "â–¶ï¸ í˜„ì¬ ì‚¬ìš©ì¤‘ì¸ í¬íŠ¸: $CURRENT_PORT"
    echo "â¡ï¸ ìƒˆ ì»¨í…Œì´ë„ˆ í¬íŠ¸: $NEW_PORT"
    
    ### 2. ì˜ì¡´ì„± ì„¤ì¹˜ ë° ë¹Œë“œ
    npm ci
    npm run build
    
    ### 3. í…ŒìŠ¤íŠ¸
    npm run test
    
    ### 4. Docker ë¹Œë“œ ë° ì‹¤í–‰
    docker build -t $APP_NAME:latest .
    docker run -d --rm --name ${APP_NAME}-${NEW_PORT} -p ${NEW_PORT}:3000 \
      --health-cmd="curl -f http://localhost:3000 || exit 1" \
      --health-interval=10s --health-retries=3 \
      $APP_NAME:latest
    
    ### 5. í—¬ìŠ¤ì²´í¬ ëŒ€ê¸°
    echo -n "â³ í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° "
    until docker inspect --format='{{.State.Health.Status}}' ${APP_NAME}-${NEW_PORT} | grep -q "healthy"; do
      echo -n "."
      sleep 2
    done
    echo "âœ… í—¬ì‹œ"
    
    ### 6. Nginx upstream ë³€ê²½
    echo "server 127.0.0.1:${NEW_PORT};" | sudo tee /etc/nginx/conf.d/upstream_frontend.conf > /dev/null
    sudo nginx -s reload
    
    ### 7. ì´ì „ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ
    docker rm -f $(docker ps -q -f name=${APP_NAME}-${CURRENT_PORT}) || true
    
    echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ë¬´ì¤‘ë‹¨ ë°°í¬ ì™„ë£Œ!"
    
    ```
    
- Nginx ì„¤ì •
    
    ```rust
    upstream backend {
        include /etc/nginx/conf.d/upstream_backend.conf;
    }
    
    upstream frontend {
        include /etc/nginx/conf.d/upstream_frontend.conf;
    }
    
    server {
        listen 80;
    
        location /api/ {
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    
        location / {
            proxy_pass http://frontend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    }
    
    ```
    

## ğŸ§ª ìë™í™” í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

| í•­ëª© | ë°©ë²• |
| --- | --- |
| ë°±ì—”ë“œ JUnit | `./gradlew test` |
| í”„ë¡ íŠ¸ì—”ë“œ Unit Test | `npm run test` |
| ì»¨í…Œì´ë„ˆ í—¬ìŠ¤ì²´í¬ | `docker inspect` ìƒíƒœ í™•ì¸ |
| Nginx ë¼ìš°íŒ… í™•ì¸ | `curl -v localhost/api/` ë˜ëŠ” `/` ë¡œ í™•ì¸ |

## ğŸ“Œ ë§ˆë¬´ë¦¬ ìš”ì•½

- `deploy_backend.sh`, `deploy_frontend.sh` ê°ê° ë…ë¦½ ì‹¤í–‰
- í…ŒìŠ¤íŠ¸ â†’ ë¹Œë“œ â†’ ìƒˆ í¬íŠ¸ ì»¨í…Œì´ë„ˆ â†’ í—¬ìŠ¤ì²´í¬ â†’ Nginx ìŠ¤ìœ„ì¹­ â†’ ì´ì „ ì¢…ë£Œ
- í¬íŠ¸ë§Œ ë²ˆê°ˆì•„ê°€ë©° ì‚¬ìš© â†’ ë¬´ì¤‘ë‹¨ ë³´ì¥