# ğŸ“˜ Today I Learned - JPA ì´ìŠˆ ì •ë¦¬ (2025-04-22)

## ğŸ§© N+1 ë¬¸ì œ
**ë¬¸ì œ ì„¤ëª…:**  
ì—°ê´€ ì—”í‹°í‹°ê°€ LAZY ë¡œë”©ì¼ ê²½ìš° ë£¨í”„ë¥¼ ëŒë©° Në²ˆì˜ ì¿¼ë¦¬ê°€ ì¶”ê°€ë¡œ ë°œìƒí•˜ëŠ” ë¬¸ì œ

```java
List<Member> members = memberRepository.findAll();
for (Member m : members) {
    System.out.println(m.getTeam().getName()); // team ì¡°íšŒ ì¿¼ë¦¬ Në²ˆ ë°œìƒ
}
```

**í•´ê²° ë°©ë²•:**  
`fetch join` ë˜ëŠ” `@EntityGraph`, `@BatchSize` ì„¤ì •

```java
@Query("SELECT m FROM Member m JOIN FETCH m.team")
List<Member> findAllWithTeam();
```

ë˜ëŠ” QueryDSL ì‚¬ìš© ì‹œ:
```java
queryFactory
    .selectFrom(member)
    .join(member.team, team).fetchJoin()
    .fetch();
```

---

## ğŸ”„ LazyInitializationException
**ë¬¸ì œ ì„¤ëª…:**  
íŠ¸ëœì­ì…˜ì´ ëë‚œ í›„ LAZY í•„ë“œ ì ‘ê·¼ ì‹œ ì˜ˆì™¸ ë°œìƒ

```java
Member m = memberRepository.findById(id).get();
em.close(); 
m.getTeam().getName(); // LazyInitializationException ë°œìƒ
```

**í•´ê²° ë°©ë²•:**  
íŠ¸ëœì­ì…˜ ë‚´ë¶€ì—ì„œ ì—°ê´€ í•„ë“œ ì¡°íšŒ or DTO ë§¤í•‘

```java
@Transactional
public MemberDto getMember(Long id) {
    Member member = memberRepository.findByIdWithTeam(id);
    return new MemberDto(member.getName(), member.getTeam().getName());
}
```

---

## ğŸ–Šï¸ Dirty Checking ì‹¤ìˆ˜
**ë¬¸ì œ ì„¤ëª…:**  
ì—”í‹°í‹° ê°’ì„ ë°”ê¾¸ê¸°ë§Œ í•´ë„ íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì‹œ DB ë°˜ì˜ë¨ (save ë¶ˆí•„ìš”)

```java
@Transactional
public void updateMember(Long id) {
    Member member = memberRepository.findById(id).get();
    member.setName("newName"); // save ì—†ì–´ë„ ì—…ë°ì´íŠ¸ ë¨
}
```

**í•´ê²° ë°©ë²•:**  
ëª…ì‹œì ì¸ ë³€ê²½ ë©”ì„œë“œ ì‚¬ìš©

```java
public void changeName(String newName) {
    this.name = newName;
}
```

---

## ğŸš¨ Cascade ëˆ„ë½
**ë¬¸ì œ ì„¤ëª…:**  
ì—°ê´€ ì—”í‹°í‹° ì €ì¥ ì‹œ Cascade ì„¤ì •ì´ ì—†ìœ¼ë©´ ì—°ê´€ ê°ì²´ ì €ì¥ ì•ˆ ë¨

```java
order.addItem(new OrderItem());
orderRepository.save(order); // OrderItem ì €ì¥ ì•ˆ ë¨
```

**í•´ê²° ë°©ë²•:**
```java
@OneToMany(mappedBy = "order", cascade = CascadeType.ALL)
private List<OrderItem> items = new ArrayList<>();
```

```java
public void addItem(OrderItem item) {
    items.add(item);
    item.setOrder(this);
}
```

---

## âš ï¸ equals & hashCode ì˜¤ìš©
**ë¬¸ì œ ì„¤ëª…:**  
ì—”í‹°í‹° ì‹ë³„ì ì—†ì´ equals/hashCode êµ¬í˜„ ì‹œ Set ì¤‘ë³µ ì‚½ì… ê°€ëŠ¥

```java
@EqualsAndHashCode(onlyExplicitlyIncluded = true)
public class Member {
    @EqualsAndHashCode.Include
    private Long id;
}
```

---

## ğŸ” ì—°ê´€ê´€ê³„ ì„¤ì • ëˆ„ë½
**ë¬¸ì œ ì„¤ëª…:**  
ì–‘ë°©í–¥ ì—°ê´€ê´€ê³„ ì„¤ì • ì‹œ í•œ ìª½ë§Œ ì„¤ì •í•˜ë©´ ì¼ê´€ì„± ê¹¨ì§

```java
public void addChild(Child child) {
    children.add(child);
    child.setParent(this);
}
```

---

## ğŸ§¼ ë²Œí¬ ì—°ì‚° í›„ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ë¶ˆì¼ì¹˜
**ë¬¸ì œ ì„¤ëª…:**  
ë²Œí¬ update/delete í›„ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ë°˜ì˜ ì•ˆ ë¨

```java
@Modifying
@Query("UPDATE Member m SET m.age = 0")
void bulkUpdate();

bulkUpdate();
em.clear(); // ê¼­ clear í•„ìš”
```

---

## ğŸ”ƒ íŠ¸ëœì­ì…˜ ëˆ„ë½
**ë¬¸ì œ ì„¤ëª…:**  
@Transactional ëˆ„ë½ ì‹œ Dirty Checking ë°˜ì˜ ì•ˆ ë¨

```java
@Transactional
public void update() {
    Member m = memberRepository.findById(id).get();
    m.setName("new");
}
```

---

## ğŸ§© mappedBy ì˜¤ìš©
**ë¬¸ì œ ì„¤ëª…:**  
mappedByì—ëŠ” í•„ë“œëª…ì´ ì™€ì•¼ í•¨

```java
@OneToMany(mappedBy = "team") // teamì€ Member í´ë˜ìŠ¤ì˜ í•„ë“œëª…
private List<Member> members;
```

---

## ğŸ”„ ìˆœí™˜ ì°¸ì¡° ë°œìƒ
**ë¬¸ì œ ì„¤ëª…:**  
Entityë¥¼ ì§ì ‘ JSONìœ¼ë¡œ ë°˜í™˜í•˜ë©´ ìˆœí™˜ ì°¸ì¡° ë°œìƒ

**í•´ê²° ë°©ë²•:** DTOë¡œ ë³€í™˜í•´ì„œ ë°˜í™˜

```java
public class MemberDto {
    private String name;
    private String teamName;

    public MemberDto(Member m) {
        this.name = m.getName();
        this.teamName = m.getTeam().getName();
    }
}
```

---

## âœ… ê¸°íƒ€ ì¶”ì²œ ì„¤ì •
- ì»¬ë ‰ì…˜ ì´ˆê¸°í™”ëŠ” í•­ìƒ `new ArrayList<>()`ë¡œ
- ì§€ì—° ë¡œë”© ë¬¸ì œ ë°©ì§€ë¥¼ ìœ„í•´ DTO projection ì ê·¹ ì‚¬ìš©
- `orphanRemoval = true` ì£¼ì˜
- ë²Œí¬ ì—°ì‚° í›„ `flush()` + `clear()` í˜¸ì¶œ í•„ìˆ˜
- QueryDSL, Projections, fetchJoin ì ê·¹ í™œìš©

---

ğŸ§  **ì˜¤ëŠ˜ì˜ ì¸ì‚¬ì´íŠ¸**  
JPAëŠ” êµ‰ì¥íˆ í¸ë¦¬í•˜ì§€ë§Œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸, ì—°ê´€ê´€ê³„, Lazy ë¡œë”© ë“±ì˜ ê°œë…ì„ ì •í™•íˆ ì´í•´í•˜ì§€ ì•Šìœ¼ë©´ ì˜ˆê¸°ì¹˜ ì•Šì€ ë²„ê·¸ì™€ ì„±ëŠ¥ ì´ìŠˆê°€ ë°œìƒí•  ìˆ˜ ìˆìŒ.  
**ì—”í‹°í‹°ì™€ íŠ¸ëœì­ì…˜ì˜ ìƒëª…ì£¼ê¸°**ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ì„¤ê³„í•˜ê³ , **DTO ë¶„ë¦¬ì™€ fetch ì „ëµ ì¡°ì •**ì´ í•µì‹¬!

