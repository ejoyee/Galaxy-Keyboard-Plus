# 25-04-17

ë°°ìš´ê²ƒ: LangChain, RAG, ì‹¤ìŠµ

## RAG LLM Langchain - Typescript ver

![image](/uploads/83be2a0b7a68990ef314c7b2811d0ceb/image.png)

![image_1](/uploads/95857902a39942b5ca9fcbc373beff31/image_1.png)

### í”„ë¡œì íŠ¸ ìƒì„± ë° Node.js ì´ˆê¸°í™”

```bash
mkdir rag-pdf-poc && cd rag-pdf-poc

npm init -y
```

- ê²°ê³¼

![image_2](/uploads/0405e2ed775ed841f71a1cc99dfbfa8e/image_2.png)

### í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜

```bash
npm add langchain openai @langchain/community dotenv
npm add -D typescript ts-node @types/node
```

- ê²°ê³¼

![image_3](/uploads/19e933c1e423429820f4d371ea2585cf/image_3.png)

### Typescript í™˜ê²½ êµ¬ì„±

```bash
npx tsc --init
```

- ìƒì„±ëœ `tsconfig.json`ì—ì„œ `"moduleResolution": "node"` ë¡œ ë°”ê¿ˆ (ì£¼ì„ í’€ì—ˆìŒ)

### .env íŒŒì¼ ìƒì„± (OpenAI API Key)

```bash
OPENAI_API_KEY=sk-xxxxx...
```

### index.ts ì½”ë“œ ì „ì²´ (PDFLoader)

```tsx
export {};

import * as dotenv from "dotenv";

import { ChatOpenAI } from "@langchain/openai";
import { ConversationalRetrievalQAChain } from "langchain/chains";
import { MemoryVectorStore } from "langchain/vectorstores/memory";
import { OpenAIEmbeddings } from "@langchain/openai";
import { PDFLoader } from "@langchain/community/document_loaders/fs/pdf";
import { RecursiveCharacterTextSplitter } from "langchain/text_splitter";
import { v4 as uuidv4 } from "uuid";

dotenv.config();

// Step 1: PDF ë¡œë”©
const loader = new PDFLoader("ì²­ë…„ì¸µì˜ ë‹¤ì–‘í•œ ìš°ìš¸ ë³€í™”ìœ í˜• í™•ì¸.pdf", {
  splitPages: false, // â†’ í•œ ë¬¸ì„œë¡œ ë¶ˆëŸ¬ì˜¤ê¸°
});
const rawDocs = await loader.load();

// Step 2: ë¬¸ì„œ ìª¼ê°œê¸°
const splitter = new RecursiveCharacterTextSplitter({
  chunkSize: 1000,
  chunkOverlap: 200,
});
const docs = await splitter.splitDocuments(rawDocs);

// Step 3: ì„ë² ë”© + ë²¡í„° ì €ì¥ì†Œ
const embeddings = new OpenAIEmbeddings();
const vectorStore = await MemoryVectorStore.fromDocuments(docs, embeddings);

// Step 4: ê²€ìƒ‰ê¸° ìƒì„±
const retriever = vectorStore.asRetriever();

// Step 5: LLM ì²´ì¸ êµ¬ì„±
const llm = new ChatOpenAI({
  modelName: "gpt-3.5-turbo",
  temperature: 0,
});
const chain = ConversationalRetrievalQAChain.fromLLM(llm, retriever);

// Step 6: ì‚¬ìš©ì ì§ˆë¬¸
const question = "ì´ ë¬¸ì„œì—ì„œ ë§í•˜ëŠ” ê±´ê°•í–‰ë™ ìš”ì¸ì´ ë­ê°€ ìˆì–´?";
const result = await chain.call({
  question,
  chat_history: [],
});

console.log("ğŸ“Œ ì§ˆë¬¸:", question);
console.log("ğŸ§  ë‹µë³€:", result.text);
```

### ì‹¤í–‰ ëª…ë ¹ì–´

```bash
 npx tsx index.ts
```

![image_4](/uploads/3f6fd05e85802d33451cde7d90048fb7/image_4.png)

### ì´ë¥¼ ìœ„í•œ ë¬¸ì œ í•´ê²° ê³¼ì •

<aside>
ğŸš¨

**`Cannot find module 'langchain/document_loaders/fs/pdfâ€™`**

</aside>

- ì˜¤ë¥˜ ì›ì¸
  - ì˜ˆì „ ë²„ì „ LangChainì˜ PDF Loader ìœ„ì¹˜ = `langchain/document_loaders/fs/pdf`
  - í˜„ì¬ ìœ„ì¹˜ (ì»¤ë®¤ë‹ˆí‹° íŒ¨í‚¤ì§€ë¡œ ë¶„ë¦¬ë˜ì–´) = `@langchain/community`
- í•´ê²° ë°©ë²•
  ```bash
  import { PDFLoader } from "@langchain/community/document_loaders/fs/pdf"
  ```

<aside>
ğŸš¨

`Module '@langchain/community/vectorstores/faiss' has no exported member 'FAISSâ€™`

</aside>

- ì˜¤ë¥˜ ì›ì¸
  - LangChainì˜ **FAISS**ë„ `@langchain/community`ë¡œ ì´ì „
  - ì´ë¦„ë„ `FaissStore` ë¡œ ë°”ë€œ
- í•´ê²° ë°©ë²•

  ```tsx
  import { FaissStore } from "@langchain/community/vectorstores/faiss";

  const vectorStore = await FaissStore.fromDocuments(docs, embeddings);
  ```

<aside>
ğŸš¨

**`Top-level await not allowed`**

</aside>

- TypeScriptì—ì„œ `await`ë¥¼ ìµœìƒë‹¨ì—ì„œ ì‚¬ìš©í•˜ë ¤ë©´ `tsconfig.json`ì— **íŠ¹ì • ì„¤ì •**ì´ í•„ìš”
  ```tsx
  {
    "compilerOptions": {
      "target": "ES2020",            // ê¸°ì¡´: "es2016" â†’ ìˆ˜ì •!
      "module": "ES2022",            // ê¸°ì¡´: "commonjs" â†’ ìˆ˜ì •!
      "moduleResolution": "node",
      "esModuleInterop": true,
      "forceConsistentCasingInFileNames": true,
      "strict": true,
      "skipLibCheck": true
    }
  }
  ```
  | í•­ëª©                         | ì´ìœ                                 |
  | ---------------------------- | ----------------------------------- |
  | `"target": "ES2020"`         | `async/await`ì™€ ìµœì‹  JS ê¸°ëŠ¥ì„ ì§€ì› |
  | `"module": "ES2022"`         | Top-level await ì‚¬ìš©ì„ ìœ„í•´ í•„ìˆ˜    |
  | `"moduleResolution": "node"` | ëª¨ë“ˆ íƒìƒ‰ ë°©ì‹ì„ Node.js ìŠ¤íƒ€ì¼ë¡œ   |
  | `"esModuleInterop": true`    | CommonJS ë¼ì´ë¸ŒëŸ¬ë¦¬ import í˜¸í™˜ì„±   |

<aside>
ğŸš¨

**`Unknown command: "ts-nodeâ€`**

</aside>

- í•´ê²° ë°©ë²•

  ```bash
  npm install -g ts-node typescript
  ```

- ì´ì€ ë¬¸ì œ

  ```bash
  $ npx ts-node index.ts
  TypeError: Unknown file extension ".ts" for C:\ejoyee\workspace\rag-pdf-poc\index.ts
      at Object.getFileProtocolModuleFormat [as file:] (node:internal/modules/esm/get_format:219:9)
      at defaultGetFormat (node:internal/modules/esm/get_format:245:36)
      at defaultLoad (node:internal/modules/esm/load:120:22)
      at async ModuleLoader.loadAndTranslate (node:internal/modules/esm/loader:483:32)
      at async ModuleJob._link (node:internal/modules/esm/module_job:115:19) {
    code: 'ERR_UNKNOWN_FILE_EXTENSION'
  }
  ```

  - í•´ê²° ë°©ë²• 1 : **ts-node ì‹¤í–‰ ì‹œ `--loader` ì˜µì…˜ ì¶”ê°€ (ê°€ì¥ ì¶”ì²œ)**
    ```bash
    npx ts-node --loader ts-node/esm index.ts
    ```
    - `tsconfig.json`ì´ `module: "ES2022"` ë˜ëŠ” `"nodenext"`ì¼ ë•Œ í•„ìˆ˜
    - ì‹¤íŒ¨
  - í•´ê²° ë°©ë²• 2 : **tsx ì‚¬ìš© (ê°„ë‹¨í•˜ê³  ìµœì‹  ë°©ì‹)**

    - `tsx`ëŠ” `.ts`, `.tsx`, ESM ë“± ëª¨ë‘ í¸í•˜ê²Œ ì‹¤í–‰í•´ì£¼ëŠ” ëŒ€ì²´ ì‹¤í–‰ê¸°

    ```bash
    npm i -D tsx

    // ì¶”í›„ ì‹¤í–‰
    npx tsx index.ts
    ```

    - ì„±ê³µ
      - í•˜ì§€ë§Œ ì¶”ê°€ë¡œ ì„¤ì •í•´ì¤˜ã…ì•¼ í•˜ëŠ” ê²ƒ
        - tsconfig.json (ì•„ê¹Œ ìˆ˜ì •í•¨)
        - package.jsonì— ì¶”ê°€
          ```tsx
          {
            "type": "module"
          }
          ```
        - index.ts ë§¨ ìœ„ì— íŒŒì¼ íƒ€ì… ëª…ì‹œ (ESM í™˜ê²½)
          ```tsx
          // index.ts ë§¨ ìœ„ì— ì¶”ê°€
          export {};
          ```

<aside>
ğŸš¨

Error: Failed to load pdf-parse. Please install it with eg.
`npm install pdf-parse`.

</aside>

- ì˜¤ë¥˜ ì›ì¸
  - LangChainì˜ `PDFLoader`ëŠ” ë‚´ë¶€ì ìœ¼ë¡œ **`pdf-parse` ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì§ì ‘ ì„¤ì¹˜ í•„ìš”**
- ë¬¸ì œ í•´ê²°
  - pdf-parse ì„¤ì¹˜
    ```bash
    npm install pdf-parse
    ```

<aside>
ğŸš¨

Error: Could not import faiss-node. Please install faiss-node as a dependency with, e.g.
`npm install -S faiss-node`.

- ì „ì²´ ë‚´ìš©

  ```bash
  $ npx tsx index.ts
  (node:18196) [DEP0040] DeprecationWarning: The punycode module is deprecated. Please use a userland alternative instead.
  (Use node --trace-deprecation ... to show where the warning was created)
  C:\ejoyee\workspace\rag-pdf-poc\node_modules\@langchain\community\dist\vectorstores\faiss.js:354
              throw new Error(Could not import faiss-node. Please install faiss-node as a dependency with, e.g. \npm install -S faiss-node\.\n\nError: ${err?.message});
                    ^

  Error: Could not import faiss-node. Please install faiss-node as a dependency with, e.g. npm install -S faiss-node.

  Error: Cannot find package 'faiss-node' imported from C:\ejoyee\workspace\rag-pdf-poc\node_modules\@langchain\community\dist\vectorstores\faiss.js
      at Function.importFaiss (C:\ejoyee\workspace\rag-pdf-poc\node_modules\@langchain\community\dist\vectorstores\faiss.js:354:19)
      at async FaissStore.addVectors (C:\ejoyee\workspace\rag-pdf-poc\node_modules\@langchain\community\dist\vectorstores\faiss.js:86:37)
      at async Function.fromDocuments (C:\ejoyee\workspace\rag-pdf-poc\node_modules\@langchain\community\dist\vectorstores\faiss.js:328:9)
      at async <anonymous> (C:\ejoyee\workspace\rag-pdf-poc\index.ts:30:21)

  Node.js v22.13.0
  ```

</aside>

- ì˜¤ë¥˜ ì›ì¸
  - LangChainì˜ RaissStoreëŠ” ë¡œì»¬ì—ì„œ FAISS ë²¡í„° ì €ì¥ì†Œë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ëŠ” ë°©ì‹
    - ë‚´ë¶€ì ìœ¼ë¡œ faiss-nodeë¼ëŠ” Native ëª¨ë“ˆ(C++) ê¸°ë°˜ íŒ¨í‚¤ì§€ í•„ìš”
- ê³ ë¯¼ ê³¼ì •
  - faiss-node
    - ì„¤ì¹˜ ë³µì¡
    - í”Œë«í¼ í˜¸í™˜ì„± ë¬¸ì œ ë§ìŒ (íŠ¹íˆ Windows)
    - Node.js ìµœì‹  ë²„ì „ì—ì„œ ì‘ë™ Xx
- ë¬¸ì œ í•´ê²°
  - ëŒ€ì²´ ì €ì¥ì†Œì¸ Chroma ì‚¬ìš©
- í•´ê²° ë°©ë²•

  1. Chroma ì„¤ì¹˜

     ```bash
     npm install chromadb
     ```

  2. ì½”ë“œ ìˆ˜ì • FaissStore â†’ Chroma

     ```bash
     import { Chroma } from "@langchain/community/vectorstores/chroma"
     import { v4 as uuidv4 } from "uuid"

     const vectorStore = await Chroma.fromDocuments(docs, embeddings, {
       collectionName: `rag-test-${uuidv4()}`, // unique name to avoid collisions
     })
     const retriever = vectorStore.asRetriever()
     ```

  - ì¶”ê°€ë¡œ `npm install uuid`

- ì´ì–´ì§„ ë¬¸ì œë“¤ â€¦
    <aside>
    ğŸš¨
    
    **`ChromaConnectionError: Failed to connect to chromadb.`**
    
    </aside>
    
    - LangChainì—ì„œ ì‚¬ìš©í•˜ëŠ” Chroma ë²¡í„° ì €ì¥ì†Œ â†’ ì„œë²„ ê¸°ë°˜ (local REST API) ë™ì‘ êµ¬ì¡°ì¸ë°
    - ì„œë²„ê°€ ì•ˆ ëŒì•„ê°€ê³  ìˆì–´ì„œ ìƒê¸´ ë¬¸ì œ
        - í•´ê²° ë°©ì•ˆ 1 : **MemoryVectorStore**ë¡œ ë°”ê¾¸ê¸° (ê°€ì¥ ê°„ë‹¨, ì„¤ì¹˜ í•„ìš” ì—†ìŒ)
            
            ```tsx
            // import ë³€ê²½
            import { MemoryVectorStore } from "langchain/vectorstores/memory"
            
            const vectorStore = await MemoryVectorStore.fromDocuments(docs, embeddings)
            const retriever = vectorStore.asRetriever()
            ```
            
        - í•´ê²° ë°©ì•ˆ 2 :  **Chroma ì„œë²„ ì§ì ‘ ì‹¤í–‰**
            
            ```bash
            docker run -d -p 8000:8000 ghcr.io/chroma-core/chroma:latest
            ```
            
            - ë„ì»¤ë¡œ ì‹¤í–‰í•˜ëŠ” ê²ƒ

<aside>
ğŸ’¡

ìì˜í•œ ì´ìŠˆ

- API í‚¤ë„, í† í°ë„ ì²˜ìŒ â€¦ ë°œê¸‰
</aside>

## RAG LLM Langchain - python ver

https://www.youtube.com/watch?v=zybyszetEcE&t=4s

[ğŸ“˜ PDF ë¬¸ì„œ ê¸°ë°˜ RAG QA ì‹œìŠ¤í…œ êµ¬ì¶• (LangChain + OpenAI)](https://www.notion.so/PDF-RAG-QA-LangChain-OpenAI-1d821a4e211c814e8824e010f8589f9a?pvs=21)

- ì†¡í—Œ ë‹˜ ì •ë¦¬ë³¸ê³¼ ë™ì¼ ê³¼ì • ê±°ì¹¨

### ê°•ì˜ ì†ì—ì„œ ì•Œê²Œ ëœ ë‚´ìš©

<aside>
ğŸ’¡

**ìœ ì‚¬ì„± ê²€ì‚¬**

- ì½”ì‚¬ì¸ ìœ ì‚¬ì„±
- Max Marginal Relevance (MMR)
</aside>

<aside>
ğŸ’¡

**ì •ë³´ê²€ìƒ‰ì‹œìŠ¤í…œì—ì„œ ì‚¬ìš©í•˜ëŠ”**

- Sparse Retriever
  - í‚¤ì›Œë“œ ë²¡í„°
  - ì „ë¬¸ìš©ì–´ê°€ ê¼­ í¬í•¨ë˜ì–´ì•¼ í•˜ëŠ” ìƒí™©ì²˜ëŸ¼ í‚¤ì›Œë“œ ì¤‘ì‹¬ìœ¼ë¡œ
- Dense Retriever - ì˜ë¯¸ ê²€ìƒ‰ - ì—°ì†ì  ë²¡í„° ê³µê°ì—ì„œ ì˜ë¯¸ í‘œí˜„
</aside>
