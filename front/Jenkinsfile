pipeline {
  agent any

  environment {
    FIREBASE_TOKEN   = credentials('FIREBASE_TOKEN')
    FIREBASE_APP_ID  = '1:189536895445:android:783ed885fd7c4b896bfd5c'
    KEYSTORE_PASSWORD = credentials('KEYSTORE_PASSWORD')
    KEY_ALIAS         = credentials('KEY_ALIAS')
    KEY_PASSWORD      = credentials('KEY_PASSWORD')
    WORK_DIR = "${WORKSPACE}/workspace"
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Checkout & Init') {
      steps {
        sh 'chmod -R 777 .'
      }
    }

    stage('Prepare Project') {
      steps {
        sh '''
          echo ğŸ“¦ ì‘ì—… ë””ë ‰í† ë¦¬ ì¤€ë¹„ ë° ì••ì¶•
          rm -rf ${WORK_DIR} ${WORK_DIR}.tar.gz
          mkdir -p ${WORK_DIR}
          cp -a front/frontend/. ${WORK_DIR}/
          chmod -R 777 ${WORK_DIR}
          [ -f ${WORK_DIR}/package.json ]
          echo ğŸ“„ package.json í™•ì¸ ì™„ë£Œ
          tar -czf ${WORK_DIR}.tar.gz -C ${WORK_DIR} .
          echo ğŸ“Š ì••ì¶• íŒŒì¼ ìƒíƒœ:
          ls -lh ${WORK_DIR}.tar.gz
          stat ${WORK_DIR}.tar.gz
        '''
      }
    }

    stage('Prepare Secrets') {
      steps {
        withCredentials([
          file(credentialsId: 'android-release-keystore', variable: 'KEYSTORE_FILE'),
          file(credentialsId: 'GOOGLE_SERVICES_JSON', variable: 'GOOGLE_SERVICES_JSON'),
          file(credentialsId: 'FIREBASE_SERVICE_ACCOUNT', variable: 'FIREBASE_SERVICE_ACCOUNT')
        ]) {
          sh '''
            echo ğŸ” ì‹œí¬ë¦¿ íŒŒì¼ ë³µì‚¬
            mkdir -p ${WORK_DIR}/android/app/keystore
            cp ${KEYSTORE_FILE} ${WORK_DIR}/android/app/keystore/release.keystore
            cp ${GOOGLE_SERVICES_JSON} ${WORK_DIR}/android/app/google-services.json
            cp ${FIREBASE_SERVICE_ACCOUNT} ${WORK_DIR}/android/firebase_service_account.json
            chmod -R 777 ${WORK_DIR}/android
          '''
        }
      }
    }

    stage('Build and Deploy') {
      steps {
        sh '''
          echo ğŸš€ Docker ë¹Œë“œ ë° ë°°í¬ ì‹œì‘
          echo ğŸ³ ì»¨í…Œì´ë„ˆ ìƒì„± ë° íŒŒì¼ ë³µì‚¬
          CID=$(docker create cimg/android:2023.08)
          docker cp ${WORK_DIR}.tar.gz $CID:/tmp/project.tar.gz
          docker start $CID
          docker exec $CID bash -c "
            set -e
            echo 'ğŸ“‚ ì••ì¶• í•´ì œ'
            mkdir -p /tmp/project
            tar -xzf /tmp/project.tar.gz -C /tmp/project
            cd /tmp/project

            echo 'ğŸ“¦ npm install'
            npm install

            echo 'ğŸ› ï¸ Android ë¹Œë“œ'
            cd android
            chmod +x ./gradlew
            echo 'sdk.dir=$ANDROID_HOME' > local.properties
            echo 'KEYSTORE_PASSWORD=${KEYSTORE_PASSWORD}' >> gradle.properties
            echo 'KEY_ALIAS=${KEY_ALIAS}' >> gradle.properties
            echo 'KEY_PASSWORD=${KEY_PASSWORD}' >> gradle.properties
            ./gradlew clean assembleRelease --stacktrace

            echo 'ğŸ“¦ ë¹Œë“œ ì‚°ì¶œë¬¼ ë³µì‚¬'
            mkdir -p /tmp/output
            find . -name '*.apk' -o -name '*.aab' -exec cp {} /tmp/output/ \\;

            echo 'ğŸ”¥ Firebase ë°°í¬'
            npm install -g firebase-tools
            firebase appdistribution:distribute /tmp/output/*.apk \\
              --app '$FIREBASE_APP_ID' \\
              --token '$FIREBASE_TOKEN' \\
              --groups 'testers' \\
              --release-notes 'CI ìë™ ë°°í¬ #${BUILD_ID}'
            echo 'âœ… ë°°í¬ ì™„ë£Œ'
          "
        '''
      }
    }
  }

  post {
    failure {
      sh '''
        echo âŒ ë¹Œë“œ ì‹¤íŒ¨ ë””ë²„ê¹… ì €ì¥
        mkdir -p debug-archive
        echo ## package.json ë‚´ìš©
        cat ${WORK_DIR}/package.json || echo ì—†ìŒ
        echo "\\n## .tar.gz ìƒíƒœ"
        stat ${WORK_DIR}.tar.gz || echo stat ì‹¤íŒ¨
      '''
      archiveArtifacts artifacts: 'debug-archive/**', allowEmptyArchive: true
    }
  }
}
