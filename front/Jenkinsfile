pipeline {
  agent any

  environment {
    // Android SDK ì„¤ì •
    ANDROID_SDK_ROOT = '/opt/android-sdk'
    ANDROID_HOME     = '/opt/android-sdk'
    // Fastlane Firebase App Distribution í† í°
    FIREBASE_TOKEN   = credentials('FIREBASE_TOKEN')
    // Firebase ì•± ID
    FIREBASE_APP_ID  = '1:189536895445:android:783ed885fd7c4b896bfd5c'
    // í‚¤ìŠ¤í† ì–´ ê´€ë ¨ ì„¤ì •
    KEYSTORE_PASSWORD = credentials('KEYSTORE_PASSWORD')
    KEY_ALIAS        = credentials('KEY_ALIAS')
    KEY_PASSWORD     = credentials('KEY_PASSWORD')
    // ì‚¬ìš©í•  Docker ì´ë¯¸ì§€
    DOCKER_IMAGE     = 'my-android-ci:latest'
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
        
        // ë¹Œë“œ ì‹œì‘ ë¡œê·¸
        sh '''
          echo "===================================================="
          echo "ğŸš€ ë¹Œë“œ ì‹œì‘: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ” ë¹Œë“œ ID: ${BUILD_ID}"
          echo "ğŸ” Git ì»¤ë°‹: ${GIT_COMMIT}"
          echo "ğŸ” ë¸Œëœì¹˜: ${GIT_BRANCH}"
          echo "===================================================="
        '''
      }
    }

    stage('Environment Diagnostic') {
      steps {
        sh '''
          echo "===================================================="
          echo "ğŸ” Jenkins í™˜ê²½ ì§„ë‹¨"
          echo "===================================================="
          
          # ì‹œìŠ¤í…œ ì •ë³´
          echo "ğŸ“Š OS ì •ë³´:"
          uname -a
          
          # ì„¤ì¹˜ëœ ë„êµ¬ í™•ì¸
          echo "ğŸ“Š ì„¤ì¹˜ëœ ë„êµ¬ í™•ì¸:"
          which node || echo "Node.jsê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤"
          which npm || echo "npmì´ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤"
          which yarn || echo "yarnì´ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤"
          which java || echo "Javaê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤"
          which javac || echo "Java ì»´íŒŒì¼ëŸ¬ê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤"
          
          # í™˜ê²½ ë³€ìˆ˜ í™•ì¸
          echo "ğŸ“Š í™˜ê²½ ë³€ìˆ˜:"
          echo "PATH: $PATH"
          echo "ANDROID_HOME: $ANDROID_HOME"
          echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
          
          # Android SDK í™•ì¸
          echo "ğŸ“Š Android SDK í™•ì¸:"
          [ -d "$ANDROID_SDK_ROOT" ] && ls -la $ANDROID_SDK_ROOT || echo "Android SDK ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤"
          
          # ì‘ì—… ë””ë ‰í† ë¦¬ êµ¬ì¡°
          echo "ğŸ“Š ì‘ì—… ë””ë ‰í† ë¦¬ êµ¬ì¡°:"
          ls -la
          
          # Front ë””ë ‰í† ë¦¬ êµ¬ì¡°
          echo "ğŸ“Š Front ë””ë ‰í† ë¦¬ êµ¬ì¡°:"
          ls -la front/
          
          # Frontend ë””ë ‰í† ë¦¬ êµ¬ì¡°
          echo "ğŸ“Š Frontend ë””ë ‰í† ë¦¬ êµ¬ì¡°:"
          ls -la front/frontend/
          
          # Android ë””ë ‰í† ë¦¬ êµ¬ì¡°
          echo "ğŸ“Š Android ë””ë ‰í† ë¦¬ êµ¬ì¡°:"
          ls -la front/frontend/android/
          
          echo "===================================================="
        '''
      }
    }

    stage('Docker Environment Diagnostic') {
      steps {
        sh '''
          echo "===================================================="
          echo "ğŸ” Docker í™˜ê²½ ì§„ë‹¨"
          echo "===================================================="
          
          # Docker ë²„ì „ í™•ì¸
          echo "ğŸ“Š Docker ë²„ì „:"
          docker --version
          
          # Docker ì´ë¯¸ì§€ í™•ì¸
          echo "ğŸ“Š ì‚¬ìš© ì¤‘ì¸ Docker ì´ë¯¸ì§€:"
          docker images ${DOCKER_IMAGE}
          
          # Docker ì´ë¯¸ì§€ ì •ë³´
          echo "ğŸ“Š Docker ì´ë¯¸ì§€ ìƒì„¸ ì •ë³´:"
          docker image inspect ${DOCKER_IMAGE}
          
          # Docker í™˜ê²½ í™•ì¸
          echo "ğŸ“Š Docker í™˜ê²½ í™•ì¸:"
          docker run --rm ${DOCKER_IMAGE} bash -c 'echo "OS: $(uname -a)" && echo "Node: $(node -v)" && echo "NPM: $(npm -v)" && echo "Yarn: $(yarn -v)" && echo "Java: $(java -version 2>&1)" && ls -la /workspace || echo "ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë””ë ‰í† ë¦¬ ì—†ìŒ" && ls -la / | grep workspace'
          
          echo "===================================================="
        '''
      }
    }

    stage('Docker Mount Test') {
      steps {
        sh '''
          echo "===================================================="
          echo "ğŸ” Docker ë³¼ë¥¨ ë§ˆìš´íŠ¸ í…ŒìŠ¤íŠ¸"
          echo "===================================================="
          
          # ì„ì‹œ í…ŒìŠ¤íŠ¸ ë””ë ‰í† ë¦¬ ìƒì„±
          TEST_DIR=$(pwd)/test_mount
          mkdir -p ${TEST_DIR}
          echo "í…ŒìŠ¤íŠ¸ íŒŒì¼ì…ë‹ˆë‹¤" > ${TEST_DIR}/test.txt
          
          # ê¸°ë³¸ ë³¼ë¥¨ ë§ˆìš´íŠ¸ í…ŒìŠ¤íŠ¸
          echo "ğŸ“Š ê¸°ë³¸ ë³¼ë¥¨ ë§ˆìš´íŠ¸ í…ŒìŠ¤íŠ¸:"
          docker run --rm -v ${TEST_DIR}:/test ${DOCKER_IMAGE} bash -c 'ls -la /test && cat /test/test.txt'
          
          # ë””ë ‰í† ë¦¬ ì¡´ì¬ í…ŒìŠ¤íŠ¸
          echo "ğŸ“Š Docker ë‚´ë¶€ ë””ë ‰í† ë¦¬ í™•ì¸:"
          docker run --rm ${DOCKER_IMAGE} bash -c 'ls -la / && ls -la /workspace || echo "ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë””ë ‰í† ë¦¬ ì—†ìŒ"'
          
          # ë‚´ë¶€ì ìœ¼ë¡œ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë””ë ‰í† ë¦¬ì— ë§ˆìš´íŠ¸ í…ŒìŠ¤íŠ¸
          echo "ğŸ“Š ê¸°ì¡´ ë””ë ‰í† ë¦¬ ë§ˆìš´íŠ¸ í…ŒìŠ¤íŠ¸:"
          docker run --rm -v ${TEST_DIR}:/workspace ${DOCKER_IMAGE} bash -c 'ls -la /workspace && cat /workspace/test.txt || echo "íŒŒì¼ ì ‘ê·¼ ì‹¤íŒ¨"'
          
          # í•˜ìœ„ ë””ë ‰í† ë¦¬ ë§ˆìš´íŠ¸ í…ŒìŠ¤íŠ¸
          echo "ğŸ“Š í•˜ìœ„ ë””ë ‰í† ë¦¬ ë§ˆìš´íŠ¸ í…ŒìŠ¤íŠ¸:"
          docker run --rm -v $(pwd)/front/frontend:/workspace/frontend ${DOCKER_IMAGE} bash -c 'ls -la /workspace && ls -la /workspace/frontend || echo "í”„ë¡ íŠ¸ì—”ë“œ ë””ë ‰í† ë¦¬ ì—†ìŒ"'
          
          # ì—¬ëŸ¬ ë””ë ‰í† ë¦¬ ë§ˆìš´íŠ¸ í…ŒìŠ¤íŠ¸
          echo "ğŸ“Š ì—¬ëŸ¬ ë””ë ‰í† ë¦¬ ë§ˆìš´íŠ¸ í…ŒìŠ¤íŠ¸:"
          docker run --rm \
            -v $(pwd)/front/frontend:/project/frontend \
            -v $(pwd)/front/frontend/android:/project/android \
            ${DOCKER_IMAGE} \
            bash -c 'ls -la /project && ls -la /project/frontend && ls -la /project/android'
          
          # ì •ë¦¬
          rm -rf ${TEST_DIR}
          
          echo "===================================================="
        '''
      }
    }

    stage('Docker Build Test') {
      steps {
        sh '''
          echo "===================================================="
          echo "ğŸ” Docker ë¹Œë“œ í…ŒìŠ¤íŠ¸"
          echo "===================================================="
          
          # ì„ì‹œ ì‘ì—… ë””ë ‰í† ë¦¬ ìƒì„±
          TEMP_DIR=$(pwd)/temp_docker_test
          mkdir -p ${TEMP_DIR}
          cp -r front/frontend/* ${TEMP_DIR}/
          
          # Docker ì»¨í…Œì´ë„ˆë¡œ ë¹Œë“œ í™˜ê²½ í™•ì¸
          echo "ğŸ“Š Docker ë¹Œë“œ í™˜ê²½ í™•ì¸:"
          docker run --rm \
            -v ${TEMP_DIR}:/project \
            -w /project \
            ${DOCKER_IMAGE} \
            bash -c '
              echo "í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
              echo "ë””ë ‰í† ë¦¬ ë‚´ìš©:"
              ls -la
              echo "Android ë””ë ‰í† ë¦¬:"
              ls -la android || echo "Android ë””ë ‰í† ë¦¬ ì—†ìŒ"
              echo "Node ëª¨ë“ˆ:"
              ls -la node_modules || echo "node_modules ë””ë ‰í† ë¦¬ ì—†ìŒ"
              echo "ì„¤ì¹˜ëœ ë„êµ¬:"
              echo "Node: $(node -v)"
              echo "NPM: $(npm -v)"
              echo "Yarn: $(yarn -v)"
              echo "Java: $(java -version 2>&1 | head -1)"
            '
          
          # ì •ë¦¬
          rm -rf ${TEMP_DIR}
          
          echo "===================================================="
        '''
      }
    }
  }

  post {
    always {
      sh '''
        echo "===================================================="
        echo "ğŸ“Š ì§„ë‹¨ ê²°ê³¼ ìš”ì•½"
        echo "===================================================="
        
        # ì§„ë‹¨ ê²°ê³¼ íŒŒì¼ ìƒì„±
        echo "# í™˜ê²½ ì§„ë‹¨ ê²°ê³¼" > diagnostic-results.md
        echo "" >> diagnostic-results.md
        
        echo "## Jenkins í™˜ê²½" >> diagnostic-results.md
        echo "- OS: $(uname -a)" >> diagnostic-results.md
        echo "- Node.js: $(which node 2>/dev/null || echo 'ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ')" >> diagnostic-results.md
        echo "- Java: $(which java 2>/dev/null || echo 'ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ')" >> diagnostic-results.md
        echo "- Android SDK: $([ -d "$ANDROID_SDK_ROOT" ] && echo 'ì¡´ì¬í•¨' || echo 'ì¡´ì¬í•˜ì§€ ì•ŠìŒ')" >> diagnostic-results.md
        echo "" >> diagnostic-results.md
        
        echo "## Docker í™˜ê²½" >> diagnostic-results.md
        echo "- ì´ë¯¸ì§€: ${DOCKER_IMAGE}" >> diagnostic-results.md
        echo "- ë‚´ë¶€ ì›Œí¬ìŠ¤í˜ì´ìŠ¤: $(docker run --rm ${DOCKER_IMAGE} bash -c '[ -d /workspace ] && echo "ì¡´ì¬í•¨" || echo "ì¡´ì¬í•˜ì§€ ì•ŠìŒ"')" >> diagnostic-results.md
        echo "" >> diagnostic-results.md
        
        echo "## ë¹Œë“œ ì œì•ˆ" >> diagnostic-results.md
        echo "í™˜ê²½ ì§„ë‹¨ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒ ë°©ë²• ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì—¬ ë¹Œë“œë¥¼ ì§„í–‰í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤:" >> diagnostic-results.md
        echo "" >> diagnostic-results.md
        echo "1. **Docker ì»¨í…Œì´ë„ˆ ë‚´ ì˜ì¡´ì„± ì„¤ì¹˜ ë° ë¹Œë“œ**: ëª¨ë“  ë¹Œë“œ ê³¼ì •ì„ Docker ë‚´ì—ì„œ ì§„í–‰" >> diagnostic-results.md
        echo "2. **Jenkinsì— Node.js ì„¤ì¹˜**: Jenkins ì„œë²„ì— Node.jsë¥¼ ì„¤ì¹˜í•˜ì—¬ ì§ì ‘ ë¹Œë“œ" >> diagnostic-results.md
        echo "3. **Docker ì—†ì´ ìˆ˜ë™ ë¹Œë“œ**: Dockerë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  Jenkins ì„œë²„ì— í•„ìš”í•œ ëª¨ë“  ë„êµ¬ë¥¼ ì„¤ì¹˜í•˜ì—¬ ë¹Œë“œ" >> diagnostic-results.md
        echo "" >> diagnostic-results.md
        
        echo "ì§„ë‹¨ ê²°ê³¼ê°€ diagnostic-results.md íŒŒì¼ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."
        
        # ì§„ë‹¨ ê²°ê³¼ ì•„ì¹´ì´ë¸Œë¥¼ ìœ„í•œ ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p diagnostic-archive
        cp diagnostic-results.md diagnostic-archive/
        
        echo "===================================================="
      '''
      
      archiveArtifacts artifacts: 'diagnostic-archive/**', fingerprint: true, allowEmptyArchive: true
      
      cleanWs()
    }
  }
}