pipeline {
  agent any

  environment {
    // Android SDK ÏÑ§Ï†ï
    ANDROID_SDK_ROOT = '/opt/android-sdk'
    ANDROID_HOME     = '/opt/android-sdk'
    PATH             = "${env.PATH}:/opt/android-sdk/cmdline-tools/latest/bin:/opt/android-sdk/platform-tools"
    // Fastlane Firebase App Distribution ÌÜ†ÌÅ∞
    FIREBASE_TOKEN   = credentials('FIREBASE_TOKEN')
    // Firebase Ïï± ID
    FIREBASE_APP_ID  = '1:189536895445:android:783ed885fd7c4b896bfd5c'
    // ÎπåÎìú Í∞ïÏ†ú Ïã§Ìñâ Ïó¨Î∂Ä
    FORCE_BUILD      = 'true'
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
        
        // ÎπåÎìú ÏãúÏûë Î°úÍ∑∏
        sh '''
          echo "===================================================="
          echo "üöÄ ÎπåÎìú ÏãúÏûë: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "üîç ÎπåÎìú ID: ${BUILD_ID}"
          echo "üîç Git Ïª§Î∞ã: ${GIT_COMMIT}"
          echo "üîç Î∏åÎûúÏπò: ${GIT_BRANCH}"
          echo "===================================================="
        '''
      }
    }

    stage('Detect Frontend Changes') {
      steps {
        script {
          def diff = sh(
            script: "git diff --name-only ${env.GIT_PREVIOUS_SUCCESSFUL_COMMIT ?: 'HEAD~1'} ${env.GIT_COMMIT}",
            returnStdout: true
          ).trim()
          
          // Î≥ÄÍ≤Ω ÌååÏùº Î™©Î°ù Ï∂úÎ†•
          echo "==== Î≥ÄÍ≤ΩÎêú ÌååÏùº Î™©Î°ù ===="
          echo "${diff}"
          echo "=========================="
          
          // "front/" ÌïòÏúÑ ÌååÏùº Î≥ÄÍ≤ΩÏù¥ ÏûàÏúºÎ©¥ ÎπåÎìú (Ï°∞Í±¥ ÏôÑÌôî)
          env.BUILD_FRONTEND = diff.split('\n').any { it.startsWith('front/') } ? 'true' : 'false'
          
          // Í∞ïÏ†ú ÎπåÎìú ÏòµÏÖòÏù¥ trueÏù¥Î©¥ Î¨¥Ï°∞Í±¥ ÎπåÎìú
          if (env.FORCE_BUILD == 'true') {
            env.BUILD_FRONTEND = 'true'
            echo "üîß Í∞ïÏ†ú ÎπåÎìú ÏòµÏÖòÏù¥ ÌôúÏÑ±ÌôîÎêòÏñ¥ ÏûàÏäµÎãàÎã§."
          }
          
          echo env.BUILD_FRONTEND=='true'
               ? "‚ñ∂ Frontend Î≥ÄÍ≤Ω Í∞êÏßÄ: ÎπåÎìúÌï©ÎãàÎã§"
               : "‚ñ∂ Frontend Î≥ÄÍ≤Ω ÏóÜÏùå: Ïä§ÌÇµÌï©ÎãàÎã§"
        }
      }
    }

    stage('Project Check') {
      when { expression { env.BUILD_FRONTEND == 'true' } }
      steps {
        // ÌîÑÎ°úÏ†ùÌä∏ Íµ¨Ï°∞ Ï†êÍ≤Ä Î∞è ÎîîÎ≤ÑÍπÖ - Í∞ÑÏÜåÌôîÎêú Î≤ÑÏ†Ñ
        sh '''
          echo "===================================================="
          echo "üîç ÌîÑÎ°úÏ†ùÌä∏ Íµ¨Ï°∞ Ï†êÍ≤Ä"
          echo "===================================================="
          
          # Ï§ëÏöî ÌååÏùº ÌôïÏù∏
          echo "üìÇ front/frontend ÎîîÎ†âÌÜ†Î¶¨ Ï†êÍ≤Ä:"
          ls -la front/frontend
          
          echo "üìÇ front/frontend/android ÎîîÎ†âÌÜ†Î¶¨ Ï†êÍ≤Ä:"
          ls -la front/frontend/android
          
          # gradlew ÌååÏùº ÌôïÏù∏
          if [ ! -f "front/frontend/android/gradlew" ]; then
            echo "‚ö†Ô∏è gradlew ÌååÏùºÏù¥ ÏóÜÏäµÎãàÎã§."
          else
            echo "‚úÖ gradlew ÌååÏùº Ï°¥Ïû¨"
            chmod +x front/frontend/android/gradlew
          fi
          
          # build.gradle ÌôïÏù∏
          if [ ! -f "front/frontend/android/app/build.gradle" ]; then
            echo "‚ö†Ô∏è app/build.gradle ÌååÏùºÏù¥ ÏóÜÏäµÎãàÎã§. APK ÎπåÎìúÍ∞Ä Î∂àÍ∞ÄÎä•Ìï† Ïàò ÏûàÏäµÎãàÎã§."
          else
            echo "‚úÖ app/build.gradle ÌååÏùº Ï°¥Ïû¨"
          fi
          
          echo "===================================================="
        '''
      }
    }

    stage('Build APK Directly') {
      when { expression { env.BUILD_FRONTEND == 'true' } }
      steps {
        // ÏãúÌÅ¨Î¶ø ÌååÏùº Ï§ÄÎπÑ
        withCredentials([
          file(credentialsId: 'android-release-keystore', variable: 'KEYSTORE_FILE'),
          string(credentialsId: 'KEYSTORE_PASSWORD', variable: 'KEYSTORE_PASSWORD'),
          string(credentialsId: 'KEY_ALIAS', variable: 'KEY_ALIAS'),
          string(credentialsId: 'KEY_PASSWORD', variable: 'KEY_PASSWORD'),
          file(credentialsId: 'google-services-json', variable: 'GOOGLE_SERVICES_JSON'),
          file(credentialsId: 'firebase-service-account', variable: 'FIREBASE_SERVICE_ACCOUNT')
        ]) {
          sh '''
            echo "===================================================="
            echo "üîê ÏãúÌÅ¨Î¶ø ÌååÏùº Ï§ÄÎπÑ"
            echo "===================================================="
            
            # Keystore ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ±
            mkdir -p front/frontend/android/app/keystore
            
            # ÏãúÌÅ¨Î¶ø ÌååÏùº Î≥µÏÇ¨
            cp "$KEYSTORE_FILE" front/frontend/android/app/keystore/release.keystore
            cp "$GOOGLE_SERVICES_JSON" front/frontend/android/app/google-services.json
            cp "$FIREBASE_SERVICE_ACCOUNT" front/frontend/android/firebase_service_account.json
            
            echo "‚úÖ ÏãúÌÅ¨Î¶ø ÌååÏùº Î≥µÏÇ¨ ÏôÑÎ£å"
            echo "===================================================="
          '''
        }
        
        // DockerÎ•º ÏÇ¨Ïö©ÌïòÏßÄ ÏïäÍ≥† ÏßÅÏ†ë ÎπåÎìú ÏãúÎèÑ
        sh '''
          echo "===================================================="
          echo "üèóÔ∏è APK ÏßÅÏ†ë ÎπåÎìú ÏãúÎèÑ"
          echo "===================================================="
          
          # ÏûëÏóÖ ÎîîÎ†âÌÜ†Î¶¨Î°ú Ïù¥Îèô
          cd front/frontend/android
          
          # ÌîÑÎ°úÏ†ùÌä∏ Ï†ïÎ≥¥ Ï∂úÎ†•
          echo "üìÇ ÌòÑÏû¨ ÎîîÎ†âÌÜ†Î¶¨: $(pwd)"
          echo "üìÇ ÎîîÎ†âÌÜ†Î¶¨ ÎÇ¥Ïö©:"
          ls -la
          
          # ÏïàÎìúÎ°úÏù¥Îìú SDK ÌôòÍ≤Ω ÏÑ§Ï†ï
          export ANDROID_SDK_ROOT=/opt/android-sdk
          export ANDROID_HOME=/opt/android-sdk
          export PATH=$PATH:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools
          
          # Gradlew Ïã§Ìñâ Í∂åÌïú ÏÑ§Ï†ï
          chmod +x ./gradlew || true
          
          # Î°úÏª¨ ÎπåÎìú ÏÜçÏÑ± ÌååÏùº ÏÉùÏÑ± (Keystore Ï†ïÎ≥¥)
          cat > local.properties << EOL
sdk.dir=$ANDROID_SDK_ROOT
EOL

          # ÏßÅÏ†ë APK ÎπåÎìú ÏãúÎèÑ
          if [ -f "./gradlew" ]; then
            echo "üì± Gradle ÎπåÎìú ÏãúÎèÑ Ï§ë..."
            ./gradlew clean assembleDebug --stacktrace || echo "‚ö†Ô∏è Gradle ÎπåÎìú Ïã§Ìå®"
          else
            echo "‚ùå gradlew ÌååÏùºÏù¥ ÏóÜÏñ¥ Gradle ÎπåÎìúÎ•º Ïã§ÌñâÌï† Ïàò ÏóÜÏäµÎãàÎã§"
          fi
          
          # Í≤∞Í≥º ÌôïÏù∏
          echo "üìÇ ÎπåÎìú Í≤∞Í≥º ÌôïÏù∏:"
          find . -name "*.apk" || echo "‚ùå APK ÌååÏùºÏù¥ ÏÉùÏÑ±ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§"
          
          echo "===================================================="
        '''
        
        // React Native Ïï± ÎîîÎ†âÌÜ†Î¶¨ ÌôïÏù∏ Î∞è ÎπåÎìú ÏãúÎèÑ
        sh '''
          echo "===================================================="
          echo "üîß React Native ÎπåÎìú ÏãúÎèÑ"
          echo "===================================================="
          
          # React Native ÎîîÎ†âÌÜ†Î¶¨Î°ú Ïù¥Îèô
          cd front/frontend
          
          # ÌîÑÎ°úÏ†ùÌä∏ ÌôïÏù∏
          echo "üìÇ ÌòÑÏû¨ ÎîîÎ†âÌÜ†Î¶¨: $(pwd)"
          echo "üìÇ ÎîîÎ†âÌÜ†Î¶¨ ÎÇ¥Ïö©:"
          ls -la
          
          # Node.js ÌôòÍ≤Ω ÏÑ§Ï†ï
          NODE_VERSION=$(node -v || echo "node ÏóÜÏùå")
          NPM_VERSION=$(npm -v || echo "npm ÏóÜÏùå")
          YARN_VERSION=$(yarn -v || echo "yarn ÏóÜÏùå")
          
          echo "üîç Node.js Î≤ÑÏ†Ñ: $NODE_VERSION"
          echo "üîç npm Î≤ÑÏ†Ñ: $NPM_VERSION"
          echo "üîç yarn Î≤ÑÏ†Ñ: $YARN_VERSION"
          
          # React Native ÏùòÏ°¥ÏÑ± ÏÑ§Ïπò
          if [ -f "package.json" ]; then
            echo "üì¶ ÏùòÏ°¥ÏÑ± ÏÑ§Ïπò Ï§ë..."
            npm install || { echo "‚ö†Ô∏è npm install Ïã§Ìå®, yarn ÏãúÎèÑ..."; yarn install || echo "‚ö†Ô∏è yarn install Ïã§Ìå®"; }
            
            # Android ÎπåÎìú ÏãúÎèÑ
            if [ -f "node_modules/.bin/react-native" ]; then
              echo "üì± React Native ÎπåÎìú ÏãúÎèÑ..."
              npx react-native build-android || echo "‚ö†Ô∏è React Native ÎπåÎìú Ïã§Ìå®"
            else
              echo "‚ö†Ô∏è react-native CLIÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§"
            fi
          else
            echo "‚ùå package.json ÌååÏùºÏù¥ ÏóÜÏñ¥ React Native ÎπåÎìúÎ•º Ïã§ÌñâÌï† Ïàò ÏóÜÏäµÎãàÎã§"
          fi
          
          # APK ÌôïÏù∏
          echo "üìÇ APK ÌååÏùº ÌôïÏù∏:"
          find android -name "*.apk" || echo "‚ùå APK ÌååÏùºÏù¥ ÏÉùÏÑ±ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§"
          
          echo "===================================================="
        '''
      }
    }

    stage('Manual Firebase Upload') {
      when { expression { env.BUILD_FRONTEND == 'true' } }
      steps {
        // Debug APK ÏÉùÏÑ± Î∞è FirebaseÏóê ÏàòÎèô ÏóÖÎ°úÎìú
        withCredentials([
          string(credentialsId: 'FIREBASE_TOKEN', variable: 'FIREBASE_TOKEN')
        ]) {
          sh '''
            echo "===================================================="
            echo "üî• Firebase CLIÎ•º ÌÜµÌïú ÏàòÎèô ÏóÖÎ°úÎìú"
            echo "===================================================="
            
            # APK ÌååÏùº Ï∞æÍ∏∞
            APK_FILE=$(find front/frontend -name "*.apk" | head -1)
            
            if [ -z "$APK_FILE" ]; then
              echo "‚ùå APK ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏñ¥ Firebase ÏóÖÎ°úÎìúÎ•º Í±¥ÎÑàÎúÅÎãàÎã§"
            else
              echo "‚úÖ ÏóÖÎ°úÎìúÌï† APK ÌååÏùº: $APK_FILE"
              
              # Firebase CLI ÏÑ§Ïπò Ïó¨Î∂Ä ÌôïÏù∏
              if ! command -v firebase &> /dev/null; then
                echo "üîß Firebase CLI ÏÑ§Ïπò Ï§ë..."
                npm install -g firebase-tools || { echo "‚ö†Ô∏è Firebase CLI ÏÑ§Ïπò Ïã§Ìå®"; }
              fi
              
              # Firebase CLI Î°úÍ∑∏Ïù∏ Î∞è Î∞∞Ìè¨ ÏãúÎèÑ
              if command -v firebase &> /dev/null; then
                echo "üî• Firebase Î∞∞Ìè¨ ÏãúÎèÑ..."
                firebase appdistribution:distribute "$APK_FILE" \
                  --app "$FIREBASE_APP_ID" \
                  --token "$FIREBASE_TOKEN" \
                  --groups "testers" \
                  --release-notes "Jenkins CI ÏûêÎèô Î∞∞Ìè¨ ÎπåÎìú" || echo "‚ö†Ô∏è Firebase Î∞∞Ìè¨ Ïã§Ìå®"
              else
                echo "‚ùå Firebase CLIÍ∞Ä ÏÑ§ÏπòÎêòÏßÄ ÏïäÏïÑ Î∞∞Ìè¨Î•º Í±¥ÎÑàÎúÅÎãàÎã§"
              fi
            fi
            
            echo "===================================================="
          '''
        }
      }
    }

    stage('Archive APK') {
      when { expression { env.BUILD_FRONTEND == 'true' } }
      steps {
        sh '''
          echo "===================================================="
          echo "üì¶ APK ÏïÑÏπ¥Ïù¥Î∏å"
          echo "===================================================="
          
          # APK ÌååÏùº Ï°¥Ïû¨ ÌôïÏù∏
          APK_COUNT=$(find front/frontend -name "*.apk" 2>/dev/null | wc -l || echo "0")
          
          if [ "$APK_COUNT" -gt 0 ]; then
            echo "‚úÖ $APK_COUNT Í∞úÏùò APK ÌååÏùº Î∞úÍ≤¨:"
            find front/frontend -name "*.apk" 2>/dev/null
            
            # Î™®Îì† APK ÌååÏùºÏùÑ ÌïòÎÇòÏùò ÎîîÎ†âÌÜ†Î¶¨Î°ú Î≥µÏÇ¨
            mkdir -p apk-archive
            find front/frontend -name "*.apk" -exec cp {} apk-archive/ \\;
          else
            echo "‚ùå APK ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§"
            mkdir -p apk-archive
            echo "No APK files found" > apk-archive/build-failed.txt
          fi
          
          echo "===================================================="
        '''
        
        archiveArtifacts artifacts: 'apk-archive/**', fingerprint: true, allowEmptyArchive: true
      }
    }
  }

  post {
    success {
      sh '''
        echo "===================================================="
        echo "‚úÖ Frontend CI/CD ÏÑ±Í≥µ üéâ"
        echo "===================================================="
      '''
    }
    failure {
      sh '''
        echo "===================================================="
        echo "‚ùå Frontend CI/CD Ïã§Ìå® ‚ùó"
        echo "===================================================="
      '''
    }
    always {
      sh '''
        echo "===================================================="
        echo "üßπ ÏûëÏóÖ Í≥µÍ∞Ñ Ï†ïÎ¶¨"
        echo "===================================================="
      '''
      cleanWs()
    }
  }
}