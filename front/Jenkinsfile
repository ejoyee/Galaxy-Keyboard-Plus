pipeline {
  agent any

  environment {
    // Android SDK ì„¤ì •
    ANDROID_SDK_ROOT = '/opt/android-sdk'
    ANDROID_HOME     = '/opt/android-sdk'
    PATH             = "${env.PATH}:/opt/android-sdk/cmdline-tools/latest/bin:/opt/android-sdk/platform-tools"
    // Fastlane Firebase App Distribution í† í°
    FIREBASE_TOKEN   = credentials('FIREBASE_TOKEN')
    // Firebase ì•± ID
    FIREBASE_APP_ID  = '1:189536895445:android:783ed885fd7c4b896bfd5c'
    // ë¹Œë“œ ê°•ì œ ì‹¤í–‰ ì—¬ë¶€
    FORCE_BUILD      = 'true'
    // í‚¤ìŠ¤í† ì–´ ê´€ë ¨ ì„¤ì •
    KEYSTORE_PASSWORD = credentials('KEYSTORE_PASSWORD')
    KEY_ALIAS        = credentials('KEY_ALIAS')
    KEY_PASSWORD     = credentials('KEY_PASSWORD')
    // ì‚¬ìš©í•  Docker ì´ë¯¸ì§€
    DOCKER_IMAGE     = 'my-android-ci:latest'
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
        
        // ë¹Œë“œ ì‹œì‘ ë¡œê·¸
        sh '''
          echo "===================================================="
          echo "ğŸš€ ë¹Œë“œ ì‹œì‘: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ” ë¹Œë“œ ID: ${BUILD_ID}"
          echo "ğŸ” Git ì»¤ë°‹: ${GIT_COMMIT}"
          echo "ğŸ” ë¸Œëœì¹˜: ${GIT_BRANCH}"
          echo "===================================================="
        '''
      }
    }

    stage('Detect Frontend Changes') {
      steps {
        script {
          def diff = sh(
            script: "git diff --name-only ${env.GIT_PREVIOUS_SUCCESSFUL_COMMIT ?: 'HEAD~1'} ${env.GIT_COMMIT}",
            returnStdout: true
          ).trim()
          
          // ë³€ê²½ íŒŒì¼ ëª©ë¡ ì¶œë ¥
          echo "==== ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ===="
          echo "${diff}"
          echo "=========================="
          
          // "front/" í•˜ìœ„ íŒŒì¼ ë³€ê²½ì´ ìˆìœ¼ë©´ ë¹Œë“œ
          env.BUILD_FRONTEND = diff.split('\n').any { it.startsWith('front/') } ? 'true' : 'false'
          
          // ê°•ì œ ë¹Œë“œ ì˜µì…˜ì´ trueì´ë©´ ë¬´ì¡°ê±´ ë¹Œë“œ
          if (env.FORCE_BUILD == 'true') {
            env.BUILD_FRONTEND = 'true'
            echo "ğŸ”§ ê°•ì œ ë¹Œë“œ ì˜µì…˜ì´ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
          }
          
          echo env.BUILD_FRONTEND=='true'
               ? "â–¶ Frontend ë³€ê²½ ê°ì§€: ë¹Œë“œí•©ë‹ˆë‹¤"
               : "â–¶ Frontend ë³€ê²½ ì—†ìŒ: ìŠ¤í‚µí•©ë‹ˆë‹¤"
        }
      }
    }

    stage('Check Project Structure') {
      when { expression { env.BUILD_FRONTEND == 'true' } }
      steps {
        sh '''
          echo "===================================================="
          echo "ğŸ” í”„ë¡œì íŠ¸ êµ¬ì¡° í™•ì¸"
          echo "===================================================="
          
          # ë””ë ‰í† ë¦¬ êµ¬ì¡° í™•ì¸
          echo "ğŸ“‚ ì‘ì—… ë””ë ‰í† ë¦¬: $(pwd)"
          
          echo "ğŸ“‚ front/frontend ë””ë ‰í† ë¦¬ í™•ì¸:"
          ls -la front/frontend || { echo "âŒ front/frontend ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤"; exit 1; }
          
          # package.json í™•ì¸
          if [ -f "front/frontend/package.json" ]; then
            echo "âœ… package.json íŒŒì¼ ì¡´ì¬"
            cat front/frontend/package.json | grep "name\\|version"
          else
            echo "âŒ package.json íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. React Native í”„ë¡œì íŠ¸ê°€ ì•„ë‹ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
            exit 1
          fi
          
          echo "ğŸ“‚ front/frontend/android ë””ë ‰í† ë¦¬ í™•ì¸:"
          ls -la front/frontend/android || { echo "âŒ front/frontend/android ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤"; exit 1; }
          
          echo "ğŸ“‚ gradlew íŒŒì¼ í™•ì¸:"
          if [ -f "front/frontend/android/gradlew" ]; then
            echo "âœ… gradlew íŒŒì¼ ì¡´ì¬"
            chmod +x front/frontend/android/gradlew
          else
            echo "âŒ gradlew íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi
          
          # Android í”„ë¡œì íŠ¸ êµ¬ì¡° ìƒì„¸ í™•ì¸
          echo "ğŸ“‚ Android í”„ë¡œì íŠ¸ êµ¬ì¡°:"
          find front/frontend/android -type d | sort
          
          echo "===================================================="
        '''
      }
    }

    stage('Full Project Structure Debug') {
      when { expression { env.BUILD_FRONTEND == 'true' } }
      steps {
        sh '''
          echo "===================================================="
          echo "ğŸ” í”„ë¡œì íŠ¸ êµ¬ì¡° ì‹¬ì¸µ ë””ë²„ê¹…"
          echo "===================================================="
          
          # ê¸°ë³¸ ë””ë ‰í† ë¦¬ êµ¬ì¡° í™•ì¸
          echo "ğŸ“‚ ì‘ì—… ë””ë ‰í† ë¦¬ êµ¬ì¡°:"
          find . -maxdepth 2 -type d | sort
          
          # ì¤‘ìš” ê²½ë¡œì˜ íŒŒì¼/ë””ë ‰í† ë¦¬ ê¶Œí•œ í™•ì¸
          echo "ğŸ“‚ íŒŒì¼ ë° ë””ë ‰í† ë¦¬ ê¶Œí•œ:"
          ls -la .
          ls -la ./front
          ls -la ./front/frontend
          ls -la ./front/frontend/android
          
          # ë¹Œë“œ ê´€ë ¨ íŒŒì¼ ì¡´ì¬ í™•ì¸
          echo "ğŸ“‚ ì£¼ìš” ë¹Œë“œ íŒŒì¼ í™•ì¸:"
          find . -name "build.gradle" | sort
          find . -name "settings.gradle" | sort
          find . -name "package.json" | sort
          
          # ë””ë ‰í† ë¦¬ í¬ê¸° í™•ì¸
          echo "ğŸ“‚ ë””ë ‰í† ë¦¬ í¬ê¸°:"
          du -sh ./front
          du -sh ./front/frontend
          du -sh ./front/frontend/android
          
          # ì‚¬ìš©ì ë° ê·¸ë£¹ ì •ë³´
          echo "ğŸ‘¤ ì‚¬ìš©ì ì •ë³´:"
          id
          
          # Docker ë‚´ë¶€ í™˜ê²½ ì •ë³´ í™•ì¸
          echo "ğŸ³ Docker ë‚´ë¶€ í™˜ê²½:"
          docker run --rm ${DOCKER_IMAGE} bash -c 'echo "Docker ë‚´ë¶€ ì‚¬ìš©ì: $(id)"; echo "Docker ë‚´ë¶€ í™˜ê²½ ë³€ìˆ˜:"; env | sort'
          
          echo "===================================================="
        '''
      }
    }

    stage('Prepare Files') {
      when { expression { env.BUILD_FRONTEND == 'true' } }
      steps {
        // ì‹œí¬ë¦¿ íŒŒì¼ ì¤€ë¹„
        withCredentials([
          file(credentialsId: 'android-release-keystore', variable: 'KEYSTORE_FILE'),
          file(credentialsId: 'google-services-json', variable: 'GOOGLE_SERVICES_JSON'),
          file(credentialsId: 'firebase-service-account', variable: 'FIREBASE_SERVICE_ACCOUNT')
        ]) {
          sh '''
            echo "===================================================="
            echo "ğŸ” ì‹œí¬ë¦¿ íŒŒì¼ ì¤€ë¹„"
            echo "===================================================="
            
            # ë””ë ‰í† ë¦¬ ìƒì„± ë° í™•ì¸
            mkdir -p front/frontend/android/app/keystore
            echo "ğŸ“‚ ìƒì„±ëœ ë””ë ‰í† ë¦¬ í™•ì¸:"
            ls -la front/frontend/android/app || echo "âŒ ì•± ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤"
            ls -la front/frontend/android/app/keystore || echo "âŒ keystore ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤"
            
            # ì‹œí¬ë¦¿ íŒŒì¼ ë³µì‚¬ ì „ ì •ë³´
            echo "ğŸ” ì‹œí¬ë¦¿ íŒŒì¼ ì •ë³´:"
            file "$FIREBASE_SERVICE_ACCOUNT" || echo "âŒ Firebase ì„œë¹„ìŠ¤ ê³„ì • íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"
            file "$GOOGLE_SERVICES_JSON" || echo "âŒ Google ì„œë¹„ìŠ¤ JSON íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"
            file "$KEYSTORE_FILE" || echo "âŒ í‚¤ìŠ¤í† ì–´ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"
            
            # ì‹œí¬ë¦¿ íŒŒì¼ ë³µì‚¬ (ì˜¬ë°”ë¥¸ ê²½ë¡œì— ë§ê²Œ ì¡°ì •)
            cp -v "$FIREBASE_SERVICE_ACCOUNT" front/frontend/android/firebase_service_account.json || echo "âŒ Firebase ì„œë¹„ìŠ¤ ê³„ì • íŒŒì¼ ë³µì‚¬ ì‹¤íŒ¨"
            cp -v "$GOOGLE_SERVICES_JSON" front/frontend/android/app/google-services.json || echo "âŒ Google ì„œë¹„ìŠ¤ JSON íŒŒì¼ ë³µì‚¬ ì‹¤íŒ¨"
            cp -v "$KEYSTORE_FILE" front/frontend/android/app/keystore/release.keystore || echo "âŒ í‚¤ìŠ¤í† ì–´ íŒŒì¼ ë³µì‚¬ ì‹¤íŒ¨"
            
            # íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
            echo "ğŸ“‚ ë³µì‚¬ëœ íŒŒì¼ í™•ì¸:"
            ls -la front/frontend/android/firebase_service_account.json || echo "âŒ Firebase ì„œë¹„ìŠ¤ ê³„ì • íŒŒì¼ì´ ë³µì‚¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
            ls -la front/frontend/android/app/google-services.json || echo "âŒ Google ì„œë¹„ìŠ¤ JSON íŒŒì¼ì´ ë³µì‚¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
            ls -la front/frontend/android/app/keystore/release.keystore || echo "âŒ í‚¤ìŠ¤í† ì–´ íŒŒì¼ì´ ë³µì‚¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
            
            # íŒŒì¼ ê¶Œí•œ í™•ì¸
            echo "ğŸ“‚ íŒŒì¼ ê¶Œí•œ í™•ì¸:"
            stat front/frontend/android/firebase_service_account.json || echo "âŒ Firebase ì„œë¹„ìŠ¤ ê³„ì • íŒŒì¼ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            stat front/frontend/android/app/google-services.json || echo "âŒ Google ì„œë¹„ìŠ¤ JSON íŒŒì¼ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤" 
            stat front/frontend/android/app/keystore/release.keystore || echo "âŒ í‚¤ìŠ¤í† ì–´ íŒŒì¼ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            
            echo "âœ… ì‹œí¬ë¦¿ íŒŒì¼ ë³µì‚¬ ì™„ë£Œ"
            echo "===================================================="
          '''
        }
      }
    }

    stage('Prepare Build Directory') {
      when { expression { env.BUILD_FRONTEND == 'true' } }
      steps {
        sh '''
          echo "===================================================="
          echo "ğŸ“¦ ë¹Œë“œ ë””ë ‰í† ë¦¬ ì¤€ë¹„"
          echo "===================================================="
          
          # í˜„ì¬ ë””ë ‰í† ë¦¬ ë° í™˜ê²½ ì •ë³´ í™•ì¸
          echo "ğŸ“‚ í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬: $(pwd)"
          echo "ğŸ“‚ Jenkins ì‘ì—… ê³µê°„: $WORKSPACE"
          echo "ğŸ“‚ ì‚¬ìš©ì: $(whoami)"
          
          # ì„ì‹œ ë¹Œë“œ ë””ë ‰í† ë¦¬ ìƒì„± ë° ì´ˆê¸°í™”
          rm -rf android-build
          mkdir -p android-build
          
          # ì›ë³¸ í”„ë¡œì íŠ¸ êµ¬ì¡° í™•ì¸
          echo "ğŸ“‚ ì›ë³¸ í”„ë¡œì íŠ¸ êµ¬ì¡°:"
          find front/frontend -type d -maxdepth 3 | sort
          
          echo "ğŸ“‚ front/frontend íŒŒì¼ ëª©ë¡:"
          ls -la front/frontend
          
          echo "ğŸ“‚ front/frontend/android íŒŒì¼ ëª©ë¡:"
          ls -la front/frontend/android
          
          # ìƒì„¸í•œ ë³µì‚¬ ê³¼ì • ë¡œê¹…
          echo "ğŸ“¦ í”„ë¡œì íŠ¸ íŒŒì¼ ë³µì‚¬ ì¤‘..."
          cp -av front/frontend/. android-build/
          
          # ë³µì‚¬ í›„ ë¹Œë“œ ë””ë ‰í† ë¦¬ êµ¬ì¡° í™•ì¸
          echo "ğŸ“‚ ë¹Œë“œ ë””ë ‰í† ë¦¬ êµ¬ì¡°:"
          find android-build -type d -maxdepth 3 | sort
          
          echo "ğŸ“‚ ë¹Œë“œ ë””ë ‰í† ë¦¬ íŒŒì¼ ëª©ë¡:"
          ls -la android-build
          
          echo "ğŸ“‚ ë¹Œë“œ ë””ë ‰í† ë¦¬ android í´ë” íŒŒì¼ ëª©ë¡:"
          ls -la android-build/android || echo "âŒ android ë””ë ‰í† ë¦¬ê°€ ë³µì‚¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
          
          # android/app ë””ë ‰í† ë¦¬ ë° ì¤‘ìš” íŒŒì¼ í™•ì¸
          if [ -d "android-build/android/app" ]; then
            echo "ğŸ“‚ android/app ë””ë ‰í† ë¦¬ íŒŒì¼ ëª©ë¡:"
            ls -la android-build/android/app
            
            echo "ğŸ“‚ google-services.json í™•ì¸:"
            ls -la android-build/android/app/google-services.json || echo "âŒ google-services.json íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"
            
            echo "ğŸ“‚ keystore ë””ë ‰í† ë¦¬ í™•ì¸:"
            ls -la android-build/android/app/keystore || echo "âŒ keystore ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤"
          else
            echo "âŒ android/app ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤"
          fi
          
          # ê¶Œí•œ í™•ì¸ ë° ì„¤ì •
          echo "ğŸ“‚ ì¤‘ìš” ì‹¤í–‰ íŒŒì¼ ê¶Œí•œ í™•ì¸:"
          ls -la android-build/android/gradlew || echo "âŒ gradlew íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"
          
          echo "ğŸ”§ gradlew íŒŒì¼ì— ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬"
          chmod +x android-build/android/gradlew || echo "âŒ gradlew íŒŒì¼ì— ê¶Œí•œì„ ë¶€ì—¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          
          echo "âœ… ë¹Œë“œ ë””ë ‰í† ë¦¬ ì¤€ë¹„ ì™„ë£Œ"
          echo "===================================================="
        '''
      }
    }

    stage('Prepare Fastlane') {
      when { expression { env.BUILD_FRONTEND == 'true' } }
      steps {
        sh '''
          echo "===================================================="
          echo "ğŸš€ Fastlane í™˜ê²½ ì¤€ë¹„"
          echo "===================================================="
          
          cd android-build/android
          
          # Fastlane ë””ë ‰í† ë¦¬ í™•ì¸ ë° í•„ìš”ì‹œ ì´ˆê¸°í™”
          if [ ! -d "fastlane" ]; then
            echo "ğŸ”§ Fastlane ì´ˆê¸°í™”"
            touch Gemfile
            echo 'source "https://rubygems.org"' > Gemfile
            echo 'gem "fastlane"' >> Gemfile
            echo 'plugins_path = File.join(File.dirname(__FILE__), "fastlane", "Pluginfile")' >> Gemfile
            echo 'eval_gemfile(plugins_path) if File.exist?(plugins_path)' >> Gemfile
            
            mkdir -p fastlane
            echo 'lane :beta do' > fastlane/Fastfile
            echo '  gradle(task: "clean assembleRelease")' >> fastlane/Fastfile
            echo '  firebase_app_distribution(app: ENV["FIREBASE_APP_ID"])' >> fastlane/Fastfile
            echo 'end' >> fastlane/Fastfile
            
            touch fastlane/Pluginfile
            echo 'gem "fastlane-plugin-firebase_app_distribution"' > fastlane/Pluginfile
          else
            echo "âœ… Fastlane ë””ë ‰í† ë¦¬ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤"
            echo "ğŸ“‚ Fastlane ë””ë ‰í† ë¦¬ ë‚´ìš©:"
            ls -la fastlane
            cat fastlane/Fastfile
          fi
          
          echo "===================================================="
        '''
      }
    }

    stage('Debug Environment') {
      when { expression { env.BUILD_FRONTEND == 'true' } }
      steps {
        sh '''
          echo "===================================================="
          echo "ğŸ” í™˜ê²½ ë””ë²„ê¹…"
          echo "===================================================="
          
          # ì‹œìŠ¤í…œ ì •ë³´ ì¶œë ¥
          echo "ğŸ–¥ï¸ í˜¸ìŠ¤íŠ¸ ì •ë³´:"
          uname -a
          
          # ë””ìŠ¤í¬ ê³µê°„ í™•ì¸
          echo "ğŸ’¾ ë””ìŠ¤í¬ ê³µê°„:"
          df -h
          
          # Docker ì •ë³´
          echo "ğŸ³ Docker ë²„ì „:"
          docker --version
          
          # Docker ì´ë¯¸ì§€ ì •ë³´
          echo "ğŸ³ Docker ì´ë¯¸ì§€ ëª©ë¡:"
          docker images | grep -E "my-android-ci|android|react"
          
          # Docker ì´ë¯¸ì§€ ìƒì„¸ ì •ë³´
          echo "ğŸ³ Docker ì´ë¯¸ì§€ ìƒì„¸ ì •ë³´:"
          docker image inspect ${DOCKER_IMAGE} || echo "âŒ Docker ì´ë¯¸ì§€ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          
          # Docker ì»¨í…Œì´ë„ˆì—ì„œ Android SDK í™•ì¸
          echo "ğŸ³ Docker ì»¨í…Œì´ë„ˆ Android SDK í™•ì¸:"
          docker run --rm ${DOCKER_IMAGE} bash -c '
            echo "Android SDK ê²½ë¡œ: $ANDROID_HOME"
            echo "Android SDK ë””ë ‰í† ë¦¬ ë‚´ìš©:"
            ls -la $ANDROID_HOME || echo "Android SDK ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤"
            echo "Android SDK ë„êµ¬ í™•ì¸:"
            ls -la $ANDROID_HOME/cmdline-tools || echo "Android SDK ëª…ë ¹ì¤„ ë„êµ¬ê°€ ì—†ìŠµë‹ˆë‹¤"
            echo "Android SDK í”Œë«í¼ ë„êµ¬ í™•ì¸:"
            ls -la $ANDROID_HOME/platform-tools || echo "Android SDK í”Œë«í¼ ë„êµ¬ê°€ ì—†ìŠµë‹ˆë‹¤"
          '
          
          # Docker ì»¨í…Œì´ë„ˆì—ì„œ Node/Java ë²„ì „ í™•ì¸
          echo "ğŸ³ Docker ì»¨í…Œì´ë„ˆ ê°œë°œ í™˜ê²½ í™•ì¸:"
          docker run --rm ${DOCKER_IMAGE} bash -c '
            echo "Node ë²„ì „: $(node --version)"
            echo "NPM ë²„ì „: $(npm --version)"
            echo "Yarn ë²„ì „: $(yarn --version)"
            echo "Java ë²„ì „: $(java -version 2>&1 | head -1)"
            echo "Gradle ì„¤ì¹˜ ì—¬ë¶€: $(command -v gradle || echo "Gradle ì—†ìŒ")"
            echo "Ruby ë²„ì „: $(ruby --version || echo "Ruby ì—†ìŒ")"
            echo "Fastlane ì„¤ì¹˜ ì—¬ë¶€: $(gem list | grep fastlane || echo "Fastlane ì—†ìŒ")"
          '
          
          echo "===================================================="
        '''
      }
    }

    stage('Build with Docker') {
      when { expression { env.BUILD_FRONTEND == 'true' } }
      steps {
        sh '''
          echo "===================================================="
          echo "ğŸš€ Dockerë¥¼ í†µí•œ Android ë¹Œë“œ"
          echo "===================================================="
          
          # ì‘ì—… ë””ë ‰í† ë¦¬ ì •ë³´
          WORKSPACE_DIR="$(pwd)"
          BUILD_DIR="$WORKSPACE_DIR/android-build"
          
          echo "ğŸ“‚ ë¹Œë“œ ë””ë ‰í† ë¦¬ ê²½ë¡œ: $BUILD_DIR"
          echo "ğŸ“‚ ë¹Œë“œ ë””ë ‰í† ë¦¬ ë‚´ìš©:"
          ls -la $BUILD_DIR
          
          # Docker ì´ë¯¸ì§€ ë° í™˜ê²½ í™•ì¸
          echo "ğŸ³ ì‚¬ìš©í•  Docker ì´ë¯¸ì§€: ${DOCKER_IMAGE}"
          echo "ğŸ³ Docker ì´ë¯¸ì§€ ì„¸ë¶€ ì •ë³´:"
          docker image inspect ${DOCKER_IMAGE} | grep -E 'Id|RepoTags|Created|Size'
          
          # ë³¼ë¥¨ ë§ˆìš´íŠ¸ í…ŒìŠ¤íŠ¸
          echo "ğŸ³ Docker ë³¼ë¥¨ ë§ˆìš´íŠ¸ í…ŒìŠ¤íŠ¸:"
          docker run --rm -v "$BUILD_DIR:/app" ${DOCKER_IMAGE} bash -c 'echo "ë§ˆìš´íŠ¸ëœ ë””ë ‰í† ë¦¬ ë‚´ìš©:"; ls -la /app'
          
          # Dockerì—ì„œ React Native ì•± ë¹Œë“œ ì‹¤í–‰
          echo "ğŸ³ Docker ì»¨í…Œì´ë„ˆ ë‚´ì—ì„œ ë¹Œë“œ ì‹œì‘"
          docker run --rm \
            -v "$BUILD_DIR:/app" \
            -w /app \
            -e ANDROID_SDK_ROOT=/opt/android-sdk \
            -e ANDROID_HOME=/opt/android-sdk \
            -e KEYSTORE_PASSWORD="$KEYSTORE_PASSWORD" \
            -e KEY_ALIAS="$KEY_ALIAS" \
            -e KEY_PASSWORD="$KEY_PASSWORD" \
            ${DOCKER_IMAGE} \
            bash -c '
              set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨
              set -x  # ì‹¤í–‰ ëª…ë ¹ì–´ ì¶œë ¥
              
              echo "ğŸ“‚ í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
              echo "ğŸ“‚ ë””ë ‰í† ë¦¬ ë‚´ìš©:"
              ls -la
              
              # ì „ì²´ ë””ë ‰í† ë¦¬ êµ¬ì¡° ì¶œë ¥
              echo "ğŸ“‚ ì „ì²´ ë””ë ‰í† ë¦¬ êµ¬ì¡°:"
              find . -type d | sort
              
              # íŒŒì¼ êµ¬ì¡° ê¹Šì´ í™•ì¸
              echo "ğŸ“‚ ë””ë ‰í† ë¦¬ ê¹Šì´ í™•ì¸:"
              find . -type d | awk -F/ "{ print NF-1 }" | sort -nu
              
              echo "ğŸ”§ Node ëª¨ë“ˆ ì„¤ì¹˜ ì‹œì‘"
              yarn -v
              node -v
              yarn install --verbose
              
              # Android ë””ë ‰í† ë¦¬ í™•ì¸ (í•µì‹¬ ë¶€ë¶„)
              echo "ğŸ“‚ ì•ˆë“œë¡œì´ë“œ ë””ë ‰í† ë¦¬ ì°¾ê¸°:"
              find . -name "android" -type d | sort
              
              if [ -d "android" ]; then
                echo "âœ… ë£¨íŠ¸ ê²½ë¡œì— Android ë””ë ‰í† ë¦¬ ë°œê²¬"
                cd android
              else
                echo "âš ï¸ ë£¨íŠ¸ ê²½ë¡œì— Android ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. ë””ë ‰í† ë¦¬ êµ¬ì¡° ì‹¬ì¸µ ë¶„ì„:"
                find . -type d -maxdepth 3
                
                # í•˜ìœ„ ë””ë ‰í† ë¦¬ì—ì„œ android í´ë” ì°¾ê¸°
                ANDROID_DIR=$(find . -name "android" -type d | head -1)
                if [ ! -z "$ANDROID_DIR" ]; then
                  echo "âœ… Android ë””ë ‰í† ë¦¬ ë°œê²¬: $ANDROID_DIR"
                  cd "$ANDROID_DIR"
                else
                  echo "âŒ Android ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¹Œë“œ ì‹¤íŒ¨."
                  exit 1
                fi
              fi
              
              echo "ğŸ“‚ Android ë””ë ‰í† ë¦¬ ë‚´ìš©:"
              ls -la
              
              # í•„ìˆ˜ íŒŒì¼ ë° ë””ë ‰í† ë¦¬ ì¡´ì¬ í™•ì¸
              echo "ğŸ“‚ ì¤‘ìš” íŒŒì¼ í™•ì¸:"
              [ -f "build.gradle" ] && echo "âœ… build.gradle ì¡´ì¬" || echo "âŒ build.gradle ì—†ìŒ"
              [ -f "settings.gradle" ] && echo "âœ… settings.gradle ì¡´ì¬" || echo "âŒ settings.gradle ì—†ìŒ"
              [ -f "gradlew" ] && echo "âœ… gradlew ì¡´ì¬" || echo "âŒ gradlew ì—†ìŒ"
              [ -d "app" ] && echo "âœ… app ë””ë ‰í† ë¦¬ ì¡´ì¬" || echo "âŒ app ë””ë ‰í† ë¦¬ ì—†ìŒ"
              
              echo "ğŸ“‚ app ë””ë ‰í† ë¦¬ í™•ì¸:"
              ls -la app || echo "âŒ app ë””ë ‰í† ë¦¬ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
              
              echo "ğŸ”§ local.properties ìƒì„±"
              echo "sdk.dir=/opt/android-sdk" > local.properties
              cat local.properties
              
              echo "ğŸ”§ Gradle í”„ë¡œí¼í‹° ì„¤ì •"
              cat >> gradle.properties << EOF
              
              # CI í™˜ê²½ í‚¤ìŠ¤í† ì–´ ì„¤ì •
              KEYSTORE_PASSWORD=$KEYSTORE_PASSWORD
              KEY_ALIAS=$KEY_ALIAS
              KEY_PASSWORD=$KEY_PASSWORD
              EOF
              
              echo "ğŸ“‚ gradle.properties ë‚´ìš© í™•ì¸:"
              cat gradle.properties
              
              echo "ğŸ”§ Android SDK í™˜ê²½ í™•ì¸"
              echo "ANDROID_HOME: $ANDROID_HOME"
              echo "ğŸ“‚ Android SDK ë””ë ‰í† ë¦¬ ë‚´ìš©:"
              ls -la $ANDROID_HOME || echo "âŒ Android SDK ë””ë ‰í† ë¦¬ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
              
              echo "ğŸ”§ Gradle ë²„ì „ í™•ì¸"
              chmod +x ./gradlew
              ./gradlew --version || { echo "âŒ Gradle ë²„ì „ í™•ì¸ ì‹¤íŒ¨"; exit 1; }
              
              echo "ğŸ”§ Gradle ë¹Œë“œ ì‹¤í–‰"
              ./gradlew tasks || { echo "âŒ Gradle íƒœìŠ¤í¬ ëª©ë¡ í™•ì¸ ì‹¤íŒ¨"; exit 1; }
              ./gradlew clean --info || { echo "âŒ Gradle clean ì‹¤íŒ¨"; exit 1; }
              ./gradlew assembleDebug --info || { echo "âŒ Gradle assembleDebug ì‹¤íŒ¨"; exit 1; }
              
              echo "ğŸ”§ ë¹Œë“œ ê²°ê³¼ í™•ì¸"
              find . -name "*.apk" || echo "âŒ APK íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
              
              # ë¹Œë“œ ê²°ê³¼ ìƒì„¸ í™•ì¸
              echo "ğŸ“‚ app/build ë””ë ‰í† ë¦¬ í™•ì¸:"
              ls -la app/build || echo "âŒ app/build ë””ë ‰í† ë¦¬ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
              
              echo "ğŸ“‚ app/build/outputs ë””ë ‰í† ë¦¬ í™•ì¸:"
              ls -la app/build/outputs || echo "âŒ app/build/outputs ë””ë ‰í† ë¦¬ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
              
              echo "ğŸ“‚ ë¹Œë“œ ë¡œê·¸ ì „ì²´ ê²½ë¡œ:"
              find app -name "build-info.xml" | xargs cat || echo "âŒ ë¹Œë“œ ë¡œê·¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            '
          
          # ë¹Œë“œ ê²°ê³¼ í™•ì¸ (Docker ì‹¤í–‰ í›„)
          echo "ğŸ“‚ ë¹Œë“œ í›„ android-build ë””ë ‰í† ë¦¬ êµ¬ì¡°:"
          find android-build -type d | grep -E "outputs|apk" || echo "âŒ ë¹Œë“œ ê²°ê³¼ ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          
          # APK íŒŒì¼ ì°¾ê¸° ë° ë³µì‚¬
          echo "ğŸ” APK íŒŒì¼ ê²€ìƒ‰:"
          find android-build -name "*.apk" || echo "âŒ APK íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          
          # ê²°ê³¼ë¬¼ ë³µì‚¬
          mkdir -p apk
          if find android-build -name "*.apk" | grep -q ".apk"; then
            echo "âœ… APK íŒŒì¼ ë°œê²¬: ë³µì‚¬ ì¤‘..."
            find android-build -name "*.apk" | xargs -I {} cp -v {} apk/
          else
            echo "âŒ APK íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
          fi
          
          # ë³µì‚¬ëœ íŒŒì¼ í™•ì¸
          echo "ğŸ“‚ apk ë””ë ‰í† ë¦¬ ë‚´ìš©:"
          ls -la apk || echo "âŒ apk ë””ë ‰í† ë¦¬ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤"
          
          echo "===================================================="
        '''
      }
    }

    stage('Deploy to Firebase') {
      when { expression { env.BUILD_FRONTEND == 'true' } }
      steps {
        // Firebase ë°°í¬
        withCredentials([
          string(credentialsId: 'FIREBASE_TOKEN', variable: 'FIREBASE_TOKEN')
        ]) {
          sh '''
            echo "===================================================="
            echo "ğŸ”¥ Firebase ë°°í¬"
            echo "===================================================="
            
            # APK íŒŒì¼ ì°¾ê¸°
            APK_FILE=$(find "$(pwd)/apk" -name "*.apk" | head -1)
            
            if [ -z "$APK_FILE" ]; then
              echo "âŒ APK íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ Firebase ë°°í¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤"
              exit 0
            fi
            
            echo "âœ… ì—…ë¡œë“œí•  APK íŒŒì¼: $APK_FILE"
            echo "ğŸ“‚ APK íŒŒì¼ ì •ë³´:"
            ls -la "$APK_FILE"
            file "$APK_FILE"
            
            # Dockerì—ì„œ Firebase ë°°í¬ ì‹¤í–‰
            docker run --rm \
              -v "$(pwd):/workspace" \
              -w /workspace \
              -e FIREBASE_TOKEN="$FIREBASE_TOKEN" \
              -e FIREBASE_APP_ID="$FIREBASE_APP_ID" \
              ${DOCKER_IMAGE} \
              bash -c '
                set -x  # ì‹¤í–‰ ëª…ë ¹ì–´ ì¶œë ¥
                
                cd /workspace/android-build/android
                
                # Fastlane í™˜ê²½ ë””ë²„ê¹…
                echo "ğŸ“‚ í˜„ì¬ ë””ë ‰í† ë¦¬ í™•ì¸:"
                pwd
                ls -la
                
                echo "ğŸ“‚ Fastlane ë””ë ‰í† ë¦¬ í™•ì¸:"
                ls -la fastlane || echo "âŒ Fastlane ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤"
                
                echo "ğŸ“‚ Gemfile í™•ì¸:"
                cat Gemfile || echo "âŒ Gemfileì´ ì—†ìŠµë‹ˆë‹¤"
                
                # Bundler í™˜ê²½ ì„¤ì •
                export GEM_HOME=/root/.gem
                export PATH=$PATH:$GEM_HOME/bin
                
                # Ruby ë° Bundler ë²„ì „ í™•ì¸
                echo "ğŸ’ Ruby ë²„ì „:"
                ruby --version
                
                echo "ğŸ’ Bundler ë²„ì „:"
                bundle --version || gem install bundler
                
                # Fastlaneìœ¼ë¡œ ë°°í¬
                echo "ğŸš€ Fastlane ë°°í¬ ì‹œì‘"
                bundle config set path "vendor/bundle"
                bundle install
                
                echo "ğŸ“‚ APK íŒŒì¼ ê²½ë¡œ í™•ì¸:"
                ls -la /workspace/"$APK_FILE" || echo "âŒ APK íŒŒì¼ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
                
                # Firebase CLI ì„¤ì¹˜ ë° í™•ì¸
                echo "ğŸ”¥ Firebase CLI í™•ì¸:"
                command -v firebase || npm install -g firebase-tools
                
                # Fastlaneìœ¼ë¡œ ë°°í¬
                echo "ğŸš€ Firebase App Distributionìœ¼ë¡œ APK ë°°í¬"
                bundle exec fastlane run firebase_app_distribution \
                  app:"$FIREBASE_APP_ID" \
                  firebase_cli_token:"$FIREBASE_TOKEN" \
                  apk_path:"/workspace/'"$APK_FILE"'" \
                  groups:"testers" \
                  release_notes:"Jenkins CI ìë™ ë°°í¬ ë¹Œë“œ #${BUILD_ID} (${GIT_COMMIT})" || { echo "âš ï¸ Firebase ë°°í¬ ì‹¤íŒ¨: $?"; exit 1; }
              '
            
            echo "===================================================="
          '''
        }
      }
    }

    stage('Archive APK') {
      when { expression { env.BUILD_FRONTEND == 'true' } }
      steps {
        sh '''
          echo "===================================================="
          echo "ğŸ“¦ APK ì•„ì¹´ì´ë¸Œ"
          echo "===================================================="
          
          mkdir -p apk-archive
          
          # apk ë””ë ‰í† ë¦¬ì—ì„œ APK íŒŒì¼ ì°¾ê¸° - ìì„¸í•œ ë¡œê¹… ì¶”ê°€
          echo "ğŸ” APK íŒŒì¼ ê²€ìƒ‰:"
          find "$(pwd)" -name "*.apk" 2>/dev/null | sort
          
          APK_COUNT=$(find "$(pwd)/apk" -name "*.apk" 2>/dev/null | wc -l || echo "0")
          
          if [ "$APK_COUNT" -gt 0 ]; then
            echo "âœ… $APK_COUNT ê°œì˜ APK íŒŒì¼ ë°œê²¬:"
            find "$(pwd)/apk" -name "*.apk" 2>/dev/null
            
            # ëª¨ë“  APK íŒŒì¼ì„ ì•„ì¹´ì´ë¸Œ ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬ (ìƒì„¸ ë¡œê¹…)
            echo "ğŸ“¦ APK íŒŒì¼ ë³µì‚¬ ì¤‘..."
            find "$(pwd)/apk" -name "*.apk" -exec cp -v {} apk-archive/ \;
            
            # APK íŒŒì¼ ì •ë³´ ì¶œë ¥
            echo "ğŸ“‚ APK íŒŒì¼ ì •ë³´:"
            for apk in apk-archive/*.apk; do
              echo "íŒŒì¼: $apk"
              ls -la "$apk"
              file "$apk"
              echo ""
            done
          else
            echo "âŒ APK íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            echo "No APK files found" > apk-archive/build-failed.txt
            
            # ë””ë²„ê¹… ì •ë³´ ìˆ˜ì§‘
            echo "ğŸ“‚ ë¹Œë“œ ë””ë ‰í† ë¦¬ ë‚´ ê°€ëŠ¥í•œ APK ê²½ë¡œ í™•ì¸:"
            find android-build -path "*app/build*" -type d | sort
            
            # ë¹Œë“œ ì‹¤íŒ¨ ì›ì¸ ê¸°ë¡
            echo "ë¹Œë“œ ì‹¤íŒ¨ ì‹œê°„: $(date)" >> apk-archive/build-failed.txt
            echo "ê°€ëŠ¥í•œ ì›ì¸: APK íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì˜ˆìƒ ìœ„ì¹˜ì— ì—†ìŠµë‹ˆë‹¤." >> apk-archive/build-failed.txt
          fi
          
          echo "===================================================="
        '''
        
        archiveArtifacts artifacts: 'apk-archive/**', fingerprint: true, allowEmptyArchive: true
      }
    }
  }

  post {
    success {
      sh '''
        echo "===================================================="
        echo "âœ… Frontend CI/CD ì„±ê³µ ğŸ‰"
        echo "===================================================="
      '''
    }
    failure {
      sh '''
        echo "===================================================="
        echo "âŒ Frontend CI/CD ì‹¤íŒ¨ â—"
        echo "===================================================="
        
        # ë¹Œë“œ ì‹¤íŒ¨ ì‹œ ë””ë²„ê¹… ì •ë³´ ìˆ˜ì§‘
        echo "ğŸ” ì‹¤íŒ¨ ë””ë²„ê¹… ì •ë³´ ìˆ˜ì§‘"
        
        # ì‘ì—… ë””ë ‰í† ë¦¬ êµ¬ì¡° ì €ì¥
        echo "ğŸ“‚ ì‘ì—… ë””ë ‰í† ë¦¬ êµ¬ì¡°:" > build-debug-info.txt
        find . -type d -maxdepth 3 >> build-debug-info.txt
        
        # Docker ì´ë¯¸ì§€ ì •ë³´ ì €ì¥
        echo "ğŸ³ Docker ì´ë¯¸ì§€ ì •ë³´:" >> build-debug-info.txt
        docker images >> build-debug-info.txt
        
        # ë§ˆì§€ë§‰ ë¡œê·¸ ì •ë³´ ì €ì¥
        echo "ğŸ“‹ ë§ˆì§€ë§‰ ë¡œê·¸ ì •ë³´:" >> build-debug-info.txt
        tail -n 100 ./*.log 2>/dev/null >> build-debug-info.txt || echo "ë¡œê·¸ íŒŒì¼ ì—†ìŒ" >> build-debug-info.txt
        
        # ì•ˆë“œë¡œì´ë“œ ë¹Œë“œ ì‹¤íŒ¨ ë¡œê·¸ ê²€ìƒ‰
        echo "ğŸ“‹ Gradle ë¹Œë“œ ì‹¤íŒ¨ ë¡œê·¸:" >> build-debug-info.txt
        find android-build -name "*.log" -o -name "output.json" 2>/dev/null | xargs cat >> build-debug-info.txt || echo "Gradle ë¡œê·¸ ì—†ìŒ" >> build-debug-info.txt
        
        # ëª¨ë“  ë””ë²„ê¹… ì •ë³´ë¥¼ ì•„ì¹´ì´ë¸Œ
        mkdir -p debug-archive
        cp build-debug-info.txt debug-archive/
        
        # ë””ë²„ê¹… ì •ë³´ ì•„ì¹´ì´ë¸Œ
        echo "ğŸ“¦ ë””ë²„ê¹… ì •ë³´ ì•„ì¹´ì´ë¸Œ ì™„ë£Œ"
      '''
      
      // ë¹Œë“œ ì‹¤íŒ¨ ì‹œ ë””ë²„ê¹… ì •ë³´ ì•„ì¹´ì´ë¸Œ
      archiveArtifacts artifacts: 'debug-archive/**', fingerprint: true, allowEmptyArchive: true
    }
    always {
      sh '''
        echo "===================================================="
        echo "ğŸ§¹ ì‘ì—… ê³µê°„ ì •ë¦¬"
        echo "===================================================="
        
        # ì„ì‹œ ë””ë ‰í† ë¦¬ ì •ë¦¬
        rm -rf apk android-build || true
      '''
      cleanWs()
    }
  }
}