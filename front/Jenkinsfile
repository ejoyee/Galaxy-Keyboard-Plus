pipeline {
  agent any

  environment {
    FIREBASE_TOKEN      = credentials('FIREBASE_TOKEN')
    FIREBASE_APP_ID     = '1:189536895445:android:783ed885fd7c4b896bfd5c'
    KEYSTORE_PASSWORD   = credentials('KEYSTORE_PASSWORD')
    KEY_ALIAS           = credentials('KEY_ALIAS')
    KEY_PASSWORD        = credentials('KEY_PASSWORD')
    DOCKER_IMAGE        = 'cimg/android:2023.08'
    WORK_DIR            = "${WORKSPACE}/workspace"
    TAR_PATH            = "${WORKSPACE}/workspace.tar.gz"
    APK_DIR             = "${WORKSPACE}/apk"
    ARCHIVE_DIR         = "${WORKSPACE}/apk-archive"
  }

  stages {
    stage('Checkout & Init') {
      steps {
        checkout scm
        sh '''
          echo "ðŸ“ GitLab í”„ë¡œì íŠ¸ ì „ì²´ ê¶Œí•œ ë³€ê²½"
          chmod -R 777 .
        '''
      }
    }

    stage('Prepare Project') {
      steps {
        sh '''
          echo "ðŸ“¦ ìž‘ì—… ë””ë ‰í† ë¦¬ ì¤€ë¹„ ë° ì•„ì¹´ì´ë¸Œ ìƒì„±"
          rm -rf ${WORK_DIR} ${TAR_PATH}
          mkdir -p ${WORK_DIR}
          cp -a front/frontend/. ${WORK_DIR}/
          chmod -R 777 ${WORK_DIR}

          echo "ðŸ“„ package.json ì¡´ìž¬ í™•ì¸:"
          ls -l ${WORK_DIR}/package.json || { echo "âŒ package.json ì—†ìŒ"; exit 1; }

          echo "ðŸ“¦ .tar.gz ìƒì„±"
          tar -czf ${TAR_PATH} -C ${WORK_DIR} .
          echo "ðŸ“¦ ì•„ì¹´ì´ë¸Œ ìƒì„± ì™„ë£Œ: ${TAR_PATH}"

          echo "ðŸ“Š ìƒì„±ëœ tar íŒŒì¼ ì •ë³´:"
          ls -lh ${TAR_PATH} || echo "âŒ tar íŒŒì¼ ì—†ìŒ"
          file ${TAR_PATH} || echo "âŒ file ëª…ë ¹ ì‹¤íŒ¨"
          stat ${TAR_PATH} || echo "âŒ stat ëª…ë ¹ ì‹¤íŒ¨"
        '''
      }
    }

    stage('Prepare Secrets') {
      steps {
        withCredentials([
          file(credentialsId: 'android-release-keystore', variable: 'KEYSTORE_FILE'),
          file(credentialsId: 'google-services-json', variable: 'GOOGLE_SERVICES_JSON'),
          file(credentialsId: 'firebase-service-account', variable: 'FIREBASE_SERVICE_ACCOUNT')
        ]) {
          sh '''
            echo "ðŸ” ì‹œí¬ë¦¿ íŒŒì¼ ë³µì‚¬ ë° ê¶Œí•œ ì„¤ì •"
            mkdir -p ${WORK_DIR}/android/app/keystore
            cp "$KEYSTORE_FILE" ${WORK_DIR}/android/app/keystore/release.keystore
            cp "$GOOGLE_SERVICES_JSON" ${WORK_DIR}/android/app/google-services.json
            cp "$FIREBASE_SERVICE_ACCOUNT" ${WORK_DIR}/android/firebase_service_account.json
            chmod -R 777 ${WORK_DIR}/android
          '''
        }
      }
    }

    stage('Build and Deploy') {
      steps {
        sh '''
          echo "ðŸš€ Docker ë¹Œë“œ ë° Firebase ë°°í¬ ì‹œìž‘"

          echo "ðŸ§ª Docker ë§ˆìš´íŠ¸ ì „ ì•„ì¹´ì´ë¸Œ ìƒíƒœ í™•ì¸"
          ls -lh "${TAR_PATH}"
          file "${TAR_PATH}"
          stat "${TAR_PATH}"

          docker run --rm \
            -v "${TAR_PATH}:/workspace.tar.gz" \
            -e FIREBASE_TOKEN="${FIREBASE_TOKEN}" \
            -e FIREBASE_APP_ID="${FIREBASE_APP_ID}" \
            ${DOCKER_IMAGE} \
            bash -c '
              set -e

              echo "ðŸ“¦ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ /workspace.tar.gz ìƒíƒœ í™•ì¸"
              file /workspace.tar.gz || echo "âŒ file í™•ì¸ ì‹¤íŒ¨"
              ls -lh /workspace.tar.gz || echo "âŒ íŒŒì¼ ì¡´ìž¬ ì•ˆ í•¨"
              stat /workspace.tar.gz || echo "âŒ stat ì‹¤íŒ¨"

              if [ -d /workspace.tar.gz ]; then
                echo "âŒ /workspace.tar.gz ëŠ” ë””ë ‰í† ë¦¬ìž…ë‹ˆë‹¤! ìž˜ëª»ëœ ë§ˆìš´íŠ¸"
                exit 1
              fi

              echo "ðŸ“‚ /tmp/project ìƒì„± ë° ì••ì¶• í•´ì œ ì‹œë„"
              mkdir -p /tmp/project
              tar -xzf /workspace.tar.gz -C /tmp/project || { echo "âŒ tar ì¶”ì¶œ ì‹¤íŒ¨"; exit 1; }

              echo "ðŸ“ ì¶”ì¶œ í›„ ë””ë ‰í† ë¦¬ ìƒíƒœ:"
              ls -al /tmp/project || echo "âŒ ë””ë ‰í† ë¦¬ ì—†ìŒ"
              cd /tmp/project

              echo "ðŸ“¦ npm install ì‹œìž‘"
              npm install || { echo "âŒ npm install ì‹¤íŒ¨"; exit 1; }

              cd android
              chmod +x ./gradlew
              echo "sdk.dir=$ANDROID_HOME" > local.properties
              echo "KEYSTORE_PASSWORD=${KEYSTORE_PASSWORD}" >> gradle.properties
              echo "KEY_ALIAS=${KEY_ALIAS}" >> gradle.properties
              echo "KEY_PASSWORD=${KEY_PASSWORD}" >> gradle.properties

              echo "ðŸ› ï¸ Gradle ë¹Œë“œ ì‹œìž‘"
              ./gradlew clean assembleRelease --stacktrace || { echo "âŒ Gradle ë¹Œë“œ ì‹¤íŒ¨"; exit 1; }

              echo "ðŸ“ ë¹Œë“œ ì‚°ì¶œë¬¼ ë³µì‚¬"
              mkdir -p /tmp/output
              find . -name "*.apk" -o -name "*.aab" -exec cp {} /tmp/output/ \\;

              echo "ðŸ”¥ Firebase CLI ì„¤ì¹˜ ë° ë°°í¬ ì‹œìž‘"
              npm install -g firebase-tools || { echo "âŒ Firebase CLI ì„¤ì¹˜ ì‹¤íŒ¨"; exit 1; }

              ls -lh /tmp/output/
              firebase appdistribution:distribute /tmp/output/*.apk \
                --app "$FIREBASE_APP_ID" \
                --token "$FIREBASE_TOKEN" \
                --groups "testers" \
                --release-notes "CI ìžë™ ë°°í¬ #${BUILD_ID}" || { echo "âŒ Firebase ë°°í¬ ì‹¤íŒ¨"; exit 1; }

              echo "âœ… Firebase ë°°í¬ ì™„ë£Œ"
            '

          echo "ðŸ“¦ ê²°ê³¼ ë³µì‚¬"
          mkdir -p ${ARCHIVE_DIR}
          cp -v ${APK_DIR}/*.apk ${ARCHIVE_DIR}/ || echo "âš ï¸ APK íŒŒì¼ ì—†ìŒ"
        '''
        archiveArtifacts artifacts: 'apk-archive/**', fingerprint: true, allowEmptyArchive: true
      }
    }
  }

  post {
    success {
      echo 'âœ… ë¹Œë“œ ë° ë°°í¬ ì„±ê³µ ðŸŽ‰'
    }
    failure {
      sh '''
        echo "âŒ ë¹Œë“œ ì‹¤íŒ¨, ë””ë²„ê¹… ë¡œê·¸ ìˆ˜ì§‘ ì‹œìž‘"
        mkdir -p debug-archive
        echo "## package.json ë‚´ìš©" > debug-archive/info.txt
        cat ${WORK_DIR}/package.json >> debug-archive/info.txt 2>/dev/null || echo "package.json ì—†ìŒ" >> debug-archive/info.txt

        echo "## .tar.gz ìƒíƒœ" >> debug-archive/info.txt
        file ${TAR_PATH} >> debug-archive/info.txt 2>/dev/null || echo "file ì‹¤íŒ¨" >> debug-archive/info.txt
        stat ${TAR_PATH} >> debug-archive/info.txt 2>/dev/null || echo "stat ì‹¤íŒ¨" >> debug-archive/info.txt
      '''
      archiveArtifacts artifacts: 'debug-archive/**', fingerprint: true, allowEmptyArchive: true
    }
    always {
      cleanWs()
    }
  }
}
