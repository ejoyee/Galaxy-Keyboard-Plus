pipeline {
  agent any

  environment {
    // Android SDK ì„¤ì •
    ANDROID_SDK_ROOT = '/opt/android-sdk'
    ANDROID_HOME     = '/opt/android-sdk'
    PATH             = "${env.PATH}:/opt/android-sdk/cmdline-tools/latest/bin:/opt/android-sdk/platform-tools"
    // Fastlane Firebase App Distribution í† í°
    FIREBASE_TOKEN   = credentials('FIREBASE_TOKEN')
    // Firebase ì•± ID
    FIREBASE_APP_ID  = '1:189536895445:android:783ed885fd7c4b896bfd5c'
    // ë¹Œë“œ ê°•ì œ ì‹¤í–‰ ì—¬ë¶€
    FORCE_BUILD      = 'true'
    // í‚¤ìŠ¤í† ì–´ ê´€ë ¨ ì„¤ì •
    KEYSTORE_PASSWORD = credentials('KEYSTORE_PASSWORD')
    KEY_ALIAS        = credentials('KEY_ALIAS')
    KEY_PASSWORD     = credentials('KEY_PASSWORD')
    // ì‚¬ìš©í•  Docker ì´ë¯¸ì§€
    DOCKER_IMAGE     = 'my-android-ci:latest'
    // í˜„ì¬ ì‚¬ìš©ì ID (Docker ë³¼ë¥¨ ë§ˆìš´íŠ¸ì— ì‚¬ìš©)
    USER_ID = sh(script: 'id -u', returnStdout: true).trim()
    GROUP_ID = sh(script: 'id -g', returnStdout: true).trim()
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
        
        // ë¹Œë“œ ì‹œì‘ ë¡œê·¸
        sh '''
          echo "===================================================="
          echo "ğŸš€ ë¹Œë“œ ì‹œì‘: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ” ë¹Œë“œ ID: ${BUILD_ID}"
          echo "ğŸ” Git ì»¤ë°‹: ${GIT_COMMIT}"
          echo "ğŸ” ë¸Œëœì¹˜: ${GIT_BRANCH}"
          echo "===================================================="
        '''
      }
    }

    stage('Detect Frontend Changes') {
      steps {
        script {
          def diff = sh(
            script: "git diff --name-only ${env.GIT_PREVIOUS_SUCCESSFUL_COMMIT ?: 'HEAD~1'} ${env.GIT_COMMIT}",
            returnStdout: true
          ).trim()
          
          // ë³€ê²½ íŒŒì¼ ëª©ë¡ ì¶œë ¥
          echo "==== ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ===="
          echo "${diff}"
          echo "=========================="
          
          // "front/" í•˜ìœ„ íŒŒì¼ ë³€ê²½ì´ ìˆìœ¼ë©´ ë¹Œë“œ
          env.BUILD_FRONTEND = diff.split('\n').any { it.startsWith('front/') } ? 'true' : 'false'
          
          // ê°•ì œ ë¹Œë“œ ì˜µì…˜ì´ trueì´ë©´ ë¬´ì¡°ê±´ ë¹Œë“œ
          if (env.FORCE_BUILD == 'true') {
            env.BUILD_FRONTEND = 'true'
            echo "ğŸ”§ ê°•ì œ ë¹Œë“œ ì˜µì…˜ì´ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
          }
          
          echo env.BUILD_FRONTEND=='true'
               ? "â–¶ Frontend ë³€ê²½ ê°ì§€: ë¹Œë“œí•©ë‹ˆë‹¤"
               : "â–¶ Frontend ë³€ê²½ ì—†ìŒ: ìŠ¤í‚µí•©ë‹ˆë‹¤"
        }
      }
    }

    stage('Check Project Structure') {
      when { expression { env.BUILD_FRONTEND == 'true' } }
      steps {
        sh '''
          echo "===================================================="
          echo "ğŸ” í”„ë¡œì íŠ¸ êµ¬ì¡° í™•ì¸"
          echo "===================================================="
          
          # ë””ë ‰í† ë¦¬ êµ¬ì¡° í™•ì¸
          echo "ğŸ“‚ ì‘ì—… ë””ë ‰í† ë¦¬: $(pwd)"
          
          echo "ğŸ“‚ front/frontend ë””ë ‰í† ë¦¬ í™•ì¸:"
          ls -la front/frontend || { echo "âŒ front/frontend ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤"; exit 1; }
          
          # package.json í™•ì¸
          if [ -f "front/frontend/package.json" ]; then
            echo "âœ… package.json íŒŒì¼ ì¡´ì¬"
            cat front/frontend/package.json | grep "name\\|version"
          else
            echo "âŒ package.json íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. React Native í”„ë¡œì íŠ¸ê°€ ì•„ë‹ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
            exit 1
          fi
          
          echo "ğŸ“‚ front/frontend/android ë””ë ‰í† ë¦¬ í™•ì¸:"
          ls -la front/frontend/android || { echo "âŒ front/frontend/android ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤"; exit 1; }
          
          echo "ğŸ“‚ gradlew íŒŒì¼ í™•ì¸:"
          if [ -f "front/frontend/android/gradlew" ]; then
            echo "âœ… gradlew íŒŒì¼ ì¡´ì¬"
            chmod +x front/frontend/android/gradlew
          else
            echo "âŒ gradlew íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi
          
          echo "===================================================="
        '''
      }
    }

    stage('Prepare Files') {
      when { expression { env.BUILD_FRONTEND == 'true' } }
      steps {
        // ì‹œí¬ë¦¿ íŒŒì¼ ì¤€ë¹„
        withCredentials([
          file(credentialsId: 'android-release-keystore', variable: 'KEYSTORE_FILE'),
          file(credentialsId: 'google-services-json', variable: 'GOOGLE_SERVICES_JSON'),
          file(credentialsId: 'firebase-service-account', variable: 'FIREBASE_SERVICE_ACCOUNT')
        ]) {
          sh '''
            echo "===================================================="
            echo "ğŸ” ì‹œí¬ë¦¿ íŒŒì¼ ì¤€ë¹„"
            echo "===================================================="
            
            # ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p front/frontend/android/app/keystore
            
            # ì‹œí¬ë¦¿ íŒŒì¼ ë³µì‚¬ (ì˜¬ë°”ë¥¸ ê²½ë¡œì— ë§ê²Œ ì¡°ì •)
            cp "$FIREBASE_SERVICE_ACCOUNT" front/frontend/android/firebase_service_account.json
            cp "$GOOGLE_SERVICES_JSON" front/frontend/android/app/google-services.json
            cp "$KEYSTORE_FILE" front/frontend/android/app/keystore/release.keystore
            
            # íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
            ls -la front/frontend/android/firebase_service_account.json
            ls -la front/frontend/android/app/google-services.json
            ls -la front/frontend/android/app/keystore/release.keystore
            
            echo "âœ… ì‹œí¬ë¦¿ íŒŒì¼ ë³µì‚¬ ì™„ë£Œ"
            echo "===================================================="
          '''
        }
      }
    }

    stage('Build with Docker') {
      when { expression { env.BUILD_FRONTEND == 'true' } }
      steps {
        sh '''
          echo "===================================================="
          echo "ğŸš€ Dockerë¥¼ í†µí•œ Android ë¹Œë“œ"
          echo "===================================================="
          
          # ì „ì²´ í”„ë¡œì íŠ¸ ê²½ë¡œ (ì ˆëŒ€ ê²½ë¡œ)
          PROJECT_PATH="$(pwd)/front/frontend"
          
          # Dockerì—ì„œ React Native ì•± ë¹Œë“œ ì‹¤í–‰ (ì¤‘ìš”: -u ì˜µì…˜ ì¶”ê°€)
          docker run --rm \
            -u $(id -u):$(id -g) \
            -v "$PROJECT_PATH:/workspace" \
            -w /workspace \
            -e ANDROID_SDK_ROOT=/opt/android-sdk \
            -e ANDROID_HOME=/opt/android-sdk \
            -e KEYSTORE_PASSWORD="$KEYSTORE_PASSWORD" \
            -e KEY_ALIAS="$KEY_ALIAS" \
            -e KEY_PASSWORD="$KEY_PASSWORD" \
            ${DOCKER_IMAGE} \
            bash -c '
              set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨
              
              echo "ğŸ“‚ í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
              ls -la
              
              echo "ğŸ“‚ Android ë””ë ‰í† ë¦¬ í™•ì¸:"
              ls -la android
              
              # ì¤‘ìš” íŒŒì¼ í™•ì¸
              if [ ! -f "android/gradlew" ] || [ ! -d "android/app" ]; then
                echo "âŒ í•„ìˆ˜ Android íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ë³¼ë¥¨ ë§ˆìš´íŠ¸ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤."
                exit 1
              fi
              
              echo "ğŸ”§ Node ëª¨ë“ˆ ì„¤ì¹˜"
              yarn install
              
              echo "ğŸ”§ Android ë””ë ‰í† ë¦¬ë¡œ ì´ë™"
              cd android
              
              echo "ğŸ”§ local.properties ìƒì„±"
              echo "sdk.dir=/opt/android-sdk" > local.properties
              
              echo "ğŸ”§ Gradle í”„ë¡œí¼í‹° ì„¤ì •"
              cat >> gradle.properties << EOF

# CI í™˜ê²½ í‚¤ìŠ¤í† ì–´ ì„¤ì •
KEYSTORE_PASSWORD=$KEYSTORE_PASSWORD
KEY_ALIAS=$KEY_ALIAS
KEY_PASSWORD=$KEY_PASSWORD
EOF
              
              echo "ğŸ”§ Android SDK í™˜ê²½ í™•ì¸"
              echo "ANDROID_HOME: $ANDROID_HOME"
              
              echo "ğŸ”§ Gradle ë¹Œë“œ ì‹¤í–‰"
              chmod +x ./gradlew
              ./gradlew clean
              ./gradlew assembleDebug
              
              echo "ğŸ”§ ë¹Œë“œ ê²°ê³¼ í™•ì¸"
              find . -name "*.apk"
            '
          
          # ë¹Œë“œ ê²°ê³¼ í™•ì¸
          echo "ğŸ“‚ ë¹Œë“œ ê²°ê³¼ í™•ì¸:"
          find front/frontend/android -name "*.apk" || echo "âŒ APK íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          
          # ê²°ê³¼ë¬¼ ë³µì‚¬
          mkdir -p apk
          find front/frontend/android -name "*.apk" | xargs -I {} cp {} apk/ || echo "âŒ APK íŒŒì¼ ë³µì‚¬ ì‹¤íŒ¨"
          
          echo "===================================================="
        '''
      }
    }

    stage('Direct Build') {
      when { 
        expression { env.BUILD_FRONTEND == 'true' }
        // ì´ì „ ìŠ¤í…Œì´ì§€ì—ì„œ APK ìƒì„± ì‹¤íŒ¨í–ˆì„ ê²½ìš°ì— ì‹¤í–‰ (ë°±ì—… ë°©ë²•)
        expression { 
          return sh(script: 'find apk -name "*.apk" | wc -l', returnStdout: true).trim() == '0' 
        }
      }
      steps {
        sh '''
          echo "===================================================="
          echo "ğŸš€ ì§ì ‘ Android ë¹Œë“œ ì‹œë„ (ë°±ì—… ë°©ë²•)"
          echo "===================================================="
          
          cd front/frontend/android
          
          # local.properties ìƒì„±
          echo "sdk.dir=${ANDROID_SDK_ROOT}" > local.properties
          
          # Gradle í”„ë¡œí¼í‹°ì— Keystore ì •ë³´ ì¶”ê°€
          cat >> gradle.properties << EOF

# CI í™˜ê²½ í‚¤ìŠ¤í† ì–´ ì„¤ì •
KEYSTORE_PASSWORD=${KEYSTORE_PASSWORD}
KEY_ALIAS=${KEY_ALIAS}
KEY_PASSWORD=${KEY_PASSWORD}
EOF
          
          # Gradle ë¹Œë“œ
          chmod +x ./gradlew
          ./gradlew clean
          ./gradlew assembleDebug
          
          # ë¹Œë“œ ê²°ê³¼ë¬¼ í™•ì¸
          find . -name "*.apk"
          
          # ê²°ê³¼ë¬¼ ë³µì‚¬
          mkdir -p ../../apk
          find . -name "*.apk" | xargs -I {} cp {} ../../apk/
          
          echo "===================================================="
        '''
      }
    }

    stage('Archive APK') {
      when { expression { env.BUILD_FRONTEND == 'true' } }
      steps {
        sh '''
          echo "===================================================="
          echo "ğŸ“¦ APK ì•„ì¹´ì´ë¸Œ"
          echo "===================================================="
          
          mkdir -p apk-archive
          
          # APK íŒŒì¼ ê²€ìƒ‰ ë²”ìœ„ í™•ì¥
          FOUND_APKS=$(find "$(pwd)" -name "*.apk" | wc -l)
          
          if [ "$FOUND_APKS" -gt 0 ]; then
            echo "âœ… $FOUND_APKS ê°œì˜ APK íŒŒì¼ ë°œê²¬:"
            find "$(pwd)" -name "*.apk"
            
            # APK íŒŒì¼ ë³µì‚¬
            find "$(pwd)" -name "*.apk" | xargs -I {} cp {} apk-archive/
          else
            echo "âŒ APK íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            echo "No APK files found" > apk-archive/build-failed.txt
          fi
          
          echo "===================================================="
        '''
        
        archiveArtifacts artifacts: 'apk-archive/**', fingerprint: true, allowEmptyArchive: true
      }
    }

    stage('Deploy to Firebase') {
      when { expression { env.BUILD_FRONTEND == 'true' } }
      steps {
        // Firebase ë°°í¬
        withCredentials([
          string(credentialsId: 'FIREBASE_TOKEN', variable: 'FIREBASE_TOKEN')
        ]) {
          sh '''
            echo "===================================================="
            echo "ğŸ”¥ Firebase ë°°í¬"
            echo "===================================================="
            
            # ì „ì²´ ì‹œìŠ¤í…œì—ì„œ APK íŒŒì¼ ì°¾ê¸°
            APK_FILE=$(find "$(pwd)" -name "*.apk" | head -1)
            
            if [ -z "$APK_FILE" ]; then
              echo "âŒ APK íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ Firebase ë°°í¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤"
              exit 0
            fi
            
            echo "âœ… ì—…ë¡œë“œí•  APK íŒŒì¼: $APK_FILE"
            
            # Dockerì—ì„œ Firebase ë°°í¬ ì‹¤í–‰
            docker run --rm \
              -v "$(pwd):/workspace" \
              -w /workspace \
              -e FIREBASE_TOKEN="$FIREBASE_TOKEN" \
              -e FIREBASE_APP_ID="$FIREBASE_APP_ID" \
              ${DOCKER_IMAGE} \
              bash -c '
                cd /workspace/front/frontend/android
                
                # Bundler í™˜ê²½ ì„¤ì •
                export GEM_HOME=/root/.gem
                export PATH=$PATH:$GEM_HOME/bin
                
                # Fastlaneìœ¼ë¡œ ë°°í¬
                bundle config set path "vendor/bundle"
                bundle install
                
                bundle exec fastlane run firebase_app_distribution \
                  app:"$FIREBASE_APP_ID" \
                  firebase_cli_token:"$FIREBASE_TOKEN" \
                  apk_path:"/workspace/'"$APK_FILE"'" \
                  groups:"testers" \
                  release_notes:"Jenkins CI ìë™ ë°°í¬ ë¹Œë“œ #${BUILD_ID} (${GIT_COMMIT})"
              '
            
            echo "===================================================="
          '''
        }
      }
    }
  }

  post {
    success {
      sh '''
        echo "===================================================="
        echo "âœ… Frontend CI/CD ì„±ê³µ ğŸ‰"
        echo "===================================================="
      '''
    }
    failure {
      sh '''
        echo "===================================================="
        echo "âŒ Frontend CI/CD ì‹¤íŒ¨ â—"
        echo "===================================================="
        
        # ë””ë²„ê¹… ì •ë³´ ìˆ˜ì§‘
        echo "ğŸ” ë¹Œë“œ ì‹¤íŒ¨ ë””ë²„ê¹… ì •ë³´:"
        echo "Android ë””ë ‰í† ë¦¬ êµ¬ì¡°:" > debug-info.txt
        find front/frontend/android -type f | sort >> debug-info.txt
        echo "" >> debug-info.txt
        
        echo "Gradle íŒŒì¼ ë‚´ìš©:" >> debug-info.txt
        cat front/frontend/android/build.gradle >> debug-info.txt
        echo "" >> debug-info.txt
        
        echo "ë§ˆìš´íŠ¸ ìƒíƒœ:" >> debug-info.txt
        docker run --rm -v "$(pwd)/front/frontend:/workspace" ${DOCKER_IMAGE} bash -c 'ls -la /workspace' >> debug-info.txt
        
        # ë””ë²„ê¹… ì •ë³´ ì•„ì¹´ì´ë¸Œ
        mkdir -p debug-archive
        cp debug-info.txt debug-archive/
        
        # ë””ë²„ê¹… ì•„ì¹´ì´ë¸Œ
        echo "ğŸ“¦ ë””ë²„ê¹… ì •ë³´ê°€ debug-archiveì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤"
      '''
      
      archiveArtifacts artifacts: 'debug-archive/**', fingerprint: true, allowEmptyArchive: true
    }
    always {
      sh '''
        echo "===================================================="
        echo "ğŸ§¹ ì‘ì—… ê³µê°„ ì •ë¦¬"
        echo "===================================================="
        
        # ì„ì‹œ ë””ë ‰í† ë¦¬ ì •ë¦¬
        rm -rf apk apk-archive debug-archive || true
      '''
      cleanWs()
    }
  }
}