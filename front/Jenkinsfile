pipeline {
  agent any

  environment {
    // Firebase ë°°í¬ ì •ë³´
    FIREBASE_TOKEN   = credentials('FIREBASE_TOKEN')
    FIREBASE_APP_ID  = '1:189536895445:android:783ed885fd7c4b896bfd5c'
    // í‚¤ìŠ¤í† ì–´ ê´€ë ¨ ì„¤ì •
    KEYSTORE_PASSWORD = credentials('KEYSTORE_PASSWORD')
    KEY_ALIAS        = credentials('KEY_ALIAS')
    KEY_PASSWORD     = credentials('KEY_PASSWORD')
    // CircleCI Android ì´ë¯¸ì§€ ì‚¬ìš©
    DOCKER_IMAGE     = 'cimg/android:2023.08'
    // ì‘ì—… ë””ë ‰í† ë¦¬ ë³€ìˆ˜ ì¶”ê°€ (Jenkins ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë‚´ ì„ì‹œ ë””ë ‰í† ë¦¬)
    WORK_DIR         = "${WORKSPACE}/workspace"
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm

        // ë¹Œë“œ ì‹œì‘ ë¡œê·¸
        sh '''
          echo "===================================================="
          echo "ğŸš€ ë¹Œë“œ ì‹œì‘: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ” ë¹Œë“œ ID: ${BUILD_ID}"
          echo "ğŸ” Git ì»¤ë°‹: ${GIT_COMMIT}"
          echo "ğŸ” ë¸Œëœì¹˜: ${GIT_BRANCH}"
          echo "ğŸ” ì‘ì—… ë””ë ‰í† ë¦¬: ${WORKSPACE}"
          echo "===================================================="
        '''
      }
    }

    stage('Check Docker Image') {
      steps {
        sh '''
          echo "===================================================="
          echo "ğŸ” Docker ì´ë¯¸ì§€ í™•ì¸"
          echo "===================================================="

          # Docker ì´ë¯¸ì§€ í™•ì¸
          if docker image inspect ${DOCKER_IMAGE} >/dev/null 2>&1; then
            echo "âœ… Docker ì´ë¯¸ì§€ ${DOCKER_IMAGE}ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤."
          else
            echo "ğŸ”„ Docker ì´ë¯¸ì§€ ${DOCKER_IMAGE}ë¥¼ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤."
            docker pull ${DOCKER_IMAGE} || {
              echo "âŒ Docker ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨! ì‚¬ìš© ê°€ëŠ¥í•œ ì´ë¯¸ì§€ì¸ì§€ í™•ì¸í•˜ì„¸ìš”."
              exit 1
            }
          fi

          echo "===================================================="
        '''
      }
    }

    stage('Prepare Build Environment') {
      steps {
        sh '''
          echo "===================================================="
          echo "ğŸ”§ ë¹Œë“œ í™˜ê²½ ì¤€ë¹„ (Jenkins ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë‚´ ì„ì‹œ ë””ë ‰í† ë¦¬ ${WORK_DIR})"
          echo "===================================================="

          # ì„ì‹œ ì‘ì—… ë””ë ‰í† ë¦¬ ìƒì„± (ì „ì²´ ê²½ë¡œ ì‚¬ìš©)
          rm -rf ${WORK_DIR}
          mkdir -p ${WORK_DIR}

          # ë””ë²„ê¹…: ì›ë³¸ ë””ë ‰í† ë¦¬ êµ¬ì¡° í™•ì¸
          echo "ğŸ“‚ ì›ë³¸ frontend ë””ë ‰í† ë¦¬ êµ¬ì¡°:"
          ls -la front/frontend/ || echo "front/frontend ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."

          # í”„ë¡œì íŠ¸ íŒŒì¼ ë³µì‚¬ (ëª¨ë“  íŒŒì¼ì„ ë³µì‚¬í•˜ê¸° ìœ„í•´ ./* ì‚¬ìš©)
          echo "ğŸ“‚ í”„ë¡œì íŠ¸ íŒŒì¼ ë³µì‚¬ ì¤‘..."
          cp -a front/frontend/. ${WORK_DIR}/ || { echo "âŒ í”„ë¡œì íŠ¸ íŒŒì¼ ë³µì‚¬ ì‹¤íŒ¨!"; exit 1; }
          echo "âœ… í”„ë¡œì íŠ¸ íŒŒì¼ ë³µì‚¬ ì™„ë£Œ."

          # íŒŒì¼ ëª©ë¡ í™•ì¸ (ë” ìì„¸í•œ ë¡œê¹…)
          echo "ğŸ“‚ ë³µì‚¬ëœ íŒŒì¼ í™•ì¸ (${WORK_DIR}):"
          ls -la ${WORK_DIR}

          # package.json í™•ì¸
          echo "ğŸ“„ ${WORK_DIR}/package.json í™•ì¸:"
          cat ${WORK_DIR}/package.json | head -20 || echo "package.json íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"

          # ê¶Œí•œ ì„¤ì • (ëª¨ë“  ì‚¬ìš©ìê°€ ì½ê³  ì“¸ ìˆ˜ ìˆë„ë¡ - Docker ë§ˆìš´íŠ¸ ì‹œ ê¶Œí•œ ë¬¸ì œ ë°©ì§€)
          echo "ğŸ”§ ê¶Œí•œ ì„¤ì • ì¤‘ (chmod -R 777)..."
          chmod -R 777 ${WORK_DIR} || { echo "âŒ ê¶Œí•œ ì„¤ì • ì‹¤íŒ¨!"; exit 1; }
          echo "âœ… ê¶Œí•œ ì„¤ì • ì™„ë£Œ."

          # íŒŒì¼ ê¶Œí•œ í™•ì¸
          echo "ğŸ“„ ì¤‘ìš” íŒŒì¼ ê¶Œí•œ í™•ì¸ (${WORK_DIR}/package.json):"
          ls -la ${WORK_DIR}/package.json || echo "package.json íŒŒì¼ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"

          echo "===================================================="
        '''
      }
    }

    stage('Prepare Secret Files') {
      steps {
        withCredentials([
          file(credentialsId: 'android-release-keystore', variable: 'KEYSTORE_FILE'),
          file(credentialsId: 'google-services-json', variable: 'GOOGLE_SERVICES_JSON'),
          file(credentialsId: 'firebase-service-account', variable: 'FIREBASE_SERVICE_ACCOUNT')
        ]) {
          sh '''
            echo "===================================================="
            echo "ğŸ” ì‹œí¬ë¦¿ íŒŒì¼ ì¤€ë¹„ (${WORK_DIR} ë‚´ë¶€)"
            echo "===================================================="

            # í•„ìš”í•œ ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p ${WORK_DIR}/android/app/keystore || { echo "âŒ keystore ë””ë ‰í† ë¦¬ ìƒì„± ì‹¤íŒ¨!"; exit 1; }
            mkdir -p ${WORK_DIR}/android || { echo "âŒ android ë””ë ‰í† ë¦¬ ìƒì„± ì‹¤íŒ¨!"; exit 1; } # firebase_service_account.json ìœ„ì¹˜

            # ì‹œí¬ë¦¿ íŒŒì¼ ë³µì‚¬
            echo "ğŸ“„ firebase_service_account.json ë³µì‚¬ ì¤‘..."
            cp "$FIREBASE_SERVICE_ACCOUNT" ${WORK_DIR}/android/firebase_service_account.json || { echo "âŒ firebase_service_account.json ë³µì‚¬ ì‹¤íŒ¨!"; exit 1; }
            echo "ğŸ“„ google-services.json ë³µì‚¬ ì¤‘..."
            cp "$GOOGLE_SERVICES_JSON" ${WORK_DIR}/android/app/google-services.json || { echo "âŒ google-services.json ë³µì‚¬ ì‹¤íŒ¨!"; exit 1; }
            echo "ğŸ“„ release.keystore ë³µì‚¬ ì¤‘..."
            cp "$KEYSTORE_FILE" ${WORK_DIR}/android/app/keystore/release.keystore || { echo "âŒ release.keystore ë³µì‚¬ ì‹¤íŒ¨!"; exit 1; }
            echo "âœ… ì‹œí¬ë¦¿ íŒŒì¼ ë³µì‚¬ ì™„ë£Œ."

            # ê¶Œí•œ ì„¤ì • (Docker ì»¨í…Œì´ë„ˆì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡)
            echo "ğŸ”§ ì‹œí¬ë¦¿ íŒŒì¼ ê¶Œí•œ ì„¤ì • ì¤‘..."
            chmod -R 777 ${WORK_DIR}/android/app/keystore || true # ì—ëŸ¬ ë¬´ì‹œ
            chmod 666 ${WORK_DIR}/android/firebase_service_account.json || true
            chmod 666 ${WORK_DIR}/android/app/google-services.json || true
            chmod 666 ${WORK_DIR}/android/app/keystore/release.keystore || true
            echo "âœ… ì‹œí¬ë¦¿ íŒŒì¼ ê¶Œí•œ ì„¤ì • ì™„ë£Œ."

            # ë³µì‚¬ëœ íŒŒì¼ ì¡´ì¬ í™•ì¸ (ë””ë²„ê¹…)
            echo "ğŸ“‚ ë³µì‚¬ëœ ì‹œí¬ë¦¿ íŒŒì¼ í™•ì¸:"
            ls -la ${WORK_DIR}/android/firebase_service_account.json || echo "firebase_service_account.json ì—†ìŒ"
            ls -la ${WORK_DIR}/android/app/google-services.json || echo "google-services.json ì—†ìŒ"
            ls -la ${WORK_DIR}/android/app/keystore/release.keystore || echo "release.keystore ì—†ìŒ"


            echo "===================================================="
          '''
        }
      }
    }

    stage('Debug File System') {
      steps {
        sh '''
          echo "===================================================="
          echo "ğŸ” íŒŒì¼ ì‹œìŠ¤í…œ ë””ë²„ê¹… (Jenkins ì›Œí¬ìŠ¤í˜ì´ìŠ¤)"
          echo "===================================================="

          # í˜„ì¬ ë””ë ‰í† ë¦¬ ë° ì‘ì—… ë””ë ‰í† ë¦¬ í™•ì¸
          echo "ğŸ“‚ í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
          echo "ğŸ“‚ ì‘ì—… ë””ë ‰í† ë¦¬: ${WORK_DIR}"

          # ì‘ì—… ë””ë ‰í† ë¦¬ ë‚´ìš© í™•ì¸
          echo "ğŸ“„ ì‘ì—… ë””ë ‰í† ë¦¬ ë‚´ìš© (${WORK_DIR}):"
          ls -la ${WORK_DIR}

          # package.json íŒŒì¼ ì‹œìŠ¤í…œ ì •ë³´ í™•ì¸
          echo "ğŸ“„ ${WORK_DIR}/package.json íŒŒì¼ ì‹œìŠ¤í…œ ì •ë³´:"
          stat ${WORK_DIR}/package.json || echo "package.json íŒŒì¼ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"

          # Docker ì •ë³´ í™•ì¸
          echo "ğŸ³ Docker ë²„ì „:"
          docker --version || echo "Docker ë²„ì „ í™•ì¸ ë¶ˆê°€"

          # SELinux ìƒíƒœ í™•ì¸ (ë³¼ë¥¨ ë§ˆìš´íŠ¸ì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆìŒ)
          echo "ğŸ”’ SELinux ìƒíƒœ:"
          getenforce 2>/dev/null || echo "SELinux ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"

          # Docker í˜¸ìŠ¤íŠ¸ ì •ë³´ í™•ì¸
          echo "ğŸ³ Docker í˜¸ìŠ¤íŠ¸ ì •ë³´:"
          docker info | grep -E "Storage Driver|Root Dir" || echo "Docker í˜¸ìŠ¤íŠ¸ ì •ë³´ í™•ì¸ ë¶ˆê°€"

          echo "===================================================="

          # ì‘ì—… ë””ë ‰í† ë¦¬ë¥¼ ì•„ì¹´ì´ë¸Œë¡œ ë§Œë“¤ì–´ Dockerì—ì„œ ì¶”ì¶œí•˜ëŠ” ëŒ€ì•ˆ í…ŒìŠ¤íŠ¸
          echo "ğŸ“¦ ì‘ì—… ë””ë ‰í† ë¦¬ ì•„ì¹´ì´ë¸Œ ìƒì„± (${WORKSPACE}/workspace.tar.gz)"
          tar -czf ${WORKSPACE}/workspace.tar.gz -C ${WORK_DIR} . || { echo "âŒ ì•„ì¹´ì´ë¸Œ ìƒì„± ì‹¤íŒ¨!"; exit 1; }
          echo "âœ… ì‘ì—… ë””ë ‰í† ë¦¬ ì•„ì¹´ì´ë¸Œ ìƒì„± ì™„ë£Œ."

          echo "===================================================="
        '''
      }
    }

    stage('Docker Volume Test') {
      steps {
        sh '''
          echo "===================================================="
          echo "ğŸ” Docker ë³¼ë¥¨ ë§ˆìš´íŠ¸ í…ŒìŠ¤íŠ¸ (ë‹¤ì–‘í•œ ë°©ë²• ì‹œë„ - ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ê²½ë¡œ /tmp/project)"
          echo "===================================================="

          # ë°©ë²• 1: ì¼ë°˜ ë³¼ë¥¨ ë§ˆìš´íŠ¸ - ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ê¶Œí•œ ë¬¸ì œë¡œ ì‹¤íŒ¨ ì˜ˆìƒ
          echo "ğŸ” ë°©ë²• 1: ì¼ë°˜ ë³¼ë¥¨ ë§ˆìš´íŠ¸ í…ŒìŠ¤íŠ¸..."
          docker run --rm \\
            -v "${WORK_DIR}:/project" \\
            --workdir /project \\
            ${DOCKER_IMAGE} \\
            bash -c "ls -la && (cat package.json | head -5 || echo 'package.json íŒŒì¼ ì—†ìŒ')" || echo "â¡ï¸ ë°©ë²• 1 ì‹¤íŒ¨ (ì˜ˆìƒëŒ€ë¡œ ê¶Œí•œ ë¬¸ì œ ë°œìƒ ê°€ëŠ¥)"

          # ë°©ë²• 2: íŒŒì¼ ê²½ë¡œì— ë”°ì˜´í‘œ ì¶”ê°€ - ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ê¶Œí•œ ë¬¸ì œë¡œ ì‹¤íŒ¨ ì˜ˆìƒ
          echo "ğŸ” ë°©ë²• 2: íŒŒì¼ ê²½ë¡œì— ë”°ì˜´í‘œ ì¶”ê°€ í…ŒìŠ¤íŠ¸..."
          docker run --rm \\
            -v "${WORK_DIR}":/project \\
            --workdir /project \\
            ${DOCKER_IMAGE} \\
            bash -c "ls -la && (cat package.json | head -5 || echo 'package.json íŒŒì¼ ì—†ìŒ')" || echo "â¡ï¸ ë°©ë²• 2 ì‹¤íŒ¨ (ì˜ˆìƒëŒ€ë¡œ ê¶Œí•œ ë¬¸ì œ ë°œìƒ ê°€ëŠ¥)"

          # ë°©ë²• 3: ì•„ì¹´ì´ë¸Œ ì¶”ì¶œ ë°©ì‹ - ê²½ë¡œë¥¼ /tmp/projectë¡œ ë³€ê²½ (ì„±ê³µ ê¸°ëŒ€)
          echo "ğŸ” ë°©ë²• 3: ì•„ì¹´ì´ë¸Œ ì¶”ì¶œ ë°©ì‹ í…ŒìŠ¤íŠ¸ (ê²½ë¡œ /tmp/project)..."
          docker run --rm \\
            -v "${WORKSPACE}/workspace.tar.gz:/workspace.tar.gz" \\
            ${DOCKER_IMAGE} \\
            bash -c '
              set -e # ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨

              echo "--- ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ì •ë³´ ---"
              whoami     # í˜„ì¬ ì‚¬ìš©ì í™•ì¸
              pwd       # í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬ í™•ì¸
              ls -la /  # ë£¨íŠ¸ ë””ë ‰í† ë¦¬ ê¶Œí•œ í™•ì¸
              ls -la /tmp # /tmp ë””ë ‰í† ë¦¬ ê¶Œí•œ í™•ì¸
              echo "-------------------------"

              # /tmp ì•„ë˜ì— í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ìƒì„± ë° ì••ì¶• í•´ì œ
              echo "ğŸ“¦ ì•„ì¹´ì´ë¸Œ ì¶”ì¶œ ì¤‘... ëŒ€ìƒ: /tmp/project"
              mkdir -p /tmp/project
              tar -xzf /workspace.tar.gz -C /tmp/project
              
              # ì¶”ì¶œëœ íŒŒì¼ í™•ì¸
              echo "ğŸ“‚ ì¶”ì¶œëœ íŒŒì¼ í™•ì¸ (/tmp/project):"
              cd /tmp/project
              ls -la
              echo "ğŸ“„ /tmp/project/package.json í™•ì¸:"
              cat package.json | head -5 || echo "package.json íŒŒì¼ ì—†ìŒ"
            '
          
          echo "===================================================="
        '''
      }
    }

    stage('Build in Docker (Using Archive Method)') {
      steps {
        sh '''
          echo "===================================================="
          echo "ğŸš€ Docker ë‚´ë¶€ì—ì„œ ë¹Œë“œ ì‹¤í–‰ (ì•„ì¹´ì´ë¸Œ ë°©ì‹, ê²½ë¡œ /tmp/project)"
          echo "===================================================="

          # Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰
          # /workspace.tar.gz: Jenkinsì—ì„œ ìƒì„±í•œ ì•„ì¹´ì´ë¸Œë¥¼ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ë¡œ ë§ˆìš´íŠ¸
          # /output: ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ë¹Œë“œ ê²°ê³¼ë¬¼ì„ Jenkins ì›Œí¬ìŠ¤í˜ì´ìŠ¤ì˜ /apk ë””ë ‰í† ë¦¬ë¡œ ë§ˆìš´íŠ¸
          docker run --rm \\
            -v "${WORKSPACE}/workspace.tar.gz:/workspace.tar.gz" \\
            -v "${WORKSPACE}/apk:/output" \\
            ${DOCKER_IMAGE} \\
            bash -c '
              set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨

              echo "--- ë¹Œë“œ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ì„¤ì • ---"
              whoami # ì‹¤í–‰ ì‚¬ìš©ì í™•ì¸
              pwd # í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬ í™•ì¸
              ls -la /tmp # /tmp ê¶Œí•œ í™•ì¸
              echo "---------------------------"

              # ì‘ì—… ë””ë ‰í† ë¦¬ ì¤€ë¹„ (/tmp ì•„ë˜ì— ìƒì„±)
              echo "ğŸ“¦ ì‘ì—… ë””ë ‰í† ë¦¬ ì¤€ë¹„ ì¤‘... ëŒ€ìƒ: /tmp/project"
              mkdir -p /tmp/project
              tar -xzf /workspace.tar.gz -C /tmp/project
              cd /tmp/project
              echo "âœ… ì‘ì—… ë””ë ‰í† ë¦¬ ì¤€ë¹„ ì™„ë£Œ: $(pwd)"
              ls -la # ë””ë²„ê¹…: ë³µì‚¬ëœ íŒŒì¼ í™•ì¸

              echo "ğŸ“¦ Node.js ì¢…ì†ì„± ì„¤ì¹˜ ì¤‘..."
              if [ ! -f "package.json" ]; then
                echo "âŒ package.json íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤! í˜„ì¬ ìœ„ì¹˜: $(pwd)"
                ls -la
                exit 1
              fi
              
              # Node.js ë²„ì „ í™•ì¸ (ì„ íƒ ì‚¬í•­)
              echo "Node.js ë²„ì „: $(node --version 2>/dev/null || echo 'Node.jsê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤')"
              echo "npm ë²„ì „: $(npm --version 2>/dev/null || echo 'npmì´ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤')"
              
              npm install || { echo "âŒ npm install ì‹¤íŒ¨!"; exit 1; }
              echo "âœ… Node.js ì¢…ì†ì„± ì„¤ì¹˜ ì™„ë£Œ."

              echo "ğŸ“‚ node_modules ì„¤ì¹˜ í™•ì¸"
              ls -la node_modules/@react-native 2>/dev/null || echo "React Native ëª¨ë“ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (node_modules/@react-native)"

              echo "ğŸ”§ Android ë¹Œë“œ ì¤€ë¹„ ì¤‘..."
              if [ ! -d "android" ]; then
                echo "âŒ android ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤! í˜„ì¬ ìœ„ì¹˜: $(pwd)"
                ls -la
                exit 1
              fi
              cd android || { echo "âŒ android ë””ë ‰í† ë¦¬ë¡œ ì´ë™ ì‹¤íŒ¨!"; exit 1; }
              chmod +x ./gradlew || { echo "âŒ gradlew ì‹¤í–‰ ê¶Œí•œ ì„¤ì • ì‹¤íŒ¨!"; exit 1; }
              echo "âœ… Android ë¹Œë“œ ì¤€ë¹„ ì™„ë£Œ: $(pwd)"

              echo "ğŸ”§ local.properties ìƒì„± ì¤‘..."
              # $ANDROID_HOME ë³€ìˆ˜ëŠ” cimg/android ì´ë¯¸ì§€ì— ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
              echo "sdk.dir=$ANDROID_HOME" > local.properties || { echo "âŒ local.properties ìƒì„± ì‹¤íŒ¨!"; exit 1; }
              echo "âœ… local.properties ìƒì„± ì™„ë£Œ."

              echo "ğŸ”§ Gradle í”„ë¡œí¼í‹° ì„¤ì • ì¤‘..."
              # ë”°ì˜´í‘œ ì²˜ë¦¬ì— ë” ì•ˆì „í•œ ë°©ì‹ ì‚¬ìš©
              echo "KEYSTORE_PASSWORD=\'${KEYSTORE_PASSWORD}\'" >> gradle.properties
              echo "KEY_ALIAS=\'${KEY_ALIAS}\'" >> gradle.properties
              echo "KEY_PASSWORD=\'${KEY_PASSWORD}\'" >> gradle.properties
              # Release ë¹Œë“œë¥¼ ìœ„í•œ signingConfig ì •ë³´ ì¶”ê°€ (í•„ìš”ì‹œ)
              # build.gradle (:app) íŒŒì¼ì— signingConfig ì„¤ì •ì´ ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
              # ì˜ˆì‹œ:
              # android {
              #   signingConfigs {
              #     release {
              #       if (project.hasProperty(\'MYAPP_UPLOAD_STORE_FILE\')) {
              #         storeFile file(project.property(\'MYAPP_UPLOAD_STORE_FILE\'))
              #         storePassword project.property(\'MYAPP_UPLOAD_STORE_PASSWORD\')
              #         keyAlias project.property(\'MYAPP_UPLOAD_KEY_ALIAS\')
              #         keyPassword project.property(\'MYAPP_UPLOAD_KEY_PASSWORD\')
              #       }
              #     }
              #   }
              #   buildTypes {
              #     release {
              #       signingConfig signingConfigs.release
              #       ...
              #     }
              #   }
              # }
              # gradle.propertiesì— ë‹¤ìŒì„ ì¶”ê°€í•´ì•¼ í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤ (í”„ë¡œì íŠ¸ ì„¤ì •ì— ë”°ë¼ ë‹¤ë¦„)
              # echo "MYAPP_UPLOAD_STORE_FILE=../app/keystore/release.keystore" >> gradle.properties
              # echo "MYAPP_UPLOAD_STORE_PASSWORD=\'${KEYSTORE_PASSWORD}\'" >> gradle.properties
              # echo "MYAPP_UPLOAD_KEY_ALIAS=\'${KEY_ALIAS}\'" >> gradle.properties
              # echo "MYAPP_UPLOAD_KEY_PASSWORD=\'${KEY_PASSWORD}\'" >> gradle.properties

              echo "ğŸ“„ gradle.properties ë‚´ìš©:"
              cat gradle.properties || echo "gradle.properties íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              echo "âœ… Gradle í”„ë¡œí¼í‹° ì„¤ì • ì™„ë£Œ."

              echo "ğŸ”§ Gradle ë¹Œë“œ ì‹¤í–‰ (assembleRelease)..."
              # assembleReleaseëŠ” ì„œëª…ì„ í¬í•¨í•©ë‹ˆë‹¤.
              ./gradlew clean assembleRelease --stacktrace || { echo "âŒ Gradle ë¹Œë“œ ì‹¤íŒ¨!"; exit 1; }
              echo "âœ… Gradle ë¹Œë“œ ì„±ê³µ."

              echo "ğŸ”§ ë¹Œë“œ ê²°ê³¼ (APK/AAB) í™•ì¸ ë° ë³µì‚¬ ì¤‘..."
              mkdir -p /output || { echo "âŒ /output ë””ë ‰í† ë¦¬ ìƒì„± ì‹¤íŒ¨!"; exit 1; } # Jenkins ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë§ˆìš´íŠ¸ ì§€ì 
              
              # ë¹Œë“œëœ APK ë˜ëŠ” AAB íŒŒì¼ì„ ì°¾ì•„ /outputìœ¼ë¡œ ë³µì‚¬
              find . -name "*.apk" -print -exec cp {} /output/ ";" || echo "APK íŒŒì¼ ë³µì‚¬ ì‹¤íŒ¨ ë˜ëŠ” ì°¾ì§€ ëª»í•¨"
              find . -name "*.aab" -print -exec cp {} /output/ ";" || echo "AAB íŒŒì¼ ë³µì‚¬ ì‹¤íŒ¨ ë˜ëŠ” ì°¾ì§€ ëª»í•¨"
              echo "âœ… ë¹Œë“œ ê²°ê³¼ ë³µì‚¬ ì™„ë£Œ."
            '
          
          # Jenkins ì›Œí¬ìŠ¤í˜ì´ìŠ¤ì—ì„œ Dockerê°€ ë³µì‚¬í•œ APK/AAB íŒŒì¼ì„ ì•„ì¹´ì´ë¸Œ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          echo "ğŸ“¦ Jenkins ì›Œí¬ìŠ¤í˜ì´ìŠ¤ì—ì„œ ë¹Œë“œ ê²°ê³¼ ì •ë¦¬ ë° ì•„ì¹´ì´ë¸Œ ì¤€ë¹„ ì¤‘..."
          mkdir -p apk-archive || { echo "âŒ Jenkins ì›Œí¬ìŠ¤í˜ì´ìŠ¤ apk-archive ìƒì„± ì‹¤íŒ¨!"; exit 1; }
          # Dockerì˜ /outputì— ë³µì‚¬ëœ íŒŒì¼ë“¤ì€ Jenkins ì›Œí¬ìŠ¤í˜ì´ìŠ¤ì˜ ${WORKSPACE}/apk ì— ìˆìŠµë‹ˆë‹¤.
          find ${WORKSPACE}/apk -name "*.apk" -o -name "*.aab" -exec mv {} apk-archive/ ";" || echo "APK/AAB íŒŒì¼ ì´ë™ ì‹¤íŒ¨ ë˜ëŠ” ì—†ìŒ"
          echo "âœ… ë¹Œë“œ ê²°ê³¼ ì •ë¦¬ ë° ì•„ì¹´ì´ë¸Œ ì¤€ë¹„ ì™„ë£Œ."

          # ì•„ì¹´ì´ë¸Œí•  íŒŒì¼ ëª©ë¡ ìµœì¢… í™•ì¸
          echo "ğŸ“Š ì•„ì¹´ì´ë¸Œí•  íŒŒì¼ ëª©ë¡ (./apk-archive/):"
          ls -la ./apk-archive/ || echo "./apk-archive/ ë””ë ‰í† ë¦¬ê°€ ì—†ê±°ë‚˜ ë¹„ì–´ìˆìŠµë‹ˆë‹¤."

          # ì•„ì¹´ì´ë¸Œí•  íŒŒì¼ ê°œìˆ˜ í™•ì¸
          ARTIFACT_COUNT=$(find apk-archive -name "*.apk" -o -name "*.aab" | wc -l)

          if [ "$ARTIFACT_COUNT" -gt 0 ]; then
            echo "âœ… ì´ $ARTIFACT_COUNT ê°œì˜ ë¹Œë“œ ê²°ê³¼(APK/AAB)ê°€ ì•„ì¹´ì´ë¸Œë  ì˜ˆì •ì…ë‹ˆë‹¤."
          else
            echo "âš ï¸ ì•„ì¹´ì´ë¸Œí•  ë¹Œë“œ ê²°ê³¼ íŒŒì¼(APK/AAB)ì´ ì—†ìŠµë‹ˆë‹¤."
            # ë§Œì•½ íŒŒì¼ì´ ì—†ìœ¼ë©´ ë¹Œë“œ ì‹¤íŒ¨ë¡œ ì²˜ë¦¬í•˜ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ë¼ì¸ì˜ ì£¼ì„ì„ í•´ì œí•˜ì„¸ìš”.
            # exit 1
          fi

          echo "===================================================="
        '''

        // ë¹Œë“œ ê²°ê³¼ ì•„ì¹´ì´ë¸Œ
        archiveArtifacts artifacts: 'apk-archive/**', fingerprint: true, allowEmptyArchive: true
      }
    }

    stage('Deploy to Firebase') {
      steps {
        withCredentials([
          string(credentialsId: 'FIREBASE_TOKEN', variable: 'FIREBASE_TOKEN')
        ]) {
          sh '''
            echo "===================================================="
            echo "ğŸ”¥ Firebase ë°°í¬ ì¤‘..."
            echo "===================================================="

            # Jenkins ì›Œí¬ìŠ¤í˜ì´ìŠ¤ì˜ ì•„ì¹´ì´ë¸Œëœ APK/AAB íŒŒì¼ ì°¾ê¸°
            # findëŠ” ì—¬ëŸ¬ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì²« ë²ˆì§¸ íŒŒì¼ì„ ì‚¬ìš©í•˜ê±°ë‚˜ íŠ¹ì • íŒŒì¼ì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.
            # ì—¬ê¸°ì„œëŠ” ì¼ë‹¨ ì°¾ì€ ì²« ë²ˆì§¸ íŒŒì¼ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. í•„ìš”ì— ë”°ë¼ ìˆ˜ì •í•˜ì„¸ìš”.
            APK_FILE=$(find "${WORKSPACE}/apk-archive" -name "*.apk" -o -name "*.aab" | head -1)

            if [ -z "$APK_FILE" ]; then
              echo "âŒ ë°°í¬í•  APK/AAB íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ Firebase ë°°í¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
              exit 0 # ë°°í¬ ë‹¨ê³„ë§Œ ê±´ë„ˆë›°ê³  ì „ì²´ ë¹Œë“œëŠ” ì„±ê³µ ì²˜ë¦¬
            fi

            echo "âœ… ì—…ë¡œë“œí•  íŒŒì¼: $APK_FILE"

            # Firebase ë°°í¬ ì‹¤í–‰ (docker run ë‚´ë¶€)
            # ë°°í¬í•  íŒŒì¼ì„ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ë¡œ ë§ˆìš´íŠ¸í•©ë‹ˆë‹¤.
            docker run --rm \\
              -v "${APK_FILE}:/app_artifact" \\
              -e FIREBASE_TOKEN="${FIREBASE_TOKEN}" \\
              -e FIREBASE_APP_ID="${FIREBASE_APP_ID}" \\
              ${DOCKER_IMAGE} \\
              bash -c '
                set -e # ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨

                echo "ğŸ”§ Firebase CLI ì„¤ì¹˜ ì¤‘..."
                # ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆì„ ìˆ˜ë„ ìˆì§€ë§Œ ì•ˆì „í•˜ê²Œ ë‹¤ì‹œ ì„¤ì¹˜
                npm install -g firebase-tools || { echo "âŒ Firebase CLI ì„¤ì¹˜ ì‹¤íŒ¨!"; exit 1; }
                echo "âœ… Firebase CLI ì„¤ì¹˜ ì™„ë£Œ."

                echo "ğŸ”¥ Firebase App Distribution ì‹¤í–‰ ì¤‘..."
                # ë§ˆìš´íŠ¸ëœ íŒŒì¼ ê²½ë¡œ ì‚¬ìš© (/app_artifact)
                # --groups ì˜µì…˜ì€ Firebase App Distribution í…ŒìŠ¤í„° ê·¸ë£¹ ì´ë¦„ì…ë‹ˆë‹¤.
                # --release-notesëŠ” ë°°í¬ ì‹œ ì¶”ê°€í•  ë…¸íŠ¸ì…ë‹ˆë‹¤.
                firebase appdistribution:distribute "/app_artifact" \\
                  --app "$FIREBASE_APP_ID" \\
                  --token "$FIREBASE_TOKEN" \\
                  --groups "testers" \\
                  --release-notes "Jenkins CI ìë™ ë°°í¬ ë¹Œë“œ #${BUILD_ID}" || { echo "âŒ Firebase ë°°í¬ ì‹¤íŒ¨!"; exit 1; }
                echo "âœ… Firebase ë°°í¬ ì„±ê³µ."
              ' || { echo "âŒ Firebase ë°°í¬ Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì‹¤íŒ¨!"; exit 1; } # docker run ìì²´ê°€ ì‹¤íŒ¨í•œ ê²½ìš°

            echo "===================================================="
          '''
        }
      }
    }
  }

  post {
    success {
      sh '''
        echo "===================================================="
        echo "âœ… Frontend CI/CD ì„±ê³µ ğŸ‰"
        echo "===================================================="
      '''
    }
    failure {
      sh '''
        echo "===================================================="
        echo "âŒ Frontend CI/CD ì‹¤íŒ¨ â—"
        echo "===================================================="

        # ë””ë²„ê¹… ì •ë³´ ìˆ˜ì§‘
        echo "# ë¹Œë“œ ì‹¤íŒ¨ ë””ë²„ê¹… ì •ë³´" > debug-info.md
        echo "" >> debug-info.md

        echo "## ë¹Œë“œ ë””ë ‰í† ë¦¬ ì •ë³´ (Jenkins ì›Œí¬ìŠ¤í˜ì´ìŠ¤)" >> debug-info.md
        ls -la ${WORK_DIR} 2>/dev/null >> debug-info.md || echo "${WORK_DIR} ë¹Œë“œ ë””ë ‰í† ë¦¬ê°€ ì—†ê±°ë‚˜ ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤." >> debug-info.md
        echo "" >> debug-info.md

        echo "## package.json íŒŒì¼ ë‚´ìš© (Jenkins ì›Œí¬ìŠ¤í˜ì´ìŠ¤)" >> debug-info.md
        cat ${WORK_DIR}/package.json 2>/dev/null >> debug-info.md || echo "${WORK_DIR}/package.json íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." >> debug-info.md
        echo "" >> debug-info.md

        echo "## Docker ìƒíƒœ" >> debug-info.md
        docker info 2>/dev/null >> debug-info.md || echo "Docker ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." >> debug-info.md
        echo "" >> debug-info.md

        echo "## ë§ˆì§€ë§‰ Docker Volume Test ë¡œê·¸ (ì—ëŸ¬ í™•ì¸)" >> debug-info.md
        # ì´ì „ ë¡œê·¸ì—ì„œ Docker Volume Test ë¶€ë¶„ì„ ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•˜ì—¬ ì¶”ê°€í•˜ê±°ë‚˜,
        # ê°€ëŠ¥í•˜ë‹¤ë©´ í•´ë‹¹ ìŠ¤í…ì˜ ìƒì„¸ ë¡œê·¸ íŒŒì¼ì„ ì²¨ë¶€í•˜ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤.
        echo "â¡ï¸ Jenkins ë¹Œë“œ ë¡œê·¸ì—ì„œ 'Docker Volume Test' ìŠ¤í… ìƒì„¸ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”." >> debug-info.md
        echo "" >> debug-info.md

        # ë””ë²„ê¹… ì •ë³´ ì•„ì¹´ì´ë¸Œ
        mkdir -p debug-archive || true
        cp debug-info.md debug-archive/ || true # ë³µì‚¬ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë¬´ì‹œ

        echo "ğŸ“¦ ë””ë²„ê¹… ì •ë³´ê°€ debug-archiveì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."
      '''

      archiveArtifacts artifacts: 'debug-archive/**', fingerprint: true, allowEmptyArchive: true
    }
    always {
      sh '''
        echo "===================================================="
        echo "ğŸ§¹ ì‘ì—… ê³µê°„ ì •ë¦¬"
        echo "===================================================="

        # ì„ì‹œ ë””ë ‰í† ë¦¬ ë° íŒŒì¼ ì •ë¦¬ (ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ì •ë¦¬ ì‹œë„)
        rm -rf ${WORK_DIR} ${WORKSPACE}/workspace.tar.gz ${WORKSPACE}/apk apk-archive debug-archive || true
      '''

      cleanWs()
    }
  }
}