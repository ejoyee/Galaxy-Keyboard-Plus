pipeline {
  agent any

  environment {
    FIREBASE_APP_ID = '1:189536895445:android:783ed885fd7c4b896bfd5c'
    WORK_DIR = "${WORKSPACE}/workspace"
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Prepare Project') {
      steps {
        sh '''
          echo ğŸ“¦ ì‘ì—… ë””ë ‰í† ë¦¬ ì¤€ë¹„
          rm -rf workspace
          mkdir -p workspace
          cp -a front/frontend/. workspace/
          chmod -R 777 workspace
          [ -f workspace/package.json ] && echo ğŸ“„ package.json í™•ì¸ ì™„ë£Œ
        '''
      }
    }

    stage('Prepare Secrets') {
      steps {
        withCredentials([
          file(credentialsId: 'android-release-keystore', variable: 'KEYSTORE_PATH'),
          file(credentialsId: 'google-services-json', variable: 'GOOGLE_JSON'),
          file(credentialsId: 'firebase-service-account', variable: 'FIREBASE_JSON')
        ]) {
          sh '''
            echo ğŸ” ì‹œí¬ë¦¿ íŒŒì¼ ë³µì‚¬
            mkdir -p workspace/android/app/keystore
            cp "$KEYSTORE_PATH" workspace/android/app/keystore/release.keystore
            cp "$GOOGLE_JSON" workspace/android/app/google-services.json
            cp "$FIREBASE_JSON" workspace/android/firebase_service_account.json
            chmod -R 777 workspace/android
          '''
        }
      }
    }

    stage('Build and Deploy') {
      steps {
        withCredentials([
          string(credentialsId: 'KEYSTORE_PASSWORD', variable: 'KEYSTORE_PASSWORD'),
          string(credentialsId: 'KEY_ALIAS', variable: 'KEY_ALIAS'),
          string(credentialsId: 'KEY_PASSWORD', variable: 'KEY_PASSWORD'),
          string(credentialsId: 'FIREBASE_TOKEN', variable: 'FIREBASE_TOKEN')
        ]) {
          sh '''
            echo ğŸš€ Docker ë¹Œë“œ ë° ë°°í¬ ì‹œì‘
            docker run --rm -v "$PWD/workspace:/app" \
              -e FIREBASE_TOKEN="$FIREBASE_TOKEN" \
              -e FIREBASE_APP_ID="$FIREBASE_APP_ID" \
              reactnativecommunity/docker-android:latest bash -c "
                set -e
                cd /app

                echo 'ğŸ“¦ npm install'
                npm install

                echo 'ğŸ› ï¸ Android ë¹Œë“œ'
                cd android
                chmod +x ./gradlew
                echo 'sdk.dir=/opt/android-sdk' > local.properties
                echo 'KEYSTORE_PASSWORD=$KEYSTORE_PASSWORD' >> gradle.properties
                echo 'KEY_ALIAS=$KEY_ALIAS' >> gradle.properties
                echo 'KEY_PASSWORD=$KEY_PASSWORD' >> gradle.properties
                ./gradlew clean assembleRelease --stacktrace

                echo 'ğŸ“¦ ë¹Œë“œ ì‚°ì¶œë¬¼ ë³µì‚¬'
                mkdir -p /tmp/output
                find . -name '*.apk' -o -name '*.aab' -exec cp {} /tmp/output/ \\;

                echo 'ğŸ”¥ Firebase ë°°í¬'
                npm install -g firebase-tools
                firebase appdistribution:distribute /tmp/output/*.apk \\
                  --app $FIREBASE_APP_ID \\
                  --token $FIREBASE_TOKEN \\
                  --groups testers \\
                  --release-notes 'CI ìë™ ë°°í¬'
              "
          '''
        }
      }
    }
  }

  post {
    failure {
      sh '''
        echo âŒ ë¹Œë“œ ì‹¤íŒ¨ ë””ë²„ê¹… ì €ì¥
        mkdir -p debug-archive
        echo '## package.json ë‚´ìš©'
        cat workspace/package.json || echo ì—†ìŒ
        echo '\\n## ë””ë ‰í† ë¦¬ ìƒíƒœ'
        ls -al workspace || echo ì—†ìŒ
      '''
      archiveArtifacts artifacts: 'debug-archive/**', allowEmptyArchive: true
    }
  }
}
