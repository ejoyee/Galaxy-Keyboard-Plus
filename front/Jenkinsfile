pipeline {
  agent any

  environment {
    // Android SDK ì„¤ì •
    ANDROID_SDK_ROOT = '/opt/android-sdk'
    ANDROID_HOME     = '/opt/android-sdk'
    PATH             = "${env.PATH}:/opt/android-sdk/cmdline-tools/latest/bin:/opt/android-sdk/platform-tools"
    // Fastlane Firebase App Distribution í† í°
    FIREBASE_TOKEN   = credentials('FIREBASE_TOKEN')
    // Firebase ì•± ID
    FIREBASE_APP_ID  = '1:189536895445:android:783ed885fd7c4b896bfd5c'
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
        
        // ë¹Œë“œ ì‹œì‘ ë¡œê·¸
        sh '''
          echo "===================================================="
          echo "ğŸš€ ë¹Œë“œ ì‹œì‘: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ” ë¹Œë“œ ID: ${BUILD_ID}"
          echo "ğŸ” Git ì»¤ë°‹: ${GIT_COMMIT}"
          echo "ğŸ” ë¸Œëœì¹˜: ${GIT_BRANCH}"
          echo "===================================================="
        '''
      }
    }

    stage('Detect Frontend Changes') {
      steps {
        script {
          def diff = sh(
            script: "git diff --name-only ${env.GIT_PREVIOUS_SUCCESSFUL_COMMIT ?: 'HEAD~1'} ${env.GIT_COMMIT}",
            returnStdout: true
          ).trim()
          
          // ë³€ê²½ íŒŒì¼ ëª©ë¡ ì¶œë ¥
          echo "==== ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ===="
          echo "${diff}"
          echo "=========================="
          
          // front/frontend/ í•˜ìœ„ íŒŒì¼ ë³€ê²½ì´ ìˆìœ¼ë©´ ë¹Œë“œ
          env.BUILD_FRONTEND = diff.split('\n').any { it.startsWith('front/frontend/') } ? 'true' : 'false'
          echo env.BUILD_FRONTEND=='true'
               ? "â–¶ Frontend ë³€ê²½ ê°ì§€: ë¹Œë“œí•©ë‹ˆë‹¤"
               : "â–¶ Frontend ë³€ê²½ ì—†ìŒ: ìŠ¤í‚µí•©ë‹ˆë‹¤"
        }
      }
    }

    stage('Build & Distribute Frontend') {
      when { expression { env.BUILD_FRONTEND == 'true' } }
      steps {
        // ì§ì ‘ ìˆ˜ë™ìœ¼ë¡œ ë¹Œë“œ ì¤€ë¹„
        sh '''
          echo "===================================================="
          echo "ğŸ”¨ Android ë¹Œë“œ ì¤€ë¹„"
          echo "===================================================="
          
          # ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
          WORK_DIR="$(pwd)/android_build"
          mkdir -p "$WORK_DIR"
          
          # Android í”„ë¡œì íŠ¸ íŒŒì¼ ë³µì‚¬
          cp -r front/frontend/android/* "$WORK_DIR/"
          
          # í•„ìš”í•œ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p "$WORK_DIR/app/keystore"
          
          echo "ğŸ“‚ ì‘ì—… ë””ë ‰í† ë¦¬ í™•ì¸:"
          ls -la "$WORK_DIR"
          
          echo "===================================================="
        '''
        
        // ì‹œí¬ë¦¿ íŒŒì¼ ì¤€ë¹„
        withCredentials([
          file(credentialsId: 'android-release-keystore', variable: 'KEYSTORE_FILE'),
          string(credentialsId: 'KEYSTORE_PASSWORD', variable: 'KEYSTORE_PASSWORD'),
          string(credentialsId: 'KEY_ALIAS', variable: 'KEY_ALIAS'),
          string(credentialsId: 'KEY_PASSWORD', variable: 'KEY_PASSWORD'),
          file(credentialsId: 'google-services-json', variable: 'GOOGLE_SERVICES_JSON'),
          file(credentialsId: 'firebase-service-account', variable: 'FIREBASE_SERVICE_ACCOUNT')
        ]) {
          sh '''
            echo "===================================================="
            echo "ğŸ” ì‹œí¬ë¦¿ íŒŒì¼ ì¤€ë¹„"
            echo "===================================================="
            
            # ì‹œí¬ë¦¿ íŒŒì¼ ë³µì‚¬
            cp "$KEYSTORE_FILE" android_build/app/keystore/release.keystore
            cp "$GOOGLE_SERVICES_JSON" android_build/app/google-services.json
            cp "$FIREBASE_SERVICE_ACCOUNT" android_build/firebase_service_account.json
            
            echo "âœ… ì‹œí¬ë¦¿ íŒŒì¼ ë³µì‚¬ ì™„ë£Œ"
            echo "===================================================="
          '''
        }
        
        // Gemfile ë° Fastlane íŒŒì¼ ìƒì„±
        sh '''
          echo "===================================================="
          echo "ğŸ“„ Gemfile ë° Fastlane íŒŒì¼ ìƒì„±"
          echo "===================================================="
          
          # Gemfile ìƒì„±
          cat > android_build/Gemfile << 'EOL'
source "https://rubygems.org"

gem "fastlane"
gem "fastlane-plugin-firebase_app_distribution"
EOL
          
          # Fastlane ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p android_build/fastlane
          
          # Fastfile ìƒì„±
          cat > android_build/fastlane/Fastfile << 'EOL'
default_platform(:android)

platform :android do
  desc "Deploy a new version to Firebase App Distribution"
  lane :release do |options|
    gradle(
      task: "clean assembleRelease"
    )
    
    begin
      firebase_app_distribution(
        app: ENV["FIREBASE_APP_ID"],
        groups: options[:groups],
        release_notes: options[:notes],
        firebase_cli_token: ENV["FIREBASE_TOKEN"]
      )
    rescue => e
      puts "Firebase App Distribution ì‹¤íŒ¨: #{e}"
      puts "APK ë¹Œë“œëŠ” ì™„ë£Œë˜ì—ˆìœ¼ë©° app/build/outputs/apk ë””ë ‰í† ë¦¬ì—ì„œ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤."
    end
  end
end
EOL
          
          # Appfile ìƒì„± (ì•± íŒ¨í‚¤ì§€ëª…ì€ ë³´í†µ app/build.gradle ë˜ëŠ” AndroidManifest.xmlì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤)
          cat > android_build/fastlane/Appfile << 'EOL'
json_key_file("firebase_service_account.json")
# ì•± íŒ¨í‚¤ì§€ ì´ë¦„ì€ app/build.gradle íŒŒì¼ì—ì„œ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤
# ì•„ë˜ëŠ” ì˜ˆì‹œì´ë©°, ì‹¤ì œ íŒ¨í‚¤ì§€ëª…ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤
package_name("com.ssafy.daero")
EOL
          
          echo "âœ… Gemfile ë° Fastlane íŒŒì¼ ìƒì„± ì™„ë£Œ"
          echo "===================================================="
        '''
        
        // Docker ì‹¤í–‰
        sh '''
          echo "===================================================="
          echo "ğŸ³ Docker ì»¨í…Œì´ë„ˆì—ì„œ ë¹Œë“œ ì‹¤í–‰"
          echo "===================================================="
          
          # Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰
          docker run --rm \
            -v "$(pwd)/android_build:/app" \
            -w /app \
            -e ANDROID_SDK_ROOT=/opt/android-sdk \
            -e ANDROID_HOME=/opt/android-sdk \
            -e FIREBASE_TOKEN="$FIREBASE_TOKEN" \
            -e KEYSTORE_PASSWORD="$KEYSTORE_PASSWORD" \
            -e KEY_ALIAS="$KEY_ALIAS" \
            -e KEY_PASSWORD="$KEY_PASSWORD" \
            -e FIREBASE_APP_ID="$FIREBASE_APP_ID" \
            my-android-ci:latest \
            bash -c '
              set -x
              
              # ì‘ì—… ë””ë ‰í† ë¦¬ í™•ì¸
              echo "==== ì‘ì—… ë””ë ‰í† ë¦¬ ë‚´ìš© ===="
              pwd
              ls -la
              
              # Gemfile í™•ì¸
              echo "==== Gemfile í™•ì¸ ===="
              cat Gemfile
              
              # Fastlane íŒŒì¼ í™•ì¸
              echo "==== Fastlane íŒŒì¼ í™•ì¸ ===="
              ls -la fastlane
              
              # app/build.gradle í™•ì¸ (íŒ¨í‚¤ì§€ëª… í™•ì¸ì„ ìœ„í•´)
              echo "==== app/build.gradle í™•ì¸ ===="
              cat app/build.gradle || echo "app/build.gradle íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"
              
              # Bundler ì„¤ì¹˜
              echo "==== Bundler ì„¤ì¹˜ ===="
              gem install bundler -v 2.4.22 --no-document
              
              # Bundle ì„¤ì¹˜
              echo "==== Bundle ì„¤ì¹˜ ===="
              bundle config set --local path vendor/bundle
              bundle install
              
              # Fastlane í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜
              echo "==== Fastlane í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜ ===="
              bundle exec fastlane install_plugins
              
              # ì•± íŒ¨í‚¤ì§€ ì´ë¦„ ì¶”ì¶œ ì‹œë„
              echo "==== íŒ¨í‚¤ì§€ ì´ë¦„ í™•ì¸ ===="
              if [ -f "app/build.gradle" ]; then
                APP_PACKAGE=$(grep "applicationId" app/build.gradle | sed -E "s/.*applicationId [\\\"](.*)[\\\"]/\\1/")
                echo "ì•± íŒ¨í‚¤ì§€ ì´ë¦„: $APP_PACKAGE"
                
                # Appfile ìˆ˜ì •
                if [ ! -z "$APP_PACKAGE" ]; then
                  sed -i "s/package_name(\\\".*\\\")/package_name(\\\"$APP_PACKAGE\\\")/g" fastlane/Appfile
                  echo "Appfile ìˆ˜ì • ì™„ë£Œ"
                fi
              fi
              
              # Gradlew ì‹¤í–‰ ê¶Œí•œ í™•ì¸
              echo "==== Gradlew ì‹¤í–‰ ê¶Œí•œ í™•ì¸ ===="
              chmod +x ./gradlew
              
              # SDK ë¼ì´ì„¼ìŠ¤ ìˆ˜ë½
              echo "==== SDK ë¼ì´ì„¼ìŠ¤ ìˆ˜ë½ ===="
              yes | sdkmanager --licenses || true
              
              # ë¹Œë“œ ì‹¤í–‰
              echo "==== Gradle ë¹Œë“œ ì‹¤í–‰ ===="
              ./gradlew clean assembleRelease || ./gradlew clean assembleDebug
              
              # ë¹Œë“œ ê²°ê³¼ í™•ì¸
              echo "==== ë¹Œë“œ ê²°ê³¼ í™•ì¸ ===="
              find . -name "*.apk"
              
              # Firebase ë°°í¬
              echo "==== Firebase ë°°í¬ ì‹œë„ ===="
              bundle exec fastlane release groups:"testers" notes:"Jenkins CI ìë™ ë°°í¬ ë¹Œë“œ" || echo "Firebase ë°°í¬ ì‹¤íŒ¨í–ˆì§€ë§Œ ë¹Œë“œëŠ” ì™„ë£Œë¨"
            '
          
          BUILD_RESULT=$?
          
          # ë¹Œë“œ ê²°ê³¼ í™•ì¸
          if [ $BUILD_RESULT -ne 0 ]; then
            echo "âŒ Android ë¹Œë“œ ì‹¤íŒ¨ (ì¢…ë£Œ ì½”ë“œ: $BUILD_RESULT)"
          else
            echo "âœ… Android ë¹Œë“œ ì„±ê³µ"
            
            # ë¹Œë“œ ê²°ê³¼ë¬¼ ë³µì‚¬
            echo "ğŸ”„ ë¹Œë“œ ê²°ê³¼ë¬¼ ë³µì‚¬ ì¤‘..."
            mkdir -p front/frontend/android/app/build/outputs/apk
            cp -r android_build/app/build/outputs/apk/* front/frontend/android/app/build/outputs/apk/ || true
          fi
          
          echo "===================================================="
        '''
      }
    }

    stage('Archive APK') {
      when { expression { env.BUILD_FRONTEND == 'true' } }
      steps {
        sh '''
          echo "===================================================="
          echo "ğŸ“¦ APK ì•„ì¹´ì´ë¸Œ ì‹œì‘"
          echo "===================================================="
          
          # APK íŒŒì¼ ì¡´ì¬ í™•ì¸ (android_build ë””ë ‰í† ë¦¬ë„ í™•ì¸)
          find android_build -name "*.apk" 2>/dev/null || echo "android_buildì—ì„œ APKë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          find front/frontend/android -name "*.apk" 2>/dev/null || echo "front/frontend/androidì—ì„œ APKë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          
          # ëª¨ë“  APK íŒŒì¼ ì¶œë ¥
          echo "ğŸ“± ëª¨ë“  APK íŒŒì¼ ëª©ë¡:"
          find . -name "*.apk" 2>/dev/null || echo "APK íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          
          # APK íŒŒì¼ ìˆ˜ ê³„ì‚°
          APK_COUNT=$(find . -name "*.apk" 2>/dev/null | wc -l || echo 0)
          
          if [ "$APK_COUNT" -gt 0 ]; then
            echo "âœ… $APK_COUNT ê°œì˜ APK íŒŒì¼ ë°œê²¬"
          else
            echo "âŒ APK íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          fi
          
          echo "===================================================="
        '''
        
        archiveArtifacts artifacts: '**/app/build/outputs/**/*.apk', fingerprint: true, allowEmptyArchive: true
      }
    }
  }

  post {
    always {
      sh '''
        echo "===================================================="
        echo "ğŸ§¹ ì‘ì—… ê³µê°„ ì •ë¦¬"
        echo "===================================================="
        rm -rf android_build || true
      '''
      cleanWs()
    }
    success {
      sh '''
        echo "===================================================="
        echo "âœ… Frontend CI/CD ì„±ê³µ ğŸ‰"
        echo "===================================================="
      '''
    }
    failure {
      sh '''
        echo "===================================================="
        echo "âŒ Frontend CI/CD ì‹¤íŒ¨ â—"
        echo "===================================================="
      '''
    }
  }
}