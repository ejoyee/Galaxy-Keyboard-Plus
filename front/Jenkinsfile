pipeline {
Â  agent any

Â  environment {
Â  Â  // Firebase ë°°í¬ ì •ë³´
Â  Â  FIREBASE_TOKEN Â  = credentials('FIREBASE_TOKEN')
Â  Â  FIREBASE_APP_ID Â = '1:189536895445:android:783ed885fd7c4b896bfd5c'
Â  Â  // í‚¤ìŠ¤í† ì–´ ê´€ë ¨ ì„¤ì •
Â  Â  KEYSTORE_PASSWORD = credentials('KEYSTORE_PASSWORD')
Â  Â  KEY_ALIAS Â  Â  Â  Â = credentials('KEY_ALIAS')
Â  Â  KEY_PASSWORD Â  Â  = credentials('KEY_PASSWORD')
Â  Â  // CircleCI Android ì´ë¯¸ì§€ ì‚¬ìš©
Â  Â  DOCKER_IMAGE Â  Â  = 'cimg/android:2023.08'
Â  Â  // ì‘ì—… ë””ë ‰í† ë¦¬ ë³€ìˆ˜ ì¶”ê°€ (Jenkins ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë‚´ ì„ì‹œ ë””ë ‰í† ë¦¬)
Â  Â  WORK_DIR Â  Â  Â  Â  = "${WORKSPACE}/workspace"
Â  }

Â  stages {
Â  Â  stage('Checkout') {
Â  Â  Â  steps {
Â  Â  Â  Â  checkout scm

Â  Â  Â  Â  // ë¹Œë“œ ì‹œì‘ ë¡œê·¸
Â  Â  Â  Â  sh '''
Â  Â  Â  Â  Â  echo "===================================================="
Â  Â  Â  Â  Â  echo "ğŸš€ ë¹Œë“œ ì‹œì‘: $(date '+%Y-%m-%d %H:%M:%S')"
Â  Â  Â  Â  Â  echo "ğŸ” ë¹Œë“œ ID: ${BUILD_ID}"
Â  Â  Â  Â  Â  echo "ğŸ” Git ì»¤ë°‹: ${GIT_COMMIT}"
Â  Â  Â  Â  Â  echo "ğŸ” ë¸Œëœì¹˜: ${GIT_BRANCH}"
Â  Â  Â  Â  Â  echo "ğŸ” ì‘ì—… ë””ë ‰í† ë¦¬: ${WORKSPACE}"
Â  Â  Â  Â  Â  echo "===================================================="
Â  Â  Â  Â  '''
Â  Â  Â  }
Â  Â  }

Â  Â  stage('Check Docker Image') {
Â  Â  Â  steps {
Â  Â  Â  Â  sh '''
Â  Â  Â  Â  Â  echo "===================================================="
Â  Â  Â  Â  Â  echo "ğŸ” Docker ì´ë¯¸ì§€ í™•ì¸"
Â  Â  Â  Â  Â  echo "===================================================="

Â  Â  Â  Â  Â  # Docker ì´ë¯¸ì§€ í™•ì¸
Â  Â  Â  Â  Â  if docker image inspect ${DOCKER_IMAGE} >/dev/null 2>&1; then
Â  Â  Â  Â  Â  Â  echo "âœ… Docker ì´ë¯¸ì§€ ${DOCKER_IMAGE}ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤."
Â  Â  Â  Â  Â  else
Â  Â  Â  Â  Â  Â  echo "ğŸ”„ Docker ì´ë¯¸ì§€ ${DOCKER_IMAGE}ë¥¼ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤."
Â  Â  Â  Â  Â  Â  docker pull ${DOCKER_IMAGE} || {
Â  Â  Â  Â  Â  Â  Â  echo "âŒ Docker ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨! ì‚¬ìš© ê°€ëŠ¥í•œ ì´ë¯¸ì§€ì¸ì§€ í™•ì¸í•˜ì„¸ìš”."
Â  Â  Â  Â  Â  Â  Â  exit 1
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  fi

Â  Â  Â  Â  Â  echo "===================================================="
Â  Â  Â  Â  '''
Â  Â  Â  }
Â  Â  }

Â  Â  stage('Prepare Build Environment') {
Â  Â  Â  steps {
Â  Â  Â  Â  sh '''
Â  Â  Â  Â  Â  echo "===================================================="
Â  Â  Â  Â  Â  echo "ğŸ”§ ë¹Œë“œ í™˜ê²½ ì¤€ë¹„ (Jenkins ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë‚´ ì„ì‹œ ë””ë ‰í† ë¦¬ ${WORK_DIR})"
Â  Â  Â  Â  Â  echo "===================================================="

Â  Â  Â  Â  Â  # ì„ì‹œ ì‘ì—… ë””ë ‰í† ë¦¬ ìƒì„± (ì „ì²´ ê²½ë¡œ ì‚¬ìš©)
Â  Â  Â  Â  Â  rm -rf ${WORK_DIR}
Â  Â  Â  Â  Â  mkdir -p ${WORK_DIR}

Â  Â  Â  Â  Â  # ë””ë²„ê¹…: ì›ë³¸ ë””ë ‰í† ë¦¬ êµ¬ì¡° í™•ì¸
Â  Â  Â  Â  Â  echo "ğŸ“‚ ì›ë³¸ frontend ë””ë ‰í† ë¦¬ êµ¬ì¡°:"
Â  Â  Â  Â  Â  ls -la front/frontend/ || echo "front/frontend ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."

Â  Â  Â  Â  Â  # í”„ë¡œì íŠ¸ íŒŒì¼ ë³µì‚¬ (ëª¨ë“  íŒŒì¼ì„ ë³µì‚¬í•˜ê¸° ìœ„í•´ ./* ì‚¬ìš©)
Â  Â  Â  Â  Â  echo "ğŸ“‚ í”„ë¡œì íŠ¸ íŒŒì¼ ë³µì‚¬ ì¤‘..."
Â  Â  Â  Â  Â  cp -a front/frontend/. ${WORK_DIR}/ || { echo "âŒ í”„ë¡œì íŠ¸ íŒŒì¼ ë³µì‚¬ ì‹¤íŒ¨!"; exit 1; }
Â  Â  Â  Â  Â  echo "âœ… í”„ë¡œì íŠ¸ íŒŒì¼ ë³µì‚¬ ì™„ë£Œ."

Â  Â  Â  Â  Â  # íŒŒì¼ ëª©ë¡ í™•ì¸ (ë” ìì„¸í•œ ë¡œê¹…)
Â  Â  Â  Â  Â  echo "ğŸ“‚ ë³µì‚¬ëœ íŒŒì¼ í™•ì¸ (${WORK_DIR}):"
Â  Â  Â  Â  Â  ls -la ${WORK_DIR}

Â  Â  Â  Â  Â  # package.json í™•ì¸
Â  Â  Â  Â  Â  echo "ğŸ“„ ${WORK_DIR}/package.json í™•ì¸:"
Â  Â  Â  Â  Â  cat ${WORK_DIR}/package.json | head -20 || echo "package.json íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"

Â  Â  Â  Â  Â  # ê¶Œí•œ ì„¤ì • (ëª¨ë“  ì‚¬ìš©ìê°€ ì½ê³  ì“¸ ìˆ˜ ìˆë„ë¡ - Docker ë§ˆìš´íŠ¸ ì‹œ ê¶Œí•œ ë¬¸ì œ ë°©ì§€)
Â  Â  Â  Â  Â  echo "ğŸ”§ ê¶Œí•œ ì„¤ì • ì¤‘ (chmod -R 777)..."
Â  Â  Â  Â  Â  chmod -R 777 ${WORK_DIR} || { echo "âŒ ê¶Œí•œ ì„¤ì • ì‹¤íŒ¨!"; exit 1; }
Â  Â  Â  Â  Â  echo "âœ… ê¶Œí•œ ì„¤ì • ì™„ë£Œ."

Â  Â  Â  Â  Â  # íŒŒì¼ ê¶Œí•œ í™•ì¸
Â  Â  Â  Â  Â  echo "ğŸ“„ ì¤‘ìš” íŒŒì¼ ê¶Œí•œ í™•ì¸ (${WORK_DIR}/package.json):"
Â  Â  Â  Â  Â  ls -la ${WORK_DIR}/package.json || echo "package.json íŒŒì¼ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"

Â  Â  Â  Â  Â  echo "===================================================="
Â  Â  Â  Â  '''
Â  Â  Â  }
Â  Â  }

Â  Â  stage('Prepare Secret Files') {
Â  Â  Â  steps {
Â  Â  Â  Â  withCredentials([
Â  Â  Â  Â  Â  file(credentialsId: 'android-release-keystore', variable: 'KEYSTORE_FILE'),
Â  Â  Â  Â  Â  file(credentialsId: 'google-services-json', variable: 'GOOGLE_SERVICES_JSON'),
Â  Â  Â  Â  Â  file(credentialsId: 'firebase-service-account', variable: 'FIREBASE_SERVICE_ACCOUNT')
Â  Â  Â  Â  ]) {
Â  Â  Â  Â  Â  sh '''
Â  Â  Â  Â  Â  Â  echo "===================================================="
Â  Â  Â  Â  Â  Â  echo "ğŸ” ì‹œí¬ë¦¿ íŒŒì¼ ì¤€ë¹„ (${WORK_DIR} ë‚´ë¶€)"
Â  Â  Â  Â  Â  Â  echo "===================================================="

Â  Â  Â  Â  Â  Â  # í•„ìš”í•œ ë””ë ‰í† ë¦¬ ìƒì„±
Â  Â  Â  Â  Â  Â  mkdir -p ${WORK_DIR}/android/app/keystore || { echo "âŒ keystore ë””ë ‰í† ë¦¬ ìƒì„± ì‹¤íŒ¨!"; exit 1; }
Â  Â  Â  Â  Â  Â  mkdir -p ${WORK_DIR}/android || { echo "âŒ android ë””ë ‰í† ë¦¬ ìƒì„± ì‹¤íŒ¨!"; exit 1; } # firebase_service_account.json ìœ„ì¹˜

Â  Â  Â  Â  Â  Â  # ì‹œí¬ë¦¿ íŒŒì¼ ë³µì‚¬
Â  Â  Â  Â  Â  Â  echo "ğŸ“„ firebase_service_account.json ë³µì‚¬ ì¤‘..."
Â  Â  Â  Â  Â  Â  cp "$FIREBASE_SERVICE_ACCOUNT" ${WORK_DIR}/android/firebase_service_account.json || { echo "âŒ firebase_service_account.json ë³µì‚¬ ì‹¤íŒ¨!"; exit 1; }
Â  Â  Â  Â  Â  Â  echo "ğŸ“„ google-services.json ë³µì‚¬ ì¤‘..."
Â  Â  Â  Â  Â  Â  cp "$GOOGLE_SERVICES_JSON" ${WORK_DIR}/android/app/google-services.json || { echo "âŒ google-services.json ë³µì‚¬ ì‹¤íŒ¨!"; exit 1; }
Â  Â  Â  Â  Â  Â  echo "ğŸ“„ release.keystore ë³µì‚¬ ì¤‘..."
Â  Â  Â  Â  Â  Â  cp "$KEYSTORE_FILE" ${WORK_DIR}/android/app/keystore/release.keystore || { echo "âŒ release.keystore ë³µì‚¬ ì‹¤íŒ¨!"; exit 1; }
Â  Â  Â  Â  Â  Â  echo "âœ… ì‹œí¬ë¦¿ íŒŒì¼ ë³µì‚¬ ì™„ë£Œ."

Â  Â  Â  Â  Â  Â  # ê¶Œí•œ ì„¤ì • (Docker ì»¨í…Œì´ë„ˆì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡)
Â  Â  Â  Â  Â  Â  echo "ğŸ”§ ì‹œí¬ë¦¿ íŒŒì¼ ê¶Œí•œ ì„¤ì • ì¤‘..."
Â  Â  Â  Â  Â  Â  chmod -R 777 ${WORK_DIR}/android/app/keystore || true # ì—ëŸ¬ ë¬´ì‹œ
Â  Â  Â  Â  Â  Â  chmod 666 ${WORK_DIR}/android/firebase_service_account.json || true
Â  Â  Â  Â  Â  Â  chmod 666 ${WORK_DIR}/android/app/google-services.json || true
Â  Â  Â  Â  Â  Â  chmod 666 ${WORK_DIR}/android/app/keystore/release.keystore || true
Â  Â  Â  Â  Â  Â  echo "âœ… ì‹œí¬ë¦¿ íŒŒì¼ ê¶Œí•œ ì„¤ì • ì™„ë£Œ."

Â  Â  Â  Â  Â  Â  # ë³µì‚¬ëœ íŒŒì¼ ì¡´ì¬ í™•ì¸ (ë””ë²„ê¹…)
Â  Â  Â  Â  Â  Â  echo "ğŸ“‚ ë³µì‚¬ëœ ì‹œí¬ë¦¿ íŒŒì¼ í™•ì¸:"
Â  Â  Â  Â  Â  Â  ls -la ${WORK_DIR}/android/firebase_service_account.json || echo "firebase_service_account.json ì—†ìŒ"
Â  Â  Â  Â  Â  Â  ls -la ${WORK_DIR}/android/app/google-services.json || echo "google-services.json ì—†ìŒ"
Â  Â  Â  Â  Â  Â  ls -la ${WORK_DIR}/android/app/keystore/release.keystore || echo "release.keystore ì—†ìŒ"


Â  Â  Â  Â  Â  Â  echo "===================================================="
Â  Â  Â  Â  Â  '''
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }

Â  Â  stage('Debug File System') {
Â  Â  Â  steps {
Â  Â  Â  Â  sh '''
Â  Â  Â  Â  Â  echo "===================================================="
Â  Â  Â  Â  Â  echo "ğŸ” íŒŒì¼ ì‹œìŠ¤í…œ ë””ë²„ê¹… (Jenkins ì›Œí¬ìŠ¤í˜ì´ìŠ¤)"
Â  Â  Â  Â  Â  echo "===================================================="

Â  Â  Â  Â  Â  # í˜„ì¬ ë””ë ‰í† ë¦¬ ë° ì‘ì—… ë””ë ‰í† ë¦¬ í™•ì¸
Â  Â  Â  Â  Â  echo "ğŸ“‚ í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
Â  Â  Â  Â  Â  echo "ğŸ“‚ ì‘ì—… ë””ë ‰í† ë¦¬: ${WORK_DIR}"

Â  Â  Â  Â  Â  # ì‘ì—… ë””ë ‰í† ë¦¬ ë‚´ìš© í™•ì¸
Â  Â  Â  Â  Â  echo "ğŸ“„ ì‘ì—… ë””ë ‰í† ë¦¬ ë‚´ìš© (${WORK_DIR}):"
Â  Â  Â  Â  Â  ls -la ${WORK_DIR}

Â  Â  Â  Â  Â  # package.json íŒŒì¼ ì‹œìŠ¤í…œ ì •ë³´ í™•ì¸
Â  Â  Â  Â  Â  echo "ğŸ“„ ${WORK_DIR}/package.json íŒŒì¼ ì‹œìŠ¤í…œ ì •ë³´:"
Â  Â  Â  Â  Â  stat ${WORK_DIR}/package.json || echo "package.json íŒŒì¼ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"

Â  Â  Â  Â  Â  # Docker ì •ë³´ í™•ì¸
Â  Â  Â  Â  Â  echo "ğŸ³ Docker ë²„ì „:"
Â  Â  Â  Â  Â  docker --version || echo "Docker ë²„ì „ í™•ì¸ ë¶ˆê°€"

Â  Â  Â  Â  Â  # SELinux ìƒíƒœ í™•ì¸ (ë³¼ë¥¨ ë§ˆìš´íŠ¸ì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆìŒ)
Â  Â  Â  Â  Â  echo "ğŸ”’ SELinux ìƒíƒœ:"
Â  Â  Â  Â  Â  getenforce 2>/dev/null || echo "SELinux ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"

Â  Â  Â  Â  Â  # Docker í˜¸ìŠ¤íŠ¸ ì •ë³´ í™•ì¸
Â  Â  Â  Â  Â  echo "ğŸ³ Docker í˜¸ìŠ¤íŠ¸ ì •ë³´:"
Â  Â  Â  Â  Â  docker info | grep -E "Storage Driver|Root Dir" || echo "Docker í˜¸ìŠ¤íŠ¸ ì •ë³´ í™•ì¸ ë¶ˆê°€"

Â  Â  Â  Â  Â  echo "===================================================="

Â  Â  Â  Â  Â  # ì‘ì—… ë””ë ‰í† ë¦¬ë¥¼ ì•„ì¹´ì´ë¸Œë¡œ ë§Œë“¤ì–´ Dockerì—ì„œ ì¶”ì¶œí•˜ëŠ” ëŒ€ì•ˆ í…ŒìŠ¤íŠ¸
Â  Â  Â  Â  Â  echo "ğŸ“¦ ì‘ì—… ë””ë ‰í† ë¦¬ ì•„ì¹´ì´ë¸Œ ìƒì„± (${WORKSPACE}/workspace.tar.gz)"
Â  Â  Â  Â  Â  tar -czf ${WORKSPACE}/workspace.tar.gz -C ${WORK_DIR} . || { echo "âŒ ì•„ì¹´ì´ë¸Œ ìƒì„± ì‹¤íŒ¨!"; exit 1; }
Â  Â  Â  Â  Â  echo "âœ… ì‘ì—… ë””ë ‰í† ë¦¬ ì•„ì¹´ì´ë¸Œ ìƒì„± ì™„ë£Œ."

Â  Â  Â  Â  Â  echo "===================================================="
Â  Â  Â  Â  '''
Â  Â  Â  }
Â  Â  }

Â  Â  stage('Docker Volume Test') {
Â  Â  Â  steps {
Â  Â  Â  Â  sh '''
Â  Â  Â  Â  Â  echo "===================================================="
Â  Â  Â  Â  Â  echo "ğŸ” Docker ë³¼ë¥¨ ë§ˆìš´íŠ¸ í…ŒìŠ¤íŠ¸ (ë‹¤ì–‘í•œ ë°©ë²• ì‹œë„ - ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ê²½ë¡œ /tmp/project)"
Â  Â  Â  Â  Â  echo "===================================================="

Â  Â  Â  Â  Â  # ë°©ë²• 1: ì¼ë°˜ ë³¼ë¥¨ ë§ˆìš´íŠ¸ - ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ê¶Œí•œ ë¬¸ì œë¡œ ì‹¤íŒ¨ ì˜ˆìƒ
Â  Â  Â  Â  Â  echo "ğŸ” ë°©ë²• 1: ì¼ë°˜ ë³¼ë¥¨ ë§ˆìš´íŠ¸ í…ŒìŠ¤íŠ¸..."
Â  Â  Â  Â  Â  docker run --rm \\
Â  Â  Â  Â  Â  Â  -v "${WORK_DIR}:/project" \\
Â  Â  Â  Â  Â  Â  --workdir /project \\
Â  Â  Â  Â  Â  Â  ${DOCKER_IMAGE} \\
Â  Â  Â  Â  Â  Â  bash -c "ls -la && (cat package.json | head -5 || echo 'package.json íŒŒì¼ ì—†ìŒ')" || echo "â¡ï¸ ë°©ë²• 1 ì‹¤íŒ¨ (ì˜ˆìƒëŒ€ë¡œ ê¶Œí•œ ë¬¸ì œ ë°œìƒ ê°€ëŠ¥)"

Â  Â  Â  Â  Â  # ë°©ë²• 2: íŒŒì¼ ê²½ë¡œì— ë”°ì˜´í‘œ ì¶”ê°€ - ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ê¶Œí•œ ë¬¸ì œë¡œ ì‹¤íŒ¨ ì˜ˆìƒ
Â  Â  Â  Â  Â  echo "ğŸ” ë°©ë²• 2: íŒŒì¼ ê²½ë¡œì— ë”°ì˜´í‘œ ì¶”ê°€ í…ŒìŠ¤íŠ¸..."
Â  Â  Â  Â  Â  docker run --rm \\
Â  Â  Â  Â  Â  Â  -v "${WORK_DIR}":/project \\
Â  Â  Â  Â  Â  Â  --workdir /project \\
Â  Â  Â  Â  Â  Â  ${DOCKER_IMAGE} \\
Â  Â  Â  Â  Â  Â  bash -c "ls -la && (cat package.json | head -5 || echo 'package.json íŒŒì¼ ì—†ìŒ')" || echo "â¡ï¸ ë°©ë²• 2 ì‹¤íŒ¨ (ì˜ˆìƒëŒ€ë¡œ ê¶Œí•œ ë¬¸ì œ ë°œìƒ ê°€ëŠ¥)"

Â  Â  Â  Â  Â  # ë°©ë²• 3: ì•„ì¹´ì´ë¸Œ ì¶”ì¶œ ë°©ì‹ - ê²½ë¡œë¥¼ /tmp/projectë¡œ ë³€ê²½ (ì„±ê³µ ê¸°ëŒ€)
Â  Â  Â  Â  Â  echo "ğŸ” ë°©ë²• 3: ì•„ì¹´ì´ë¸Œ ì¶”ì¶œ ë°©ì‹ í…ŒìŠ¤íŠ¸ (ê²½ë¡œ /tmp/project)..."
Â  Â  Â  Â  Â  docker run --rm \\
Â  Â  Â  Â  Â  Â  -v "${WORKSPACE}/workspace.tar.gz:/workspace.tar.gz" \\
Â  Â  Â  Â  Â  Â  ${DOCKER_IMAGE} \\
Â  Â  Â  Â  Â  Â  bash -c '
Â  Â  Â  Â  Â  Â  Â  set -e # ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨

Â  Â  Â  Â  Â  Â  Â  echo "--- ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ì •ë³´ ---"
Â  Â  Â  Â  Â  Â  Â  whoami Â  Â  # í˜„ì¬ ì‚¬ìš©ì í™•ì¸
Â  Â  Â  Â  Â  Â  Â  pwd Â  Â  Â  # í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬ í™•ì¸
Â  Â  Â  Â  Â  Â  Â  ls -la / Â # ë£¨íŠ¸ ë””ë ‰í† ë¦¬ ê¶Œí•œ í™•ì¸
              ls -la /tmp # /tmp ë””ë ‰í† ë¦¬ ê¶Œí•œ í™•ì¸
Â  Â  Â  Â  Â  Â  Â  echo "-------------------------"

Â  Â  Â  Â  Â  Â  Â  # /tmp ì•„ë˜ì— í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ìƒì„± ë° ì••ì¶• í•´ì œ
Â  Â  Â  Â  Â  Â  Â  echo "ğŸ“¦ ì•„ì¹´ì´ë¸Œ ì¶”ì¶œ ì¤‘... ëŒ€ìƒ: /tmp/project"
Â  Â  Â  Â  Â  Â  Â  mkdir -p /tmp/project
Â  Â  Â  Â  Â  Â  Â  tar -xzf /workspace.tar.gz -C /tmp/project
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  # ì¶”ì¶œëœ íŒŒì¼ í™•ì¸
Â  Â  Â  Â  Â  Â  Â  echo "ğŸ“‚ ì¶”ì¶œëœ íŒŒì¼ í™•ì¸ (/tmp/project):"
Â  Â  Â  Â  Â  Â  Â  cd /tmp/project
Â  Â  Â  Â  Â  Â  Â  ls -la
Â  Â  Â  Â  Â  Â  Â  echo "ğŸ“„ /tmp/project/package.json í™•ì¸:"
Â  Â  Â  Â  Â  Â  Â  cat package.json | head -5 || echo "package.json íŒŒì¼ ì—†ìŒ"
Â  Â  Â  Â  Â  Â  '
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  echo "===================================================="
Â  Â  Â  Â  '''
Â  Â  Â  }
Â  Â  }

Â  Â  stage('Build in Docker (Using Archive Method)') {
Â  Â  Â  steps {
Â  Â  Â  Â  sh '''
Â  Â  Â  Â  Â  echo "===================================================="
Â  Â  Â  Â  Â  echo "ğŸš€ Docker ë‚´ë¶€ì—ì„œ ë¹Œë“œ ì‹¤í–‰ (ì•„ì¹´ì´ë¸Œ ë°©ì‹, ê²½ë¡œ /tmp/project)"
Â  Â  Â  Â  Â  echo "===================================================="

Â  Â  Â  Â  Â  # Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰
Â  Â  Â  Â  Â  # /workspace.tar.gz: Jenkinsì—ì„œ ìƒì„±í•œ ì•„ì¹´ì´ë¸Œë¥¼ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ë¡œ ë§ˆìš´íŠ¸
Â  Â  Â  Â  Â  # /output: ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ë¹Œë“œ ê²°ê³¼ë¬¼ì„ Jenkins ì›Œí¬ìŠ¤í˜ì´ìŠ¤ì˜ /apk ë””ë ‰í† ë¦¬ë¡œ ë§ˆìš´íŠ¸
Â  Â  Â  Â  Â  docker run --rm \\
Â  Â  Â  Â  Â  Â  -v "${WORKSPACE}/workspace.tar.gz:/workspace.tar.gz" \\
Â  Â  Â  Â  Â  Â  -v "${WORKSPACE}/apk:/output" \\
Â  Â  Â  Â  Â  Â  ${DOCKER_IMAGE} \\
Â  Â  Â  Â  Â  Â  bash -c '
Â  Â  Â  Â  Â  Â  Â  set -e Â # ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨

Â  Â  Â  Â  Â  Â  Â  echo "--- ë¹Œë“œ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ì„¤ì • ---"
Â  Â  Â  Â  Â  Â  Â  whoami # ì‹¤í–‰ ì‚¬ìš©ì í™•ì¸
              pwd # í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬ í™•ì¸
              ls -la /tmp # /tmp ê¶Œí•œ í™•ì¸
              echo "---------------------------"

Â  Â  Â  Â  Â  Â  Â  # ì‘ì—… ë””ë ‰í† ë¦¬ ì¤€ë¹„ (/tmp ì•„ë˜ì— ìƒì„±)
Â  Â  Â  Â  Â  Â  Â  echo "ğŸ“¦ ì‘ì—… ë””ë ‰í† ë¦¬ ì¤€ë¹„ ì¤‘... ëŒ€ìƒ: /tmp/project"
Â  Â  Â  Â  Â  Â  Â  mkdir -p /tmp/project
Â  Â  Â  Â  Â  Â  Â  tar -xzf /workspace.tar.gz -C /tmp/project
Â  Â  Â  Â  Â  Â  Â  cd /tmp/project
Â  Â  Â  Â  Â  Â  Â  echo "âœ… ì‘ì—… ë””ë ‰í† ë¦¬ ì¤€ë¹„ ì™„ë£Œ: $(pwd)"
Â  Â  Â  Â  Â  Â  Â  ls -la # ë””ë²„ê¹…: ë³µì‚¬ëœ íŒŒì¼ í™•ì¸

Â  Â  Â  Â  Â  Â  Â  echo "ğŸ“¦ Node.js ì¢…ì†ì„± ì„¤ì¹˜ ì¤‘..."
Â  Â  Â  Â  Â  Â  Â  if [ ! -f "package.json" ]; then
Â  Â  Â  Â  Â  Â  Â  Â  echo "âŒ package.json íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤! í˜„ì¬ ìœ„ì¹˜: $(pwd)"
Â  Â  Â  Â  Â  Â  Â  Â  ls -la
Â  Â  Â  Â  Â  Â  Â  Â  exit 1
Â  Â  Â  Â  Â  Â  Â  fi
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  # Node.js ë²„ì „ í™•ì¸ (ì„ íƒ ì‚¬í•­)
Â  Â  Â  Â  Â  Â  Â  echo "Node.js ë²„ì „: $(node --version 2>/dev/null || echo 'Node.jsê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤')"
Â  Â  Â  Â  Â  Â  Â  echo "npm ë²„ì „: $(npm --version 2>/dev/null || echo 'npmì´ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤')"
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  npm install || { echo "âŒ npm install ì‹¤íŒ¨!"; exit 1; }
Â  Â  Â  Â  Â  Â  Â  echo "âœ… Node.js ì¢…ì†ì„± ì„¤ì¹˜ ì™„ë£Œ."

Â  Â  Â  Â  Â  Â  Â  echo "ğŸ“‚ node_modules ì„¤ì¹˜ í™•ì¸"
Â  Â  Â  Â  Â  Â  Â  ls -la node_modules/@react-native 2>/dev/null || echo "React Native ëª¨ë“ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (node_modules/@react-native)"

Â  Â  Â  Â  Â  Â  Â  echo "ğŸ”§ Android ë¹Œë“œ ì¤€ë¹„ ì¤‘..."
Â  Â  Â  Â  Â  Â  Â  if [ ! -d "android" ]; then
Â  Â  Â  Â  Â  Â  Â  Â  echo "âŒ android ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤! í˜„ì¬ ìœ„ì¹˜: $(pwd)"
Â  Â  Â  Â  Â  Â  Â  Â  ls -la
Â  Â  Â  Â  Â  Â  Â  Â  exit 1
Â  Â  Â  Â  Â  Â  Â  fi
Â  Â  Â  Â  Â  Â  Â  cd android || { echo "âŒ android ë””ë ‰í† ë¦¬ë¡œ ì´ë™ ì‹¤íŒ¨!"; exit 1; }
Â  Â  Â  Â  Â  Â  Â  chmod +x ./gradlew || { echo "âŒ gradlew ì‹¤í–‰ ê¶Œí•œ ì„¤ì • ì‹¤íŒ¨!"; exit 1; }
Â  Â  Â  Â  Â  Â  Â  echo "âœ… Android ë¹Œë“œ ì¤€ë¹„ ì™„ë£Œ: $(pwd)"

Â  Â  Â  Â  Â  Â  Â  echo "ğŸ”§ local.properties ìƒì„± ì¤‘..."
Â  Â  Â  Â  Â  Â  Â  # $ANDROID_HOME ë³€ìˆ˜ëŠ” cimg/android ì´ë¯¸ì§€ì— ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
Â  Â  Â  Â  Â  Â  Â  echo "sdk.dir=$ANDROID_HOME" > local.properties || { echo "âŒ local.properties ìƒì„± ì‹¤íŒ¨!"; exit 1; }
Â  Â  Â  Â  Â  Â  Â  echo "âœ… local.properties ìƒì„± ì™„ë£Œ."

Â  Â  Â  Â  Â  Â  Â  echo "ğŸ”§ Gradle í”„ë¡œí¼í‹° ì„¤ì • ì¤‘..."
Â  Â  Â  Â  Â  Â  Â  # ë”°ì˜´í‘œ ì²˜ë¦¬ì— ë” ì•ˆì „í•œ ë°©ì‹ ì‚¬ìš©
Â  Â  Â  Â  Â  Â  Â  echo "KEYSTORE_PASSWORD=\'${KEYSTORE_PASSWORD}\'" >> gradle.properties
Â  Â  Â  Â  Â  Â  Â  echo "KEY_ALIAS=\'${KEY_ALIAS}\'" >> gradle.properties
Â  Â  Â  Â  Â  Â  Â  echo "KEY_PASSWORD=\'${KEY_PASSWORD}\'" >> gradle.properties
              # Release ë¹Œë“œë¥¼ ìœ„í•œ signingConfig ì •ë³´ ì¶”ê°€ (í•„ìš”ì‹œ)
              # build.gradle (:app) íŒŒì¼ì— signingConfig ì„¤ì •ì´ ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
              # ì˜ˆì‹œ:
              # android {
              # Â Â signingConfigs {
              # Â Â Â Â release {
              # Â Â Â Â Â Â if (project.hasProperty('MYAPP_UPLOAD_STORE_FILE')) {
              # Â Â Â Â Â Â Â Â storeFile file(project.property('MYAPP_UPLOAD_STORE_FILE'))
              # Â Â Â Â Â Â Â Â storePassword project.property('MYAPP_UPLOAD_STORE_PASSWORD')
              # Â Â Â Â Â Â Â Â keyAlias project.property('MYAPP_UPLOAD_KEY_ALIAS')
              # Â Â Â Â Â Â Â Â keyPassword project.property('MYAPP_UPLOAD_KEY_PASSWORD')
              # Â Â Â Â Â Â }
              # Â Â Â Â }
              # Â Â }
              # Â Â buildTypes {
              # Â Â Â Â release {
              # Â Â Â Â Â Â signingConfig signingConfigs.release
              # Â Â Â Â Â Â ...
              # Â Â Â Â }
              # Â Â }
              # }
              # gradle.propertiesì— ë‹¤ìŒì„ ì¶”ê°€í•´ì•¼ í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤ (í”„ë¡œì íŠ¸ ì„¤ì •ì— ë”°ë¼ ë‹¤ë¦„)
              # echo "MYAPP_UPLOAD_STORE_FILE=../app/keystore/release.keystore" >> gradle.properties
              # echo "MYAPP_UPLOAD_STORE_PASSWORD=\'${KEYSTORE_PASSWORD}\'" >> gradle.properties
              # echo "MYAPP_UPLOAD_KEY_ALIAS=\'${KEY_ALIAS}\'" >> gradle.properties
              # echo "MYAPP_UPLOAD_KEY_PASSWORD=\'${KEY_PASSWORD}\'" >> gradle.properties

Â  Â  Â  Â  Â  Â  Â  echo "ğŸ“„ gradle.properties ë‚´ìš©:"
Â  Â  Â  Â  Â  Â  Â  cat gradle.properties || echo "gradle.properties íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              echo "âœ… Gradle í”„ë¡œí¼í‹° ì„¤ì • ì™„ë£Œ."

Â  Â  Â  Â  Â  Â  Â  echo "ğŸ”§ Gradle ë¹Œë“œ ì‹¤í–‰ (assembleRelease)..."
Â  Â  Â  Â  Â  Â  Â  # assembleReleaseëŠ” ì„œëª…ì„ í¬í•¨í•©ë‹ˆë‹¤.
Â  Â  Â  Â  Â  Â  Â  ./gradlew clean assembleRelease --stacktrace || { echo "âŒ Gradle ë¹Œë“œ ì‹¤íŒ¨!"; exit 1; }
Â  Â  Â  Â  Â  Â  Â  echo "âœ… Gradle ë¹Œë“œ ì„±ê³µ."

Â  Â  Â  Â  Â  Â  Â  echo "ğŸ”§ ë¹Œë“œ ê²°ê³¼ (APK/AAB) í™•ì¸ ë° ë³µì‚¬ ì¤‘..."
Â  Â  Â  Â  Â  Â  Â  mkdir -p /output || { echo "âŒ /output ë””ë ‰í† ë¦¬ ìƒì„± ì‹¤íŒ¨!"; exit 1; } # Jenkins ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë§ˆìš´íŠ¸ ì§€ì 
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  # ë¹Œë“œëœ APK ë˜ëŠ” AAB íŒŒì¼ì„ ì°¾ì•„ /outputìœ¼ë¡œ ë³µì‚¬
Â  Â  Â  Â  Â  Â  Â  find . -name "*.apk" -print -exec cp {} /output/ ";" || echo "APK íŒŒì¼ ë³µì‚¬ ì‹¤íŒ¨ ë˜ëŠ” ì°¾ì§€ ëª»í•¨"
              find . -name "*.aab" -print -exec cp {} /output/ ";" || echo "AAB íŒŒì¼ ë³µì‚¬ ì‹¤íŒ¨ ë˜ëŠ” ì°¾ì§€ ëª»í•¨"
Â  Â  Â  Â  Â  Â  Â  echo "âœ… ë¹Œë“œ ê²°ê³¼ ë³µì‚¬ ì™„ë£Œ."
Â  Â  Â  Â  Â  Â  '
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  # Jenkins ì›Œí¬ìŠ¤í˜ì´ìŠ¤ì—ì„œ Dockerê°€ ë³µì‚¬í•œ APK/AAB íŒŒì¼ì„ ì•„ì¹´ì´ë¸Œ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
Â  Â  Â  Â  Â  echo "ğŸ“¦ Jenkins ì›Œí¬ìŠ¤í˜ì´ìŠ¤ì—ì„œ ë¹Œë“œ ê²°ê³¼ ì •ë¦¬ ë° ì•„ì¹´ì´ë¸Œ ì¤€ë¹„ ì¤‘..."
Â  Â  Â  Â  Â  mkdir -p apk-archive || { echo "âŒ Jenkins ì›Œí¬ìŠ¤í˜ì´ìŠ¤ apk-archive ìƒì„± ì‹¤íŒ¨!"; exit 1; }
Â  Â  Â  Â  Â  # Dockerì˜ /outputì— ë³µì‚¬ëœ íŒŒì¼ë“¤ì€ Jenkins ì›Œí¬ìŠ¤í˜ì´ìŠ¤ì˜ ${WORKSPACE}/apk ì— ìˆìŠµë‹ˆë‹¤.
Â  Â  Â  Â  Â  find ${WORKSPACE}/apk -name "*.apk" -o -name "*.aab" -exec mv {} apk-archive/ ";" || echo "APK/AAB íŒŒì¼ ì´ë™ ì‹¤íŒ¨ ë˜ëŠ” ì—†ìŒ"
Â  Â  Â  Â  Â  echo "âœ… ë¹Œë“œ ê²°ê³¼ ì •ë¦¬ ë° ì•„ì¹´ì´ë¸Œ ì¤€ë¹„ ì™„ë£Œ."

Â  Â  Â  Â  Â  # ì•„ì¹´ì´ë¸Œí•  íŒŒì¼ ëª©ë¡ ìµœì¢… í™•ì¸
Â  Â  Â  Â  Â  echo "ğŸ“Š ì•„ì¹´ì´ë¸Œí•  íŒŒì¼ ëª©ë¡ (./apk-archive/):"
Â  Â  Â  Â  Â  ls -la ./apk-archive/ || echo "./apk-archive/ ë””ë ‰í† ë¦¬ê°€ ì—†ê±°ë‚˜ ë¹„ì–´ìˆìŠµë‹ˆë‹¤."

Â  Â  Â  Â  Â  # ì•„ì¹´ì´ë¸Œí•  íŒŒì¼ ê°œìˆ˜ í™•ì¸
Â  Â  Â  Â  Â  ARTIFACT_COUNT=$(find apk-archive -name "*.apk" -o -name "*.aab" | wc -l)

Â  Â  Â  Â  Â  if [ "$ARTIFACT_COUNT" -gt 0 ]; then
Â  Â  Â  Â  Â  Â  echo "âœ… ì´ $ARTIFACT_COUNT ê°œì˜ ë¹Œë“œ ê²°ê³¼(APK/AAB)ê°€ ì•„ì¹´ì´ë¸Œë  ì˜ˆì •ì…ë‹ˆë‹¤."
Â  Â  Â  Â  Â  else
Â  Â  Â  Â  Â  Â  echo "âš ï¸ ì•„ì¹´ì´ë¸Œí•  ë¹Œë“œ ê²°ê³¼ íŒŒì¼(APK/AAB)ì´ ì—†ìŠµë‹ˆë‹¤."
Â  Â  Â  Â  Â  Â  # ë§Œì•½ íŒŒì¼ì´ ì—†ìœ¼ë©´ ë¹Œë“œ ì‹¤íŒ¨ë¡œ ì²˜ë¦¬í•˜ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ë¼ì¸ì˜ ì£¼ì„ì„ í•´ì œí•˜ì„¸ìš”.
Â  Â  Â  Â  Â  Â  # exit 1
Â  Â  Â  Â  Â  fi

Â  Â  Â  Â  Â  echo "===================================================="
Â  Â  Â  Â  '''

Â  Â  Â  Â  # ë¹Œë“œ ê²°ê³¼ ì•„ì¹´ì´ë¸Œ
Â  Â  Â  Â  archiveArtifacts artifacts: 'apk-archive/**', fingerprint: true, allowEmptyArchive: true
Â  Â  Â  }
Â  Â  }

Â  Â  stage('Deploy to Firebase') {
Â  Â  Â  steps {
Â  Â  Â  Â  withCredentials([
Â  Â  Â  Â  Â  string(credentialsId: 'FIREBASE_TOKEN', variable: 'FIREBASE_TOKEN')
Â  Â  Â  Â  ]) {
Â  Â  Â  Â  Â  sh '''
Â  Â  Â  Â  Â  Â  echo "===================================================="
Â  Â  Â  Â  Â  Â  echo "ğŸ”¥ Firebase ë°°í¬ ì¤‘..."
Â  Â  Â  Â  Â  Â  echo "===================================================="

Â  Â  Â  Â  Â  Â  # Jenkins ì›Œí¬ìŠ¤í˜ì´ìŠ¤ì˜ ì•„ì¹´ì´ë¸Œëœ APK/AAB íŒŒì¼ ì°¾ê¸°
Â  Â  Â  Â  Â  Â  # findëŠ” ì—¬ëŸ¬ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì²« ë²ˆì§¸ íŒŒì¼ì„ ì‚¬ìš©í•˜ê±°ë‚˜ íŠ¹ì • íŒŒì¼ì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.
Â  Â  Â  Â  Â  Â  # ì—¬ê¸°ì„œëŠ” ì¼ë‹¨ ì°¾ì€ ì²« ë²ˆì§¸ íŒŒì¼ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. í•„ìš”ì— ë”°ë¼ ìˆ˜ì •í•˜ì„¸ìš”.
Â  Â  Â  Â  Â  Â  APK_FILE=$(find "${WORKSPACE}/apk-archive" -name "*.apk" -o -name "*.aab" | head -1)

Â  Â  Â  Â  Â  Â  if [ -z "$APK_FILE" ]; then
Â  Â  Â  Â  Â  Â  Â  echo "âŒ ë°°í¬í•  APK/AAB íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ Firebase ë°°í¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
Â  Â  Â  Â  Â  Â  Â  exit 0 # ë°°í¬ ë‹¨ê³„ë§Œ ê±´ë„ˆë›°ê³  ì „ì²´ ë¹Œë“œëŠ” ì„±ê³µ ì²˜ë¦¬
Â  Â  Â  Â  Â  Â  fi

Â  Â  Â  Â  Â  Â  echo "âœ… ì—…ë¡œë“œí•  íŒŒì¼: $APK_FILE"

Â  Â  Â  Â  Â  Â  # Firebase ë°°í¬ ì‹¤í–‰ (docker run ë‚´ë¶€)
Â  Â  Â  Â  Â  Â  # ë°°í¬í•  íŒŒì¼ì„ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ë¡œ ë§ˆìš´íŠ¸í•©ë‹ˆë‹¤.
Â  Â  Â  Â  Â  Â  docker run --rm \\
Â  Â  Â  Â  Â  Â  Â  -v "${APK_FILE}:/app_artifact" \\ # ë°°í¬í•  íŒŒì¼ì„ /app_artifactë¡œ ë§ˆìš´íŠ¸
Â  Â  Â  Â  Â  Â  Â  -e FIREBASE_TOKEN="${FIREBASE_TOKEN}" \\
Â  Â  Â  Â  Â  Â  Â  -e FIREBASE_APP_ID="${FIREBASE_APP_ID}" \\
Â  Â  Â  Â  Â  Â  Â  # cimg/android ì´ë¯¸ì§€ì— npmì´ ìˆìœ¼ë¯€ë¡œ ê·¸ëŒ€ë¡œ ì‚¬ìš©
Â  Â  Â  Â  Â  Â  Â  ${DOCKER_IMAGE} \\
Â  Â  Â  Â  Â  Â  Â  bash -c '
Â  Â  Â  Â  Â  Â  Â  Â  set -e # ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨

Â  Â  Â  Â  Â  Â  Â  Â  echo "ğŸ”§ Firebase CLI ì„¤ì¹˜ ì¤‘..."
Â  Â  Â  Â  Â  Â  Â  Â  # ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆì„ ìˆ˜ë„ ìˆì§€ë§Œ ì•ˆì „í•˜ê²Œ ë‹¤ì‹œ ì„¤ì¹˜
Â  Â  Â  Â  Â  Â  Â  Â  npm install -g firebase-tools || { echo "âŒ Firebase CLI ì„¤ì¹˜ ì‹¤íŒ¨!"; exit 1; }
Â  Â  Â  Â  Â  Â  Â  Â  echo "âœ… Firebase CLI ì„¤ì¹˜ ì™„ë£Œ."

Â  Â  Â  Â  Â  Â  Â  Â  echo "ğŸ”¥ Firebase App Distribution ì‹¤í–‰ ì¤‘..."
Â  Â  Â  Â  Â  Â  Â  Â  # ë§ˆìš´íŠ¸ëœ íŒŒì¼ ê²½ë¡œ ì‚¬ìš© (/app_artifact)
Â  Â  Â  Â  Â  Â  Â  Â  # --groups ì˜µì…˜ì€ Firebase App Distribution í…ŒìŠ¤í„° ê·¸ë£¹ ì´ë¦„ì…ë‹ˆë‹¤.
Â  Â  Â  Â  Â  Â  Â  Â  # --release-notesëŠ” ë°°í¬ ì‹œ ì¶”ê°€í•  ë…¸íŠ¸ì…ë‹ˆë‹¤.
Â  Â  Â  Â  Â  Â  Â  Â  firebase appdistribution:distribute "/app_artifact" \\
Â  Â  Â  Â  Â  Â  Â  Â  Â  --app "$FIREBASE_APP_ID" \\
Â  Â  Â  Â  Â  Â  Â  Â  Â  --token "$FIREBASE_TOKEN" \\
Â  Â  Â  Â  Â  Â  Â  Â  Â  --groups "testers" \\ # ì‹¤ì œ ê·¸ë£¹ ì´ë¦„ìœ¼ë¡œ ë³€ê²½í•˜ì„¸ìš”
Â  Â  Â  Â  Â  Â  Â  Â  Â  --release-notes "Jenkins CI ìë™ ë°°í¬ ë¹Œë“œ #${BUILD_ID} (Commit: ${GIT_COMMIT_SHORT})" || { echo "âŒ Firebase ë°°í¬ ì‹¤íŒ¨!"; exit 1; }
Â  Â  Â  Â  Â  Â  Â  Â  echo "âœ… Firebase ë°°í¬ ì„±ê³µ."
Â  Â  Â  Â  Â  Â  Â  ' || { echo "âŒ Firebase ë°°í¬ Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì‹¤íŒ¨!"; exit 1; } # docker run ìì²´ê°€ ì‹¤íŒ¨í•œ ê²½ìš°

Â  Â  Â  Â  Â  Â  echo "===================================================="
Â  Â  Â  Â  Â  '''
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }
Â  }

Â  post {
Â  Â  success {
Â  Â  Â  sh '''
Â  Â  Â  Â  echo "===================================================="
Â  Â  Â  Â  echo "âœ… Frontend CI/CD ì„±ê³µ ğŸ‰"
Â  Â  Â  Â  echo "===================================================="
Â  Â  Â  '''
Â  Â  }
Â  Â  failure {
Â  Â  Â  sh '''
Â  Â  Â  Â  echo "===================================================="
Â  Â  Â  Â  echo "âŒ Frontend CI/CD ì‹¤íŒ¨ â—"
Â  Â  Â  Â  echo "===================================================="

Â  Â  Â  Â  # ë””ë²„ê¹… ì •ë³´ ìˆ˜ì§‘
Â  Â  Â  Â  echo "# ë¹Œë“œ ì‹¤íŒ¨ ë””ë²„ê¹… ì •ë³´" > debug-info.md
Â  Â  Â  Â  echo "" >> debug-info.md

Â  Â  Â  Â  echo "## ë¹Œë“œ ë””ë ‰í† ë¦¬ ì •ë³´ (Jenkins ì›Œí¬ìŠ¤í˜ì´ìŠ¤)" >> debug-info.md
Â  Â  Â  Â  ls -la ${WORK_DIR} 2>/dev/null >> debug-info.md || echo "${WORK_DIR} ë¹Œë“œ ë””ë ‰í† ë¦¬ê°€ ì—†ê±°ë‚˜ ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤." >> debug-info.md
Â  Â  Â  Â  echo "" >> debug-info.md

Â  Â  Â  Â  echo "## package.json íŒŒì¼ ë‚´ìš© (Jenkins ì›Œí¬ìŠ¤í˜ì´ìŠ¤)" >> debug-info.md
Â  Â  Â  Â  cat ${WORK_DIR}/package.json 2>/dev/null >> debug-info.md || echo "${WORK_DIR}/package.json íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." >> debug-info.md
Â  Â  Â  Â  echo "" >> debug-info.md

Â  Â  Â  Â  echo "## Docker ìƒíƒœ" >> debug-info.md
Â  Â  Â  Â  docker info 2>/dev/null >> debug-info.md || echo "Docker ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." >> debug-info.md
Â  Â  Â  Â  echo "" >> debug-info.md

Â  Â  Â  Â  echo "## ë§ˆì§€ë§‰ Docker Volume Test ë¡œê·¸ (ì—ëŸ¬ í™•ì¸)" >> debug-info.md
Â  Â  Â  Â  # ì´ì „ ë¡œê·¸ì—ì„œ Docker Volume Test ë¶€ë¶„ì„ ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•˜ì—¬ ì¶”ê°€í•˜ê±°ë‚˜,
Â  Â  Â  Â  # ê°€ëŠ¥í•˜ë‹¤ë©´ í•´ë‹¹ ìŠ¤í…ì˜ ìƒì„¸ ë¡œê·¸ íŒŒì¼ì„ ì²¨ë¶€í•˜ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤.
Â  Â  Â  Â  echo "â¡ï¸ Jenkins ë¹Œë“œ ë¡œê·¸ì—ì„œ 'Docker Volume Test' ìŠ¤í… ìƒì„¸ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”." >> debug-info.md
Â  Â  Â  Â  echo "" >> debug-info.md


Â  Â  Â  Â  # ë””ë²„ê¹… ì •ë³´ ì•„ì¹´ì´ë¸Œ
Â  Â  Â  Â  mkdir -p debug-archive || true
Â  Â  Â  Â  cp debug-info.md debug-archive/ || true # ë³µì‚¬ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë¬´ì‹œ

Â  Â  Â  Â  echo "ğŸ“¦ ë””ë²„ê¹… ì •ë³´ê°€ debug-archiveì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."
Â  Â  Â  '''

Â 
Â  Â  Â  archiveArtifacts artifacts: 'debug-archive/**', fingerprint: true, allowEmptyArchive: true
Â  Â  }
Â  Â  always {
Â  Â  Â  sh '''
Â  Â  Â  Â  echo "===================================================="
Â  Â  Â  Â  echo "ğŸ§¹ ì‘ì—… ê³µê°„ ì •ë¦¬"
Â  Â  Â  Â  echo "===================================================="

Â  Â  Â  Â  # ì„ì‹œ ë””ë ‰í† ë¦¬ ë° íŒŒì¼ ì •ë¦¬ (ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ì •ë¦¬ ì‹œë„)
Â  Â  Â  Â  rm -rf ${WORK_DIR} ${WORKSPACE}/workspace.tar.gz ${WORKSPACE}/apk apk-archive debug-archive || true
Â  Â  Â  '''

Â  Â  Â  cleanWs()
Â  Â  }
Â  }
}