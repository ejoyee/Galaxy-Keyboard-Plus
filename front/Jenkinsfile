pipeline {
  agent any

  environment {
    FIREBASE_TOKEN   = credentials('FIREBASE_TOKEN')
    FIREBASE_APP_ID  = '1:189536895445:android:783ed885fd7c4b896bfd5c'
    KEYSTORE_PASSWORD = credentials('KEYSTORE_PASSWORD')
    KEY_ALIAS        = credentials('KEY_ALIAS')
    KEY_PASSWORD     = credentials('KEY_PASSWORD')
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Checkout & Init') {
      steps {
        sh 'chmod -R 777 .'
      }
    }

    stage('Prepare Project') {
      steps {
        sh '''
          echo "ğŸ“¦ ì‘ì—… ë””ë ‰í† ë¦¬ ì¤€ë¹„ ë° ì••ì¶•"
          [ -d workspace.tar.gz ] && echo "âš ï¸ ì´ì „ ë””ë ‰í† ë¦¬ ì œê±°" && rm -rf workspace.tar.gz
          rm -rf workspace
          mkdir -p workspace
          cp -a front/frontend/. workspace/
          chmod -R 777 workspace

          if [ -f workspace/package.json ]; then
            echo "ğŸ“„ package.json í™•ì¸ ì™„ë£Œ"
          else
            echo "âŒ package.json ëˆ„ë½"
            exit 1
          fi

          tar -czf workspace.tar.gz -C workspace .
          echo "ğŸ“Š ì••ì¶• íŒŒì¼ ìƒíƒœ:"
          ls -lh workspace.tar.gz
          stat workspace.tar.gz
        '''
      }
    }

    stage('Prepare Secrets') {
      steps {
        withCredentials([
          file(credentialsId: 'android-release-keystore', variable: 'KEYSTORE_FILE'),
          file(credentialsId: 'google-services-json', variable: 'GOOGLE_SERVICES_JSON'),
          file(credentialsId: 'firebase-service-account', variable: 'FIREBASE_SERVICE_ACCOUNT')
        ]) {
          sh '''
            echo "ğŸ” ì‹œí¬ë¦¿ íŒŒì¼ ë³µì‚¬"
            mkdir -p workspace/android/app/keystore
            cp "$KEYSTORE_FILE" workspace/android/app/keystore/release.keystore
            cp "$GOOGLE_SERVICES_JSON" workspace/android/app/google-services.json
            cp "$FIREBASE_SERVICE_ACCOUNT" workspace/android/firebase_service_account.json
            chmod -R 777 workspace/android
          '''
        }
      }
    }

    stage('Build and Deploy') {
      steps {
        sh '''
          echo "ğŸš€ Docker ë¹Œë“œ ë° ë°°í¬ ì‹œì‘"
          docker run --rm \
            -v $(pwd):/app \
            -e FIREBASE_TOKEN=$FIREBASE_TOKEN \
            -e FIREBASE_APP_ID=$FIREBASE_APP_ID \
            cimg/android:2023.08 bash -c "
              set -e
              echo 'ğŸ“‚ ì••ì¶• í•´ì œ'
              if [ -d /app/workspace.tar.gz ]; then
                echo 'âŒ ê²½ê³ : /app/workspace.tar.gz ëŠ” ë””ë ‰í† ë¦¬ì…ë‹ˆë‹¤. ë§ˆìš´íŠ¸ ì˜¤ë¥˜ ë°œìƒ'
                exit 1
              fi

              mkdir -p /tmp/project
              tar -xzf /app/workspace.tar.gz -C /tmp/project
              cd /tmp/project

              echo 'ğŸ“¦ npm install'
              npm install

              echo 'ğŸ› ï¸ Android ë¹Œë“œ'
              cd android
              chmod +x ./gradlew
              echo 'sdk.dir=$ANDROID_HOME' > local.properties
              echo 'KEYSTORE_PASSWORD=$KEYSTORE_PASSWORD' >> gradle.properties
              echo 'KEY_ALIAS=$KEY_ALIAS' >> gradle.properties
              echo 'KEY_PASSWORD=$KEY_PASSWORD' >> gradle.properties
              ./gradlew clean assembleRelease --stacktrace

              echo 'ğŸ“¦ ë¹Œë“œ ì‚°ì¶œë¬¼ ë³µì‚¬'
              mkdir -p /tmp/output
              find . -name '*.apk' -o -name '*.aab' -exec cp {} /tmp/output/ \\;

              echo 'ğŸ”¥ Firebase ë°°í¬'
              npm install -g firebase-tools
              firebase appdistribution:distribute /tmp/output/*.apk \
                --app \"$FIREBASE_APP_ID\" \
                --token \"$FIREBASE_TOKEN\" \
                --groups \"testers\" \
                --release-notes \"CI ìë™ ë°°í¬ #${BUILD_ID}\"
            "
        '''
      }
    }
  }

  post {
    always {
      sh '''
        echo "âŒ ë¹Œë“œ ì‹¤íŒ¨ ë””ë²„ê¹… ì €ì¥"
        mkdir -p debug-archive
        echo "## package.json ë‚´ìš©"
        cat workspace/package.json || echo "ì—†ìŒ"
        echo "\\n## .tar.gz ìƒíƒœ"
        stat workspace.tar.gz || echo "stat ì‹¤íŒ¨"
      '''
      archiveArtifacts artifacts: 'debug-archive/**', allowEmptyArchive: true
    }
  }
}
