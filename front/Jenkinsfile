pipeline {
  agent any

  environment {
    FIREBASE_TOKEN      = credentials('FIREBASE_TOKEN')
    FIREBASE_APP_ID     = '1:189536895445:android:783ed885fd7c4b896bfd5c'
    KEYSTORE_PASSWORD   = credentials('KEYSTORE_PASSWORD')
    KEY_ALIAS           = credentials('KEY_ALIAS')
    KEY_PASSWORD        = credentials('KEY_PASSWORD')
    DOCKER_IMAGE        = 'cimg/android:2023.08'
    WORK_DIR            = "${WORKSPACE}/workspace"
    TAR_PATH            = "${WORKSPACE}/workspace.tar.gz"
    ARCHIVE_DIR         = "${WORKSPACE}/apk-archive"
  }

  stages {
    stage('Checkout & Init') {
      steps {
        checkout scm
        sh 'chmod -R 777 .'
      }
    }

    stage('Prepare Project') {
      steps {
        sh '''
          echo "📦 작업 디렉토리 준비 및 압축"
          rm -rf ${WORK_DIR} ${TAR_PATH}
          mkdir -p ${WORK_DIR}
          cp -a front/frontend/. ${WORK_DIR}/
          chmod -R 777 ${WORK_DIR}

          echo "📄 package.json 확인"
          [ -f ${WORK_DIR}/package.json ] || { echo "❌ package.json 없음"; exit 1; }

          echo "📦 압축 생성"
          tar -czf ${TAR_PATH} -C ${WORK_DIR} .
          [ -f ${TAR_PATH} ] || { echo "❌ 압축 파일 생성 실패"; exit 1; }

          echo "📊 .tar.gz 파일 상태"
          ls -lh ${TAR_PATH}
          stat ${TAR_PATH}
        '''
      }
    }

    stage('Prepare Secrets') {
      steps {
        withCredentials([
          file(credentialsId: 'android-release-keystore', variable: 'KEYSTORE_FILE'),
          file(credentialsId: 'google-services-json', variable: 'GOOGLE_SERVICES_JSON'),
          file(credentialsId: 'firebase-service-account', variable: 'FIREBASE_SERVICE_ACCOUNT')
        ]) {
          sh '''
            echo "🔐 시크릿 파일 복사 및 권한 설정"
            mkdir -p ${WORK_DIR}/android/app/keystore
            cp "$KEYSTORE_FILE" ${WORK_DIR}/android/app/keystore/release.keystore
            cp "$GOOGLE_SERVICES_JSON" ${WORK_DIR}/android/app/google-services.json
            cp "$FIREBASE_SERVICE_ACCOUNT" ${WORK_DIR}/android/firebase_service_account.json
            chmod -R 777 ${WORK_DIR}/android
          '''
        }
      }
    }

    stage('Build and Deploy') {
      steps {
        sh '''
          echo "🚀 Docker 빌드 시작"

          echo "📁 마운트 전 .tar.gz 상태 검사"
          [ -f "${TAR_PATH}" ] || { echo "❌ ${TAR_PATH} 존재하지 않음"; exit 1; }
          ls -lh "${TAR_PATH}"
          stat "${TAR_PATH}"

          docker run --rm \
            -v "${TAR_PATH}:/input/project.tar.gz" \
            -e FIREBASE_TOKEN="${FIREBASE_TOKEN}" \
            -e FIREBASE_APP_ID="${FIREBASE_APP_ID}" \
            ${DOCKER_IMAGE} \
            bash -c '
              set -e
              echo "📁 /input 디렉토리 검사"
              ls -l /input || echo "❌ /input 디렉토리 없음"

              echo "📄 /input/project.tar.gz 존재 확인"
              if [ -d /input/project.tar.gz ]; then
                echo "❌ 경고: /input/project.tar.gz 가 디렉토리입니다! 마운트 잘못됨"
                exit 1
              elif [ ! -f /input/project.tar.gz ]; then
                echo "❌ project.tar.gz 파일 없음"
                exit 1
              fi

              echo "📂 압축 해제 중..."
              mkdir -p /tmp/project
              tar -xzf /input/project.tar.gz -C /tmp/project

              echo "📁 디렉토리 확인:"
              ls -al /tmp/project

              echo "📦 npm install 시작"
              cd /tmp/project
              npm install

              echo "🛠️ Gradle 빌드 시작"
              cd android
              chmod +x ./gradlew
              echo "sdk.dir=$ANDROID_HOME" > local.properties
              echo "KEYSTORE_PASSWORD=${KEYSTORE_PASSWORD}" >> gradle.properties
              echo "KEY_ALIAS=${KEY_ALIAS}" >> gradle.properties
              echo "KEY_PASSWORD=${KEY_PASSWORD}" >> gradle.properties
              ./gradlew clean assembleRelease --stacktrace

              echo "📦 결과 파일 복사"
              mkdir -p /tmp/output
              find . -name "*.apk" -o -name "*.aab" -exec cp {} /tmp/output/ \\;

              echo "🔥 Firebase CLI 설치 및 배포"
              npm install -g firebase-tools
              firebase appdistribution:distribute /tmp/output/*.apk \
                --app "$FIREBASE_APP_ID" \
                --token "$FIREBASE_TOKEN" \
                --groups "testers" \
                --release-notes "CI 자동 배포 #${BUILD_ID}"

              echo "✅ 배포 완료"
            '

          echo "📦 결과 복사 및 아카이브"
          mkdir -p ${ARCHIVE_DIR}
          cp -v ${WORK_DIR}/android/app/build/outputs/apk/release/*.apk ${ARCHIVE_DIR}/ || echo "⚠️ APK 복사 실패"
        '''
        archiveArtifacts artifacts: 'apk-archive/**', fingerprint: true, allowEmptyArchive: true
      }
    }
  }

  post {
    success {
      echo '✅ 빌드 및 배포 성공 🎉'
    }
    failure {
      sh '''
        echo "❌ 빌드 실패 디버깅 아카이브"
        mkdir -p debug-archive
        echo "## package.json 내용" > debug-archive/info.txt
        cat ${WORK_DIR}/package.json >> debug-archive/info.txt 2>/dev/null || echo "없음" >> debug-archive/info.txt
        echo "## .tar.gz 상태" >> debug-archive/info.txt
        stat ${TAR_PATH} >> debug-archive/info.txt 2>/dev/null || echo "stat 실패" >> debug-archive/info.txt
      '''
      archiveArtifacts artifacts: 'debug-archive/**', fingerprint: true, allowEmptyArchive: true
    }
    always {
      cleanWs()
    }
  }
}
