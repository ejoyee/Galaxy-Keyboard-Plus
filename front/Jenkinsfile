pipeline {
  agent {
    docker {
      image 'my-android-ci:latest'
      args  '--user root:root'
    }
  }

  environment {
    // Android SDK ì„¤ì •
    ANDROID_SDK_ROOT = '/opt/android-sdk'
    ANDROID_HOME     = '/opt/android-sdk'
    PATH             = "${env.PATH}:/opt/android-sdk/cmdline-tools/latest/bin:/opt/android-sdk/platform-tools"

    // Fastlane Firebase App Distribution í† í°  
    FIREBASE_TOKEN   = credentials('FIREBASE_TOKEN')
  }

  parameters {
    string(
      name: 'FORCE_SERVICES',
      defaultValue: '',
      description: 'ì½¤ë§ˆë¡œ ì§€ì • ì‹œ í•´ë‹¹ ì„œë¹„ìŠ¤ë§Œ ë¹Œë“œÂ·ë°°í¬ (ì˜ˆ: frontend)'
    )
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Detect Changed Services') {
      steps {
        script {
          // ì´ì „ ë¹Œë“œ ëŒ€ë¹„ ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ì—ì„œ 'frontend/' ê²½ë¡œë§Œ ê³¨ë¼ëƒ…ë‹ˆë‹¤
          def diff = sh(
            script: "git diff --name-only ${env.GIT_PREVIOUS_SUCCESSFUL_COMMIT ?: 'HEAD~1'} ${env.GIT_COMMIT}",
            returnStdout: true
          ).trim()
          def changed = diff.split('\n')
                            .findAll{ it.startsWith('frontend/') }
                            .collect{ 'frontend' }
                            .unique()
          def forced = params.FORCE_SERVICES ? params.FORCE_SERVICES.split(',').collect{ it.trim() } : []
          env.CHANGED_SERVICES = (forced ?: changed).join(',')
          if (!env.CHANGED_SERVICES) {
            echo "ðŸš« No frontend changes detected, skipping build."
            currentBuild.result = 'SUCCESS'
          } else {
            echo "ðŸ”¨ Will build: ${env.CHANGED_SERVICES}"
          }
        }
      }
    }

    stage('Prepare Secrets') {
      when {
        expression { env.CHANGED_SERVICES.contains('frontend') }
      }
      steps {
        withCredentials([
          file(  credentialsId: 'android-release-keystore',  variable: 'KEYSTORE_FILE'),
          string(credentialsId: 'KEYSTORE_PASSWORD',          variable: 'KEYSTORE_PASSWORD'),
          string(credentialsId: 'KEY_ALIAS',                  variable: 'KEY_ALIAS'),
          string(credentialsId: 'KEY_PASSWORD',               variable: 'KEY_PASSWORD'),
          file(  credentialsId: 'google-services-json',       variable: 'GOOGLE_SERVICES_JSON'),
          file(  credentialsId: 'firebase-service-account',   variable: 'FIREBASE_SERVICE_ACCOUNT')
        ]) {
          sh '''
            # keystore & google-services.json ë³µì‚¬
            mkdir -p frontend/android/app/keystore
            cp "$KEYSTORE_FILE"            frontend/android/app/keystore/release.keystore
            cp "$GOOGLE_SERVICES_JSON"     frontend/android/app/google-services.json
            cp "$FIREBASE_SERVICE_ACCOUNT" frontend/android/firebase_service_account.json

            # Gradle propertiesì— í‚¤ìŠ¤í† ì–´ ì •ë³´ ì£¼ìž…
            mkdir -p ~/.gradle
            cat > ~/.gradle/gradle.properties <<EOF
KEYSTORE_PASSWORD=${KEYSTORE_PASSWORD}
KEY_ALIAS=${KEY_ALIAS}
KEY_PASSWORD=${KEY_PASSWORD}
EOF
          '''
        }
      }
    }

    stage('Install Dependencies') {
      when {
        expression { env.CHANGED_SERVICES.contains('frontend') }
      }
      steps {
        dir('frontend/android') {
          sh 'yarn install'
          sh 'bundle install --path vendor/bundle'
          // Fastlane plugin ì„¤ì¹˜ (Fastfile ë‚´ install_plugins lane ì´ ì—†ìœ¼ë©´ ìƒëžµ ê°€ëŠ¥)
          sh 'bundle exec fastlane install_plugins'
        }
      }
    }

    stage('Build & Distribute') {
      when {
        expression { env.CHANGED_SERVICES.contains('frontend') }
      }
      steps {
        dir('frontend/android') {
          // fastlane/Fastfile ì— ì •ì˜ëœ release lane ì‹¤í–‰
          sh """
            export FASTLANE_FIREBASE_CLI_TOKEN=${FIREBASE_TOKEN}
            bundle exec fastlane release \
              groups:'testers' \
              notes:'CI ìžë™ ë°°í¬ ë¹Œë“œ'
          """
        }
      }
    }

    stage('Archive APK') {
      when {
        expression { env.CHANGED_SERVICES.contains('frontend') }
      }
      steps {
        archiveArtifacts artifacts: 'frontend/android/app/build/outputs/**/*.apk', fingerprint: true
      }
    }
  }

  post {
    always {
      cleanWs()
    }
    success {
      echo 'âœ… Frontend CI/CD ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œ'
    }
    failure {
      echo 'âŒ Frontend CI/CD ì¤‘ ì˜¤ë¥˜ ë°œìƒ'
    }
  }
}
