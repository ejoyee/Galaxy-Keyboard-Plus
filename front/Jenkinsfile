pipeline {
  agent any

  environment {
    // Android SDK 설정
    ANDROID_SDK_ROOT = '/opt/android-sdk'
    ANDROID_HOME     = '/opt/android-sdk'
    PATH             = "${env.PATH}:/opt/android-sdk/cmdline-tools/latest/bin:/opt/android-sdk/platform-tools"
    // Fastlane Firebase App Distribution 토큰
    FIREBASE_TOKEN   = credentials('FIREBASE_TOKEN')
    // Firebase 앱 ID
    FIREBASE_APP_ID  = '1:189536895445:android:783ed885fd7c4b896bfd5c'
    // 빌드 강제 실행 여부
    FORCE_BUILD      = 'true'
    // 키스토어 관련 설정
    KEYSTORE_PASSWORD = credentials('KEYSTORE_PASSWORD')
    KEY_ALIAS        = credentials('KEY_ALIAS')
    KEY_PASSWORD     = credentials('KEY_PASSWORD')
    // 사용할 Docker 이미지
    DOCKER_IMAGE     = 'my-android-ci:latest'
    // 현재 사용자 ID (Docker 볼륨 마운트에 사용)
    USER_ID = sh(script: 'id -u', returnStdout: true).trim()
    GROUP_ID = sh(script: 'id -g', returnStdout: true).trim()
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
        
        // 빌드 시작 로그
        sh '''
          echo "===================================================="
          echo "🚀 빌드 시작: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "🔍 빌드 ID: ${BUILD_ID}"
          echo "🔍 Git 커밋: ${GIT_COMMIT}"
          echo "🔍 브랜치: ${GIT_BRANCH}"
          echo "===================================================="
        '''
      }
    }

    stage('Detect Frontend Changes') {
      steps {
        script {
          def diff = sh(
            script: "git diff --name-only ${env.GIT_PREVIOUS_SUCCESSFUL_COMMIT ?: 'HEAD~1'} ${env.GIT_COMMIT}",
            returnStdout: true
          ).trim()
          
          // 변경 파일 목록 출력
          echo "==== 변경된 파일 목록 ===="
          echo "${diff}"
          echo "=========================="
          
          // "front/" 하위 파일 변경이 있으면 빌드
          env.BUILD_FRONTEND = diff.split('\n').any { it.startsWith('front/') } ? 'true' : 'false'
          
          // 강제 빌드 옵션이 true이면 무조건 빌드
          if (env.FORCE_BUILD == 'true') {
            env.BUILD_FRONTEND = 'true'
            echo "🔧 강제 빌드 옵션이 활성화되어 있습니다."
          }
          
          echo env.BUILD_FRONTEND=='true'
               ? "▶ Frontend 변경 감지: 빌드합니다"
               : "▶ Frontend 변경 없음: 스킵합니다"
        }
      }
    }

    stage('Check Project Structure') {
      when { expression { env.BUILD_FRONTEND == 'true' } }
      steps {
        sh '''
          echo "===================================================="
          echo "🔍 프로젝트 구조 확인"
          echo "===================================================="
          
          # 디렉토리 구조 확인
          echo "📂 작업 디렉토리: $(pwd)"
          
          echo "📂 front/frontend 디렉토리 확인:"
          ls -la front/frontend || { echo "❌ front/frontend 디렉토리가 없습니다"; exit 1; }
          
          # package.json 확인
          if [ -f "front/frontend/package.json" ]; then
            echo "✅ package.json 파일 존재"
            cat front/frontend/package.json | grep "name\\|version"
          else
            echo "❌ package.json 파일이 없습니다. React Native 프로젝트가 아닐 수 있습니다."
            exit 1
          fi
          
          echo "📂 front/frontend/android 디렉토리 확인:"
          ls -la front/frontend/android || { echo "❌ front/frontend/android 디렉토리가 없습니다"; exit 1; }
          
          echo "📂 gradlew 파일 확인:"
          if [ -f "front/frontend/android/gradlew" ]; then
            echo "✅ gradlew 파일 존재"
            chmod +x front/frontend/android/gradlew
          else
            echo "❌ gradlew 파일이 없습니다."
            exit 1
          fi
          
          echo "===================================================="
        '''
      }
    }

    stage('Prepare Files') {
      when { expression { env.BUILD_FRONTEND == 'true' } }
      steps {
        // 시크릿 파일 준비
        withCredentials([
          file(credentialsId: 'android-release-keystore', variable: 'KEYSTORE_FILE'),
          file(credentialsId: 'google-services-json', variable: 'GOOGLE_SERVICES_JSON'),
          file(credentialsId: 'firebase-service-account', variable: 'FIREBASE_SERVICE_ACCOUNT')
        ]) {
          sh '''
            echo "===================================================="
            echo "🔐 시크릿 파일 준비"
            echo "===================================================="
            
            # 디렉토리 생성
            mkdir -p front/frontend/android/app/keystore
            
            # 시크릿 파일 복사 (올바른 경로에 맞게 조정)
            cp "$FIREBASE_SERVICE_ACCOUNT" front/frontend/android/firebase_service_account.json
            cp "$GOOGLE_SERVICES_JSON" front/frontend/android/app/google-services.json
            cp "$KEYSTORE_FILE" front/frontend/android/app/keystore/release.keystore
            
            # 파일 존재 여부 확인
            ls -la front/frontend/android/firebase_service_account.json
            ls -la front/frontend/android/app/google-services.json
            ls -la front/frontend/android/app/keystore/release.keystore
            
            echo "✅ 시크릿 파일 복사 완료"
            echo "===================================================="
          '''
        }
      }
    }

    stage('Build with Docker') {
      when { expression { env.BUILD_FRONTEND == 'true' } }
      steps {
        sh '''
          echo "===================================================="
          echo "🚀 Docker를 통한 Android 빌드"
          echo "===================================================="
          
          # 전체 프로젝트 경로 (절대 경로)
          PROJECT_PATH="$(pwd)/front/frontend"
          
          # Docker에서 React Native 앱 빌드 실행 (중요: -u 옵션 추가)
          docker run --rm \
            -u $(id -u):$(id -g) \
            -v "$PROJECT_PATH:/workspace" \
            -w /workspace \
            -e ANDROID_SDK_ROOT=/opt/android-sdk \
            -e ANDROID_HOME=/opt/android-sdk \
            -e KEYSTORE_PASSWORD="$KEYSTORE_PASSWORD" \
            -e KEY_ALIAS="$KEY_ALIAS" \
            -e KEY_PASSWORD="$KEY_PASSWORD" \
            ${DOCKER_IMAGE} \
            bash -c '
              set -e  # 에러 발생 시 즉시 스크립트 중단
              
              echo "📂 현재 디렉토리: $(pwd)"
              ls -la
              
              echo "📂 Android 디렉토리 확인:"
              ls -la android
              
              # 중요 파일 확인
              if [ ! -f "android/gradlew" ] || [ ! -d "android/app" ]; then
                echo "❌ 필수 Android 파일이 없습니다. 볼륨 마운트 문제가 있습니다."
                exit 1
              fi
              
              echo "🔧 Node 모듈 설치"
              yarn install
              
              echo "🔧 Android 디렉토리로 이동"
              cd android
              
              echo "🔧 local.properties 생성"
              echo "sdk.dir=/opt/android-sdk" > local.properties
              
              echo "🔧 Gradle 프로퍼티 설정"
              cat >> gradle.properties << EOF

# CI 환경 키스토어 설정
KEYSTORE_PASSWORD=$KEYSTORE_PASSWORD
KEY_ALIAS=$KEY_ALIAS
KEY_PASSWORD=$KEY_PASSWORD
EOF
              
              echo "🔧 Android SDK 환경 확인"
              echo "ANDROID_HOME: $ANDROID_HOME"
              
              echo "🔧 Gradle 빌드 실행"
              chmod +x ./gradlew
              ./gradlew clean
              ./gradlew assembleDebug
              
              echo "🔧 빌드 결과 확인"
              find . -name "*.apk"
            '
          
          # 빌드 결과 확인
          echo "📂 빌드 결과 확인:"
          find front/frontend/android -name "*.apk" || echo "❌ APK 파일을 찾을 수 없습니다"
          
          # 결과물 복사
          mkdir -p apk
          find front/frontend/android -name "*.apk" | xargs -I {} cp {} apk/ || echo "❌ APK 파일 복사 실패"
          
          echo "===================================================="
        '''
      }
    }

    stage('Direct Build') {
      when { 
        expression { env.BUILD_FRONTEND == 'true' }
        // 이전 스테이지에서 APK 생성 실패했을 경우에 실행 (백업 방법)
        expression { 
          return sh(script: 'find apk -name "*.apk" | wc -l', returnStdout: true).trim() == '0' 
        }
      }
      steps {
        sh '''
          echo "===================================================="
          echo "🚀 직접 Android 빌드 시도 (백업 방법)"
          echo "===================================================="
          
          cd front/frontend/android
          
          # local.properties 생성
          echo "sdk.dir=${ANDROID_SDK_ROOT}" > local.properties
          
          # Gradle 프로퍼티에 Keystore 정보 추가
          cat >> gradle.properties << EOF

# CI 환경 키스토어 설정
KEYSTORE_PASSWORD=${KEYSTORE_PASSWORD}
KEY_ALIAS=${KEY_ALIAS}
KEY_PASSWORD=${KEY_PASSWORD}
EOF
          
          # Gradle 빌드
          chmod +x ./gradlew
          ./gradlew clean
          ./gradlew assembleDebug
          
          # 빌드 결과물 확인
          find . -name "*.apk"
          
          # 결과물 복사
          mkdir -p ../../apk
          find . -name "*.apk" | xargs -I {} cp {} ../../apk/
          
          echo "===================================================="
        '''
      }
    }

    stage('Archive APK') {
      when { expression { env.BUILD_FRONTEND == 'true' } }
      steps {
        sh '''
          echo "===================================================="
          echo "📦 APK 아카이브"
          echo "===================================================="
          
          mkdir -p apk-archive
          
          # APK 파일 검색 범위 확장
          FOUND_APKS=$(find "$(pwd)" -name "*.apk" | wc -l)
          
          if [ "$FOUND_APKS" -gt 0 ]; then
            echo "✅ $FOUND_APKS 개의 APK 파일 발견:"
            find "$(pwd)" -name "*.apk"
            
            # APK 파일 복사
            find "$(pwd)" -name "*.apk" | xargs -I {} cp {} apk-archive/
          else
            echo "❌ APK 파일을 찾을 수 없습니다"
            echo "No APK files found" > apk-archive/build-failed.txt
          fi
          
          echo "===================================================="
        '''
        
        archiveArtifacts artifacts: 'apk-archive/**', fingerprint: true, allowEmptyArchive: true
      }
    }

    stage('Deploy to Firebase') {
      when { expression { env.BUILD_FRONTEND == 'true' } }
      steps {
        // Firebase 배포
        withCredentials([
          string(credentialsId: 'FIREBASE_TOKEN', variable: 'FIREBASE_TOKEN')
        ]) {
          sh '''
            echo "===================================================="
            echo "🔥 Firebase 배포"
            echo "===================================================="
            
            # 전체 시스템에서 APK 파일 찾기
            APK_FILE=$(find "$(pwd)" -name "*.apk" | head -1)
            
            if [ -z "$APK_FILE" ]; then
              echo "❌ APK 파일을 찾을 수 없어 Firebase 배포를 건너뜁니다"
              exit 0
            fi
            
            echo "✅ 업로드할 APK 파일: $APK_FILE"
            
            # Docker에서 Firebase 배포 실행
            docker run --rm \
              -v "$(pwd):/workspace" \
              -w /workspace \
              -e FIREBASE_TOKEN="$FIREBASE_TOKEN" \
              -e FIREBASE_APP_ID="$FIREBASE_APP_ID" \
              ${DOCKER_IMAGE} \
              bash -c '
                cd /workspace/front/frontend/android
                
                # Bundler 환경 설정
                export GEM_HOME=/root/.gem
                export PATH=$PATH:$GEM_HOME/bin
                
                # Fastlane으로 배포
                bundle config set path "vendor/bundle"
                bundle install
                
                bundle exec fastlane run firebase_app_distribution \
                  app:"$FIREBASE_APP_ID" \
                  firebase_cli_token:"$FIREBASE_TOKEN" \
                  apk_path:"/workspace/'"$APK_FILE"'" \
                  groups:"testers" \
                  release_notes:"Jenkins CI 자동 배포 빌드 #${BUILD_ID} (${GIT_COMMIT})"
              '
            
            echo "===================================================="
          '''
        }
      }
    }
  }

  post {
    success {
      sh '''
        echo "===================================================="
        echo "✅ Frontend CI/CD 성공 🎉"
        echo "===================================================="
      '''
    }
    failure {
      sh '''
        echo "===================================================="
        echo "❌ Frontend CI/CD 실패 ❗"
        echo "===================================================="
        
        # 디버깅 정보 수집
        echo "🔍 빌드 실패 디버깅 정보:"
        echo "Android 디렉토리 구조:" > debug-info.txt
        find front/frontend/android -type f | sort >> debug-info.txt
        echo "" >> debug-info.txt
        
        echo "Gradle 파일 내용:" >> debug-info.txt
        cat front/frontend/android/build.gradle >> debug-info.txt
        echo "" >> debug-info.txt
        
        echo "마운트 상태:" >> debug-info.txt
        docker run --rm -v "$(pwd)/front/frontend:/workspace" ${DOCKER_IMAGE} bash -c 'ls -la /workspace' >> debug-info.txt
        
        # 디버깅 정보 아카이브
        mkdir -p debug-archive
        cp debug-info.txt debug-archive/
        
        # 디버깅 아카이브
        echo "📦 디버깅 정보가 debug-archive에 저장되었습니다"
      '''
      
      archiveArtifacts artifacts: 'debug-archive/**', fingerprint: true, allowEmptyArchive: true
    }
    always {
      sh '''
        echo "===================================================="
        echo "🧹 작업 공간 정리"
        echo "===================================================="
        
        # 임시 디렉토리 정리
        rm -rf apk apk-archive debug-archive || true
      '''
      cleanWs()
    }
  }
}