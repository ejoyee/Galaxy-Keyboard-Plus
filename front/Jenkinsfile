pipeline {
  agent any

  environment {
    // Android SDK ì„¤ì •
    ANDROID_SDK_ROOT = '/opt/android-sdk'
    ANDROID_HOME     = '/opt/android-sdk'
    PATH             = "${env.PATH}:/opt/android-sdk/cmdline-tools/latest/bin:/opt/android-sdk/platform-tools"
    // Fastlane Firebase App Distribution í† í°
    FIREBASE_TOKEN   = credentials('FIREBASE_TOKEN')
    // Firebase ì•± ID
    FIREBASE_APP_ID  = '1:189536895445:android:783ed885fd7c4b896bfd5c'
    // ë¹Œë“œ ê°•ì œ ì‹¤í–‰ ì—¬ë¶€
    FORCE_BUILD      = 'true'
    // Docker ì´ë¯¸ì§€ ì„¤ì •
    DOCKER_IMAGE     = 'reactnativecommunity/react-native-android:latest'
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
        
        // ë¹Œë“œ ì‹œì‘ ë¡œê·¸
        sh '''
          echo "===================================================="
          echo "ğŸš€ ë¹Œë“œ ì‹œì‘: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ” ë¹Œë“œ ID: ${BUILD_ID}"
          echo "ğŸ” Git ì»¤ë°‹: ${GIT_COMMIT}"
          echo "ğŸ” ë¸Œëœì¹˜: ${GIT_BRANCH}"
          echo "===================================================="
        '''
      }
    }

    stage('Detect Frontend Changes') {
      steps {
        script {
          def diff = sh(
            script: "git diff --name-only ${env.GIT_PREVIOUS_SUCCESSFUL_COMMIT ?: 'HEAD~1'} ${env.GIT_COMMIT}",
            returnStdout: true
          ).trim()
          
          // ë³€ê²½ íŒŒì¼ ëª©ë¡ ì¶œë ¥
          echo "==== ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ===="
          echo "${diff}"
          echo "=========================="
          
          // "front/" í•˜ìœ„ íŒŒì¼ ë³€ê²½ì´ ìˆìœ¼ë©´ ë¹Œë“œ
          env.BUILD_FRONTEND = diff.split('\n').any { it.startsWith('front/') } ? 'true' : 'false'
          
          // ê°•ì œ ë¹Œë“œ ì˜µì…˜ì´ trueì´ë©´ ë¬´ì¡°ê±´ ë¹Œë“œ
          if (env.FORCE_BUILD == 'true') {
            env.BUILD_FRONTEND = 'true'
            echo "ğŸ”§ ê°•ì œ ë¹Œë“œ ì˜µì…˜ì´ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
          }
          
          echo env.BUILD_FRONTEND=='true'
               ? "â–¶ Frontend ë³€ê²½ ê°ì§€: ë¹Œë“œí•©ë‹ˆë‹¤"
               : "â–¶ Frontend ë³€ê²½ ì—†ìŒ: ìŠ¤í‚µí•©ë‹ˆë‹¤"
        }
      }
    }

    stage('Check Project Structure') {
      when { expression { env.BUILD_FRONTEND == 'true' } }
      steps {
        sh '''
          echo "===================================================="
          echo "ğŸ” í”„ë¡œì íŠ¸ êµ¬ì¡° í™•ì¸"
          echo "===================================================="
          
          # ë””ë ‰í† ë¦¬ êµ¬ì¡° í™•ì¸
          echo "ğŸ“‚ ì‘ì—… ë””ë ‰í† ë¦¬: $(pwd)"
          
          echo "ğŸ“‚ front/frontend ë””ë ‰í† ë¦¬ í™•ì¸:"
          ls -la front/frontend || { echo "âŒ front/frontend ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤"; exit 1; }
          
          # package.json í™•ì¸
          if [ -f "front/frontend/package.json" ]; then
            echo "âœ… package.json íŒŒì¼ ì¡´ì¬"
            cat front/frontend/package.json | grep "name\\|version"
          else
            echo "âŒ package.json íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. React Native í”„ë¡œì íŠ¸ê°€ ì•„ë‹ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
            exit 1
          fi
          
          echo "ğŸ“‚ front/frontend/android ë””ë ‰í† ë¦¬ í™•ì¸:"
          ls -la front/frontend/android || { echo "âŒ front/frontend/android ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤"; exit 1; }
          
          echo "ğŸ“‚ gradlew íŒŒì¼ í™•ì¸:"
          if [ -f "front/frontend/android/gradlew" ]; then
            echo "âœ… gradlew íŒŒì¼ ì¡´ì¬"
            chmod +x front/frontend/android/gradlew
          else
            echo "âŒ gradlew íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi
          
          echo "===================================================="
        '''
      }
    }

    stage('Prepare Files') {
      when { expression { env.BUILD_FRONTEND == 'true' } }
      steps {
        // ì‹œí¬ë¦¿ íŒŒì¼ ì¤€ë¹„
        withCredentials([
          file(credentialsId: 'android-release-keystore', variable: 'KEYSTORE_FILE'),
          string(credentialsId: 'KEYSTORE_PASSWORD', variable: 'KEYSTORE_PASSWORD'),
          string(credentialsId: 'KEY_ALIAS', variable: 'KEY_ALIAS'),
          string(credentialsId: 'KEY_PASSWORD', variable: 'KEY_PASSWORD'),
          file(credentialsId: 'google-services-json', variable: 'GOOGLE_SERVICES_JSON'),
          file(credentialsId: 'firebase-service-account', variable: 'FIREBASE_SERVICE_ACCOUNT')
        ]) {
          sh '''
            echo "===================================================="
            echo "ğŸ” ì‹œí¬ë¦¿ íŒŒì¼ ì¤€ë¹„"
            echo "===================================================="
            
            # Keystore ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p front/frontend/android/app/keystore
            
            # ì‹œí¬ë¦¿ íŒŒì¼ ë³µì‚¬
            cp "$KEYSTORE_FILE" front/frontend/android/app/keystore/release.keystore
            cp "$GOOGLE_SERVICES_JSON" front/frontend/android/app/google-services.json
            cp "$FIREBASE_SERVICE_ACCOUNT" front/frontend/android/firebase_service_account.json
            
            echo "âœ… ì‹œí¬ë¦¿ íŒŒì¼ ë³µì‚¬ ì™„ë£Œ"
            echo "===================================================="
          '''
        }
      }
    }

    stage('Build with Dockerfile') {
      when { expression { env.BUILD_FRONTEND == 'true' } }
      steps {
        sh '''
          echo "===================================================="
          echo "ğŸ³ Dockerfileì„ í†µí•œ Android ë¹Œë“œ"
          echo "===================================================="
          
          # ì‘ì—… ë””ë ‰í† ë¦¬
          WORKSPACE_DIR="$(pwd)"
          
          # ì„ì‹œ ì‘ì—… ë””ë ‰í† ë¦¬ ìƒì„±
          BUILD_DIR="$WORKSPACE_DIR/android-build"
          mkdir -p "$BUILD_DIR"
          
          # ì „ì²´ React Native í”„ë¡œì íŠ¸ ë³µì‚¬ (ì¤‘ìš” ë³€ê²½ ë¶€ë¶„) - node_modules í¬í•¨í•˜ì—¬ ë³µì‚¬
          echo "ğŸ“‚ í”„ë¡œì íŠ¸ íŒŒì¼ ë³µì‚¬ ì¤‘..."
          cp -r front/frontend/* "$BUILD_DIR/"
          
          # í˜„ì¬ ë””ë ‰í† ë¦¬ì— Dockerfile ìƒì„± (ìˆ˜ì •ëœ Dockerfile)
          cat > "$BUILD_DIR/Dockerfile" << 'EOF'
FROM reactnativecommunity/react-native-android:latest

WORKDIR /app

# í”„ë¡œì íŠ¸ íŒŒì¼ ë³µì‚¬
COPY . /app

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV ANDROID_SDK_ROOT=/opt/android-sdk
ENV ANDROID_HOME=/opt/android-sdk

# í•„ìš”í•œ node ëª¨ë“ˆ ì„¤ì¹˜ (ì¶”ê°€ëœ ë¶€ë¶„)
RUN npm install

# Android ë””ë ‰í† ë¦¬ë¡œ ì´ë™ (ìˆ˜ì •ëœ ë¶€ë¶„)
WORKDIR /app/android

# ë¡œì»¬ í”„ë¡œí¼í‹° íŒŒì¼ ìƒì„±
RUN echo "sdk.dir=/opt/android-sdk" > local.properties

# gradlew ì‹¤í–‰ ê¶Œí•œ ì„¤ì •
RUN chmod +x ./gradlew

# APK ë¹Œë“œ
RUN ./gradlew assembleDebug --stacktrace
EOF
          
          # Dockerfile ê¸°ë°˜ìœ¼ë¡œ ì´ë¯¸ì§€ ë¹Œë“œ
          echo "ğŸ—ï¸ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
          docker build -t android-build:${BUILD_ID} "$BUILD_DIR"
          
          # ë¹Œë“œ ê²°ê³¼ë¬¼ ë³µì‚¬ (ê²½ë¡œ ìˆ˜ì •)
          echo "ğŸ”„ ë¹Œë“œ ê²°ê³¼ë¬¼ ë³µì‚¬ ì¤‘..."
          docker run --rm \
            -v "$WORKSPACE_DIR/apk:/output" \
            android-build:${BUILD_ID} \
            bash -c "mkdir -p /output && find /app/android -name '*.apk' -exec cp {} /output/ \\;"
          
          # ì´ë¯¸ì§€ ì‚­ì œ
          docker rmi android-build:${BUILD_ID}
          
          # ë¹Œë“œ ê²°ê³¼ í™•ì¸
          echo "ğŸ“‚ ë¹Œë“œ ê²°ê³¼ í™•ì¸:"
          find apk -name "*.apk" || echo "âŒ APK íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
          
          echo "===================================================="
        '''
      }
    }

    stage('Deploy to Firebase') {
      when { expression { env.BUILD_FRONTEND == 'true' } }
      steps {
        // Firebase ë°°í¬
        withCredentials([
          string(credentialsId: 'FIREBASE_TOKEN', variable: 'FIREBASE_TOKEN')
        ]) {
          sh '''
            echo "===================================================="
            echo "ğŸ”¥ Firebase ë°°í¬"
            echo "===================================================="
            
            # APK íŒŒì¼ ì°¾ê¸°
            APK_FILE=$(find "$(pwd)/apk" -name "*.apk" | head -1)
            
            if [ -z "$APK_FILE" ]; then
              echo "âŒ APK íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ Firebase ë°°í¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤"
              exit 0
            fi
            
            echo "âœ… ì—…ë¡œë“œí•  APK íŒŒì¼: $APK_FILE"
            
            # Dockerì—ì„œ Firebase ë°°í¬ ì‹¤í–‰
            docker run --rm \
              -v "$(pwd):/workspace" \
              -w /workspace \
              -e FIREBASE_TOKEN="$FIREBASE_TOKEN" \
              -e FIREBASE_APP_ID="$FIREBASE_APP_ID" \
              node:14 \
              bash -c '
                set -x
                
                echo "==== Node.js ë²„ì „ í™•ì¸ ===="
                node -v
                npm -v
                
                echo "==== Firebase CLI ì„¤ì¹˜ ===="
                npm install -g firebase-tools
                
                echo "==== APK íŒŒì¼ í™•ì¸ ===="
                APK_FILE=$(find /workspace/apk -name "*.apk" | head -1)
                
                if [ -z "$APK_FILE" ]; then
                  echo "âŒ APK íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
                  exit 0
                fi
                
                echo "âœ… APK íŒŒì¼: $APK_FILE"
                
                echo "==== Firebase ë°°í¬ ===="
                firebase appdistribution:distribute "$APK_FILE" \
                  --app "$FIREBASE_APP_ID" \
                  --token "$FIREBASE_TOKEN" \
                  --groups "testers" \
                  --release-notes "Jenkins CI ìë™ ë°°í¬ ë¹Œë“œ" || echo "âš ï¸ Firebase ë°°í¬ ì‹¤íŒ¨"
              '
            
            echo "===================================================="
          '''
        }
      }
    }

    stage('Archive APK') {
      when { expression { env.BUILD_FRONTEND == 'true' } }
      steps {
        sh '''
          echo "===================================================="
          echo "ğŸ“¦ APK ì•„ì¹´ì´ë¸Œ"
          echo "===================================================="
          
          mkdir -p apk-archive
          
          # apk ë””ë ‰í† ë¦¬ì—ì„œ APK íŒŒì¼ ì°¾ê¸°
          APK_COUNT=$(find "$(pwd)/apk" -name "*.apk" 2>/dev/null | wc -l || echo "0")
          
          if [ "$APK_COUNT" -gt 0 ]; then
            echo "âœ… $APK_COUNT ê°œì˜ APK íŒŒì¼ ë°œê²¬:"
            find "$(pwd)/apk" -name "*.apk" 2>/dev/null
            
            # ëª¨ë“  APK íŒŒì¼ì„ ì•„ì¹´ì´ë¸Œ ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬
            cp -r apk/*.apk apk-archive/ || true
          else
            echo "âŒ APK íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            echo "No APK files found" > apk-archive/build-failed.txt
          fi
          
          echo "===================================================="
        '''
        
        archiveArtifacts artifacts: 'apk-archive/**', fingerprint: true, allowEmptyArchive: true
      }
    }
  }

  post {
    success {
      sh '''
        echo "===================================================="
        echo "âœ… Frontend CI/CD ì„±ê³µ ğŸ‰"
        echo "===================================================="
      '''
    }
    failure {
      sh '''
        echo "===================================================="
        echo "âŒ Frontend CI/CD ì‹¤íŒ¨ â—"
        echo "===================================================="
      '''
    }
    always {
      sh '''
        echo "===================================================="
        echo "ğŸ§¹ ì‘ì—… ê³µê°„ ì •ë¦¬"
        echo "===================================================="
        
        # ì„ì‹œ ë””ë ‰í† ë¦¬ ì •ë¦¬
        rm -rf android-build apk || true
      '''
      cleanWs()
    }
  }
}