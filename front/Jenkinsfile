pipeline {
  agent any

  environment {
    // Android SDK ì„¤ì •
    ANDROID_SDK_ROOT = '/opt/android-sdk'
    ANDROID_HOME     = '/opt/android-sdk'
    PATH             = "${env.PATH}:/opt/android-sdk/cmdline-tools/latest/bin:/opt/android-sdk/platform-tools"
    // Fastlane Firebase App Distribution í† í°
    FIREBASE_TOKEN   = credentials('FIREBASE_TOKEN')
    // ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
    WORKSPACE_DIR    = "${env.WORKSPACE}"
    // ë¹Œë“œ ì •ë³´
    BUILD_TIME       = sh(script: 'date "+%Y-%m-%d %H:%M:%S"', returnStdout: true).trim()
    BUILD_ID         = "${env.BUILD_ID}"
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
        
        // ë¹Œë“œ ì‹œì‘ ë¡œê·¸
        sh """
          echo "===================================================="
          echo "ğŸš€ ë¹Œë“œ ì‹œì‘: ${env.BUILD_TIME}"
          echo "ğŸ” ë¹Œë“œ ID: ${env.BUILD_ID}"
          echo "ğŸ” Git ì»¤ë°‹: ${env.GIT_COMMIT}"
          echo "ğŸ” ë¸Œëœì¹˜: ${env.GIT_BRANCH}"
          echo "===================================================="
        """
      }
    }

    stage('Detect Frontend Changes') {
      steps {
        script {
          def diff = sh(
            script: "git diff --name-only ${env.GIT_PREVIOUS_SUCCESSFUL_COMMIT ?: 'HEAD~1'} ${env.GIT_COMMIT}",
            returnStdout: true
          ).trim()
          
          // ë³€ê²½ íŒŒì¼ ëª©ë¡ ì¶œë ¥
          echo "==== ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ===="
          echo "${diff}"
          echo "=========================="
          
          // front/frontend/ í•˜ìœ„ íŒŒì¼ ë³€ê²½ì´ ìˆìœ¼ë©´ ë¹Œë“œ
          env.BUILD_FRONTEND = diff.split('\n').any { it.startsWith('front/frontend/') } ? 'true' : 'false'
          echo env.BUILD_FRONTEND=='true'
               ? "â–¶ Frontend ë³€ê²½ ê°ì§€: ë¹Œë“œí•©ë‹ˆë‹¤"
               : "â–¶ Frontend ë³€ê²½ ì—†ìŒ: ìŠ¤í‚µí•©ë‹ˆë‹¤"
        }
      }
    }

    stage('Build & Distribute Frontend') {
      when { expression { env.BUILD_FRONTEND == 'true' } }
      steps {
        // ë¹Œë“œ í™˜ê²½ ì •ë³´ ì¶œë ¥
        sh '''
          echo "===================================================="
          echo "ğŸ“Š ë¹Œë“œ í™˜ê²½ ì •ë³´"
          echo "===================================================="
          echo "ğŸ–¥ï¸ í˜¸ìŠ¤íŠ¸ëª…: $(hostname)"
          echo "ğŸ§ OS ì •ë³´: $(cat /etc/os-release | grep PRETTY_NAME)"
          echo "ğŸ³ Docker ë²„ì „: $(docker --version)"
          echo "ğŸ§° Git ë²„ì „: $(git --version)"
          echo "===================================================="
        '''
        
        // ë””ë ‰í† ë¦¬ êµ¬ì¡° í™•ì¸ ë° ë””ë²„ê¹…
        sh '''
          echo "===================================================="
          echo "ğŸ“ ë””ë ‰í† ë¦¬ êµ¬ì¡° í™•ì¸"
          echo "===================================================="
          
          # ì‹œí¬ë¦¿ ë””ë ‰í† ë¦¬ ë§Œë“¤ê¸°
          mkdir -p front/frontend/android/app/keystore
          echo "âœ… front/frontend/android/app/keystore ë””ë ‰í† ë¦¬ ìƒì„± ì™„ë£Œ"
          
          echo "ğŸ“‚ ì‘ì—… ë””ë ‰í† ë¦¬: $(pwd)"
          
          echo "ğŸ“‚ ì „ì²´ ë””ë ‰í† ë¦¬ êµ¬ì¡°:"
          ls -la | sed 's/^/   /'
          
          echo "ğŸ“‚ front ë””ë ‰í† ë¦¬:"
          ls -la front | sed 's/^/   /'
          
          echo "ğŸ“‚ front/frontend ë””ë ‰í† ë¦¬:"
          ls -la front/frontend | sed 's/^/   /'
          
          echo "ğŸ“‚ front/frontend/android ë””ë ‰í† ë¦¬:"
          ls -la front/frontend/android | sed 's/^/   /'
          
          echo "ğŸ“‚ front/frontend/android/app ë””ë ‰í† ë¦¬:"
          ls -la front/frontend/android/app | sed 's/^/   /'
          
          echo "===================================================="
        '''
        
        // ì‹œí¬ë¦¿ íŒŒì¼ ì¤€ë¹„
        withCredentials([
          file(credentialsId: 'android-release-keystore', variable: 'KEYSTORE_FILE'),
          string(credentialsId: 'KEYSTORE_PASSWORD', variable: 'KEYSTORE_PASSWORD'),
          string(credentialsId: 'KEY_ALIAS', variable: 'KEY_ALIAS'),
          string(credentialsId: 'KEY_PASSWORD', variable: 'KEY_PASSWORD'),
          file(credentialsId: 'google-services-json', variable: 'GOOGLE_SERVICES_JSON'),
          file(credentialsId: 'firebase-service-account', variable: 'FIREBASE_SERVICE_ACCOUNT')
        ]) {
          sh '''
            echo "===================================================="
            echo "ğŸ” ì‹œí¬ë¦¿ íŒŒì¼ ì¤€ë¹„"
            echo "===================================================="
            
            cp "$KEYSTORE_FILE" front/frontend/android/app/keystore/release.keystore
            echo "âœ… Keystore íŒŒì¼ ë³µì‚¬ ì™„ë£Œ"
            
            cp "$GOOGLE_SERVICES_JSON" front/frontend/android/app/google-services.json
            echo "âœ… Google Services JSON íŒŒì¼ ë³µì‚¬ ì™„ë£Œ"
            
            cp "$FIREBASE_SERVICE_ACCOUNT" front/frontend/android/firebase_service_account.json
            echo "âœ… Firebase Service Account íŒŒì¼ ë³µì‚¬ ì™„ë£Œ"
            
            echo "===================================================="
          '''
        }
        
        // Docker ì»¨í…Œì´ë„ˆ ë‚´ë¶€ë¡œ í•„ìš”í•œ íŒŒì¼ ë³µì‚¬í•˜ì—¬ ì‘ì—…í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ë³€ê²½
        sh '''
          echo "===================================================="
          echo "ğŸ³ Docker ì»¨í…Œì´ë„ˆì—ì„œ ë¹Œë“œ ì‹œì‘"
          echo "===================================================="
          
          # ì„ì‹œ ë””ë ‰í† ë¦¬ ìƒì„±
          TEMP_DIR=$(mktemp -d)
          echo "ğŸ“ ì„ì‹œ ë””ë ‰í† ë¦¬ ìƒì„±: $TEMP_DIR"
          
          # í•„ìš”í•œ ë””ë ‰í† ë¦¬ë§Œ ë³µì‚¬ (ë³¼ë¥¨ ë§ˆìš´íŠ¸ ëŒ€ì‹ )
          echo "ğŸ”„ Android í”„ë¡œì íŠ¸ íŒŒì¼ ë³µì‚¬ ì¤‘..."
          cp -r front/frontend/android "$TEMP_DIR/"
          echo "âœ… íŒŒì¼ ë³µì‚¬ ì™„ë£Œ"
          
          echo "ğŸ“‚ ë³µì‚¬ëœ íŒŒì¼ í™•ì¸:"
          ls -la "$TEMP_DIR/android" | sed 's/^/   /'
          
          echo "ğŸš€ Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰..."
          
          # Docker ì»¨í…Œì´ë„ˆì—ì„œ ë¹Œë“œ ì‹¤í–‰
          set +e  # ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ê³„ì† ì§„í–‰í•˜ë„ë¡ ì„¤ì •
          docker run --rm \
            -v "$TEMP_DIR/android:/app" \
            -w /app \
            -e ANDROID_SDK_ROOT=/opt/android-sdk \
            -e ANDROID_HOME=/opt/android-sdk \
            -e FIREBASE_TOKEN="$FIREBASE_TOKEN" \
            -e KEYSTORE_PASSWORD="$KEYSTORE_PASSWORD" \
            -e KEY_ALIAS="$KEY_ALIAS" \
            -e KEY_PASSWORD="$KEY_PASSWORD" \
            my-android-ci:latest \
            bash -c "
              # ì—ëŸ¬ ë©”ì‹œì§€ ìì„¸íˆ ì¶œë ¥
              set -x
              
              echo '===================================================='
              echo 'ğŸ“‚ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ì‘ì—… ë””ë ‰í† ë¦¬:'
              pwd
              ls -la
              
              echo '===================================================='
              echo 'ğŸ§ª ì´ë¯¸ì§€ í™˜ê²½ ì •ë³´:'
              echo 'ğŸ” Node ë²„ì „: '
              node --version
              echo 'ğŸ” Yarn ë²„ì „: '
              yarn --version
              echo 'ğŸ” Ruby ë²„ì „: '
              ruby --version
              echo 'ğŸ” Fastlane ë²„ì „: '
              fastlane --version
              echo '===================================================='
              
              echo '===================================================='
              echo 'ğŸ“¦ 1) ì˜ì¡´ì„± ì„¤ì¹˜ ì‹œì‘'
              yarn install --verbose
              if [ \$? -ne 0 ]; then
                echo 'âŒ Yarn ì˜ì¡´ì„± ì„¤ì¹˜ ì‹¤íŒ¨'
                exit 1
              fi
              echo 'âœ… Yarn ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ'
              echo '===================================================='
              
              echo '===================================================='
              echo 'ğŸ“¦ 2) Bundle ì„¤ì¹˜ ì‹œì‘'
              bundle install --path vendor/bundle
              if [ \$? -ne 0 ]; then
                echo 'âŒ Bundle ì„¤ì¹˜ ì‹¤íŒ¨'
                exit 1
              fi
              echo 'âœ… Bundle ì„¤ì¹˜ ì™„ë£Œ'
              echo '===================================================='
              
              echo '===================================================='
              echo 'ğŸ“¦ 3) Fastlane í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜ ì‹œì‘'
              bundle exec fastlane install_plugins
              if [ \$? -ne 0 ]; then
                echo 'âŒ Fastlane í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜ ì‹¤íŒ¨'
                exit 1
              fi
              echo 'âœ… Fastlane í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜ ì™„ë£Œ'
              echo '===================================================='
              
              echo '===================================================='
              echo 'ğŸ—ï¸ 4) ë¦´ë¦¬ìŠ¤ ë¹Œë“œ ë° ë°°í¬ ì‹œì‘'
              
              echo 'ğŸ“‚ ì‘ì—… ë””ë ‰í† ë¦¬ í™•ì¸:'
              ls -la
              
              echo 'ğŸ“‚ app ë””ë ‰í† ë¦¬ í™•ì¸:'
              ls -la app
              
              echo 'ğŸ“‚ app/keystore ë””ë ‰í† ë¦¬ í™•ì¸:'
              ls -la app/keystore
              
              echo 'ğŸ“„ google-services.json í™•ì¸:'
              if [ -f app/google-services.json ]; then
                echo 'âœ… google-services.json íŒŒì¼ ì¡´ì¬'
              else
                echo 'âŒ google-services.json íŒŒì¼ ì—†ìŒ'
                exit 1
              fi
              
              echo 'ğŸ“„ firebase_service_account.json í™•ì¸:'
              if [ -f firebase_service_account.json ]; then
                echo 'âœ… firebase_service_account.json íŒŒì¼ ì¡´ì¬'
              else
                echo 'âŒ firebase_service_account.json íŒŒì¼ ì—†ìŒ'
                exit 1
              fi
              
              bundle exec fastlane release groups:\\\"testers\\\" notes:\\\"CI ìë™ ë°°í¬ ë¹Œë“œ\\\"
              BUILD_RESULT=\$?
              
              if [ \$BUILD_RESULT -ne 0 ]; then
                echo 'âŒ ë¦´ë¦¬ìŠ¤ ë¹Œë“œ ë° ë°°í¬ ì‹¤íŒ¨ (ì¢…ë£Œ ì½”ë“œ: '\$BUILD_RESULT')'
                
                echo 'ğŸ“‚ ë¹Œë“œ ë¡œê·¸ í™•ì¸:'
                ls -la app/build || echo 'ë¹Œë“œ ë””ë ‰í† ë¦¬ê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤'
                
                # ì—ëŸ¬ ë¡œê·¸ í™•ì¸ ì‹œë„
                if [ -d app/build/outputs ]; then
                  echo 'ğŸ“„ ë¹Œë“œ ì¶œë ¥ íŒŒì¼:'
                  ls -la app/build/outputs
                fi
                
                exit \$BUILD_RESULT
              fi
              echo 'âœ… ë¦´ë¦¬ìŠ¤ ë¹Œë“œ ë° ë°°í¬ ì™„ë£Œ'
              
              echo 'ğŸ“‚ ë¹Œë“œ ê²°ê³¼ë¬¼ í™•ì¸:'
              ls -la app/build/outputs/apk || echo 'ë¹Œë“œëœ APKë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'
              echo '===================================================='
            "
          BUILD_RESULT=$?
          
          echo "Docker ì»¨í…Œì´ë„ˆ ì¢…ë£Œ (ì¢…ë£Œ ì½”ë“œ: $BUILD_RESULT)"
          
          if [ $BUILD_RESULT -ne 0 ]; then
            echo "âŒ Docker ì»¨í…Œì´ë„ˆì—ì„œ ë¹Œë“œ ì‹¤íŒ¨"
          else
            echo "âœ… Docker ì»¨í…Œì´ë„ˆì—ì„œ ë¹Œë“œ ì„±ê³µ"
          fi
          
          # ë¹Œë“œ ê²°ê³¼ë¬¼ ë³µì‚¬ (APK íŒŒì¼ ë“±)
          echo "ğŸ”„ ë¹Œë“œ ê²°ê³¼ë¬¼ ë³µì‚¬ ì¤‘..."
          if [ -d "$TEMP_DIR/android/app/build" ]; then
            mkdir -p front/frontend/android/app/build
            cp -r "$TEMP_DIR/android/app/build" front/frontend/android/app/
            echo "âœ… ë¹Œë“œ ê²°ê³¼ë¬¼ ë³µì‚¬ ì™„ë£Œ"
          else
            echo "âŒ ë¹Œë“œ ê²°ê³¼ë¬¼ ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          fi
          
          # APK íŒŒì¼ ì¡´ì¬ í™•ì¸
          if [ -d "front/frontend/android/app/build/outputs/apk" ]; then
            echo "ğŸ“‚ APK íŒŒì¼ ëª©ë¡:"
            find front/frontend/android/app/build/outputs/apk -name "*.apk" | sed 's/^/   /'
          else
            echo "âŒ APK ì¶œë ¥ ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          fi
          
          # ì„ì‹œ ë””ë ‰í† ë¦¬ ì •ë¦¬
          echo "ğŸ§¹ ì„ì‹œ ë””ë ‰í† ë¦¬ ì •ë¦¬ ì¤‘..."
          rm -rf "$TEMP_DIR"
          echo "âœ… ì •ë¦¬ ì™„ë£Œ"
          
          echo "===================================================="
          
          # ë¹Œë“œ ê²°ê³¼ ë°˜í™˜
          exit $BUILD_RESULT
        '''
      }
    }

    stage('Archive APK') {
      when { expression { env.BUILD_FRONTEND == 'true' } }
      steps {
        sh '''
          echo "===================================================="
          echo "ğŸ“¦ APK ì•„ì¹´ì´ë¸Œ ì‹œì‘"
          echo "===================================================="
          
          # APK íŒŒì¼ ì¡´ì¬ í™•ì¸
          APK_COUNT=$(find front/frontend/android/app/build/outputs -name "*.apk" | wc -l)
          
          if [ $APK_COUNT -gt 0 ]; then
            echo "âœ… $APK_COUNT ê°œì˜ APK íŒŒì¼ ë°œê²¬"
            find front/frontend/android/app/build/outputs -name "*.apk" | sed 's/^/   /'
          else
            echo "âŒ APK íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          fi
          
          echo "===================================================="
        '''
        
        archiveArtifacts artifacts: 'front/frontend/android/app/build/outputs/**/*.apk', fingerprint: true, allowEmptyArchive: true
      }
    }
  }

  post {
    always {
      sh '''
        echo "===================================================="
        echo "ğŸ§¹ ì‘ì—… ê³µê°„ ì •ë¦¬"
        echo "===================================================="
      '''
      cleanWs()
    }
    success {
      sh '''
        echo "===================================================="
        echo "âœ… Frontend CI/CD ì„±ê³µ ğŸ‰"
        echo "===================================================="
      '''
    }
    failure {
      sh '''
        echo "===================================================="
        echo "âŒ Frontend CI/CD ì‹¤íŒ¨ â—"
        echo "===================================================="
      '''
    }
  }
}