pipeline {
  agent any

  environment {
    // Firebase ë°°í¬ ì •ë³´
    FIREBASE_TOKEN   = credentials('FIREBASE_TOKEN')
    FIREBASE_APP_ID  = '1:189536895445:android:783ed885fd7c4b896bfd5c'
    // í‚¤ìŠ¤í† ì–´ ê´€ë ¨ ì„¤ì •
    KEYSTORE_PASSWORD = credentials('KEYSTORE_PASSWORD')
    KEY_ALIAS        = credentials('KEY_ALIAS')
    KEY_PASSWORD     = credentials('KEY_PASSWORD')
    // CircleCI Android ì´ë¯¸ì§€ ì‚¬ìš©
    DOCKER_IMAGE     = 'cimg/android:2023.08'
    // ì‘ì—… ë””ë ‰í† ë¦¬ ë³€ìˆ˜ ì¶”ê°€
    WORK_DIR         = "${WORKSPACE}/workspace"
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
        
        // ë¹Œë“œ ì‹œì‘ ë¡œê·¸
        sh '''
          echo "===================================================="
          echo "ğŸš€ ë¹Œë“œ ì‹œì‘: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ” ë¹Œë“œ ID: ${BUILD_ID}"
          echo "ğŸ” Git ì»¤ë°‹: ${GIT_COMMIT}"
          echo "ğŸ” ë¸Œëœì¹˜: ${GIT_BRANCH}"
          echo "ğŸ” ì‘ì—… ë””ë ‰í† ë¦¬: ${WORKSPACE}"
          echo "===================================================="
        '''
      }
    }

    stage('Check Docker Image') {
      steps {
        sh '''
          echo "===================================================="
          echo "ğŸ” Docker ì´ë¯¸ì§€ í™•ì¸"
          echo "===================================================="
          
          # Docker ì´ë¯¸ì§€ í™•ì¸
          if docker image inspect ${DOCKER_IMAGE} >/dev/null 2>&1; then
            echo "âœ… Docker ì´ë¯¸ì§€ ${DOCKER_IMAGE}ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤."
          else
            echo "ğŸ”„ Docker ì´ë¯¸ì§€ ${DOCKER_IMAGE}ë¥¼ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤."
            docker pull ${DOCKER_IMAGE} || {
              echo "âŒ Docker ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨! ì‚¬ìš© ê°€ëŠ¥í•œ ì´ë¯¸ì§€ì¸ì§€ í™•ì¸í•˜ì„¸ìš”."
              exit 1
            }
          fi
          
          echo "===================================================="
        '''
      }
    }

    stage('Prepare Build Environment') {
      steps {
        sh '''
          echo "===================================================="
          echo "ğŸ”§ ë¹Œë“œ í™˜ê²½ ì¤€ë¹„"
          echo "===================================================="
          
          # ì„ì‹œ ì‘ì—… ë””ë ‰í† ë¦¬ ìƒì„± (ì „ì²´ ê²½ë¡œ ì‚¬ìš©)
          rm -rf ${WORK_DIR}
          mkdir -p ${WORK_DIR}
          
          # ë””ë²„ê¹…: ì›ë³¸ ë””ë ‰í† ë¦¬ êµ¬ì¡° í™•ì¸
          echo "ğŸ“‚ ì›ë³¸ frontend ë””ë ‰í† ë¦¬ êµ¬ì¡°:"
          ls -la front/frontend/
          
          # í”„ë¡œì íŠ¸ íŒŒì¼ ë³µì‚¬ (ëª¨ë“  íŒŒì¼ì„ ë³µì‚¬í•˜ê¸° ìœ„í•´ ./* ì‚¬ìš©)
          echo "ğŸ“‚ í”„ë¡œì íŠ¸ íŒŒì¼ ë³µì‚¬"
          cp -a front/frontend/. ${WORK_DIR}/
          
          # íŒŒì¼ ëª©ë¡ í™•ì¸ (ë” ìì„¸í•œ ë¡œê¹…)
          echo "ğŸ“‚ ë³µì‚¬ëœ íŒŒì¼ í™•ì¸:"
          ls -la ${WORK_DIR}
          
          # package.json í™•ì¸
          echo "ğŸ“„ package.json í™•ì¸:"
          cat ${WORK_DIR}/package.json | head -20 || echo "package.json íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          
          # ê¶Œí•œ ì„¤ì • (ëª¨ë“  ì‚¬ìš©ìê°€ ì½ê³  ì“¸ ìˆ˜ ìˆë„ë¡)
          chmod -R 777 ${WORK_DIR}
          
          # íŒŒì¼ ê¶Œí•œ í™•ì¸
          echo "ğŸ“„ ì¤‘ìš” íŒŒì¼ ê¶Œí•œ í™•ì¸:"
          ls -la ${WORK_DIR}/package.json || echo "package.json íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          
          echo "===================================================="
        '''
      }
    }

    stage('Prepare Secret Files') {
      steps {
        withCredentials([
          file(credentialsId: 'android-release-keystore', variable: 'KEYSTORE_FILE'),
          file(credentialsId: 'google-services-json', variable: 'GOOGLE_SERVICES_JSON'),
          file(credentialsId: 'firebase-service-account', variable: 'FIREBASE_SERVICE_ACCOUNT')
        ]) {
          sh '''
            echo "===================================================="
            echo "ğŸ” ì‹œí¬ë¦¿ íŒŒì¼ ì¤€ë¹„"
            echo "===================================================="
            
            # ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p ${WORK_DIR}/android/app/keystore
            
            # ì‹œí¬ë¦¿ íŒŒì¼ ë³µì‚¬
            cp "$FIREBASE_SERVICE_ACCOUNT" ${WORK_DIR}/android/firebase_service_account.json
            cp "$GOOGLE_SERVICES_JSON" ${WORK_DIR}/android/app/google-services.json
            cp "$KEYSTORE_FILE" ${WORK_DIR}/android/app/keystore/release.keystore
            
            # ê¶Œí•œ ì„¤ì •
            chmod -R 777 ${WORK_DIR}/android/app/keystore
            chmod 666 ${WORK_DIR}/android/firebase_service_account.json
            chmod 666 ${WORK_DIR}/android/app/google-services.json
            chmod 666 ${WORK_DIR}/android/app/keystore/release.keystore
            
            echo "===================================================="
          '''
        }
      }
    }

    stage('Debug File System') {
      steps {
        sh '''
          echo "===================================================="
          echo "ğŸ” íŒŒì¼ ì‹œìŠ¤í…œ ë””ë²„ê¹…"
          echo "===================================================="
          
          # í˜„ì¬ ë””ë ‰í† ë¦¬ ë° ì‘ì—… ë””ë ‰í† ë¦¬ í™•ì¸
          echo "ğŸ“‚ í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
          echo "ğŸ“‚ ì‘ì—… ë””ë ‰í† ë¦¬: ${WORK_DIR}"
          
          # ì‘ì—… ë””ë ‰í† ë¦¬ ë‚´ìš© í™•ì¸
          echo "ğŸ“„ ì‘ì—… ë””ë ‰í† ë¦¬ ë‚´ìš©:"
          ls -la ${WORK_DIR}
          
          # package.json íŒŒì¼ ì‹œìŠ¤í…œ ì •ë³´ í™•ì¸
          echo "ğŸ“„ package.json íŒŒì¼ ì‹œìŠ¤í…œ ì •ë³´:"
          stat ${WORK_DIR}/package.json || echo "package.json íŒŒì¼ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          
          # Docker ì •ë³´ í™•ì¸
          echo "ğŸ³ Docker ë²„ì „:"
          docker --version
          
          # SELinux ìƒíƒœ í™•ì¸ (ë³¼ë¥¨ ë§ˆìš´íŠ¸ì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆìŒ)
          echo "ğŸ”’ SELinux ìƒíƒœ:"
          getenforce 2>/dev/null || echo "SELinux ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          
          # Docker í˜¸ìŠ¤íŠ¸ ì •ë³´ í™•ì¸
          echo "ğŸ³ Docker í˜¸ìŠ¤íŠ¸ ì •ë³´:"
          docker info | grep -E "Storage Driver|Root Dir"
          
          echo "===================================================="
          
          # ì‘ì—… ë””ë ‰í† ë¦¬ë¥¼ ì•„ì¹´ì´ë¸Œë¡œ ë§Œë“¤ì–´ Dockerì—ì„œ ì¶”ì¶œí•˜ëŠ” ëŒ€ì•ˆ í…ŒìŠ¤íŠ¸
          echo "ğŸ“¦ ì‘ì—… ë””ë ‰í† ë¦¬ ì•„ì¹´ì´ë¸Œ ìƒì„±"
          tar -czf ${WORKSPACE}/workspace.tar.gz -C ${WORK_DIR} .
          
          echo "===================================================="
        '''
      }
    }

    stage('Docker Volume Test') {
      steps {
        sh '''
          echo "===================================================="
          echo "ğŸ” Docker ë³¼ë¥¨ ë§ˆìš´íŠ¸ í…ŒìŠ¤íŠ¸ (ë‹¤ì–‘í•œ ë°©ë²• ì‹œë„)"
          echo "===================================================="
          
          # ë°©ë²• 1: ì¼ë°˜ ë³¼ë¥¨ ë§ˆìš´íŠ¸
          echo "ğŸ” ë°©ë²• 1: ì¼ë°˜ ë³¼ë¥¨ ë§ˆìš´íŠ¸"
          docker run --rm \
            -v "${WORK_DIR}:/project" \
            --workdir /project \
            ${DOCKER_IMAGE} \
            bash -c "ls -la && (cat package.json | head -5 || echo 'package.json íŒŒì¼ ì—†ìŒ')"
          
          # ë°©ë²• 2: íŒŒì¼ ê²½ë¡œì— ë”°ì˜´í‘œ ì¶”ê°€
          echo "ğŸ” ë°©ë²• 2: íŒŒì¼ ê²½ë¡œì— ë”°ì˜´í‘œ ì¶”ê°€"
          docker run --rm \
            -v "${WORK_DIR}":/project \
            --workdir /project \
            ${DOCKER_IMAGE} \
            bash -c "ls -la && (cat package.json | head -5 || echo 'package.json íŒŒì¼ ì—†ìŒ')"
          
          # ë°©ë²• 3: ì•„ì¹´ì´ë¸Œ ì¶”ì¶œ ë°©ì‹
          echo "ğŸ” ë°©ë²• 3: ì•„ì¹´ì´ë¸Œ ì¶”ì¶œ ë°©ì‹"
          docker run --rm \
            -v "${WORKSPACE}/workspace.tar.gz:/workspace.tar.gz" \
            ${DOCKER_IMAGE} \
            bash -c '
          echo "--- ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ì •ë³´ ---"
          whoami Â # í˜„ì¬ ì‚¬ìš©ì í™•ì¸
          ls -la / Â # ë£¨íŠ¸ ë””ë ‰í† ë¦¬ ê¶Œí•œ í™•ì¸
          echo "-------------------------"

          mkdir -p /project && tar -xzf /workspace.tar.gz -C /project && cd /project && ls -la && (cat package.json | head -5 || echo 'package.json íŒŒì¼ ì—†ìŒ')
        '
          
          echo "===================================================="
        '''
      }
    }

    stage('Build in Docker (Using Archive Method)') {
      steps {
        sh '''
          echo "===================================================="
          echo "ğŸš€ Docker ë‚´ë¶€ì—ì„œ ë¹Œë“œ ì‹¤í–‰ (ì•„ì¹´ì´ë¸Œ ë°©ì‹)"
          echo "===================================================="
          
          # Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (ì•„ì¹´ì´ë¸Œ ë°©ì‹)
          docker run --rm \
            -v "${WORKSPACE}/workspace.tar.gz:/workspace.tar.gz" \
            -v "${WORKSPACE}/apk:/output" \
            ${DOCKER_IMAGE} \
            bash -c '
              set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨
              
              # ì‘ì—… ë””ë ‰í† ë¦¬ ì¤€ë¹„
              mkdir -p /project
              tar -xzf /workspace.tar.gz -C /project
              cd /project
              
              echo "ğŸ“‚ í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
              ls -la
              
              echo "ğŸ“¦ Node.js ì¢…ì†ì„± ì„¤ì¹˜"
              if [ ! -f "package.json" ]; then
                echo "âŒ package.json íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!"
                echo "í˜„ì¬ ë””ë ‰í† ë¦¬ ë‚´ìš©:"
                ls -la
                exit 1
              fi
              
              # Node.js ë²„ì „ í™•ì¸
              NODE_VERSION=$(node --version || echo "Node.jsê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤")
              NPM_VERSION=$(npm --version || echo "npmì´ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤")
              echo "Node.js ë²„ì „: $NODE_VERSION"
              echo "npm ë²„ì „: $NPM_VERSION"
              
              npm install
              
              echo "ğŸ“‚ node_modules ì„¤ì¹˜ í™•ì¸"
              ls -la node_modules/@react-native || echo "React Native ëª¨ë“ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
              
              echo "ğŸ”§ Android ë¹Œë“œ ì¤€ë¹„"
              cd android
              chmod +x ./gradlew
              
              echo "ğŸ”§ local.properties ìƒì„±"
              echo "sdk.dir=$ANDROID_HOME" > local.properties
              
              echo "ğŸ”§ Gradle í”„ë¡œí¼í‹° ì„¤ì •"
              cat >> gradle.properties << EOF

# CI í™˜ê²½ í‚¤ìŠ¤í† ì–´ ì„¤ì •
KEYSTORE_PASSWORD='"'"'$KEYSTORE_PASSWORD'"'"'
KEY_ALIAS='"'"'$KEY_ALIAS'"'"'
KEY_PASSWORD='"'"'$KEY_PASSWORD'"'"'
EOF
              
              echo "ğŸ”§ Gradle ë¹Œë“œ ì‹¤í–‰"
              ./gradlew clean --stacktrace
              ./gradlew assembleDebug --stacktrace
              
              echo "ğŸ”§ ë¹Œë“œ ê²°ê³¼ í™•ì¸"
              find . -name "*.apk" 
              
              # APK íŒŒì¼ ë³µì‚¬
              mkdir -p /output
              find . -name "*.apk" -exec cp {} /output/ ";"
            '
          
          # APK íŒŒì¼ ì •ë¦¬
          mkdir -p apk-archive
          find ${WORKSPACE}/apk -name "*.apk" -exec cp {} apk-archive/ ";" || echo "APK íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"
          
          # ê²°ê³¼ í™•ì¸
          APK_COUNT=$(find apk-archive -name "*.apk" | wc -l)
          
          if [ "$APK_COUNT" -gt 0 ]; then
            echo "âœ… $APK_COUNT ê°œì˜ APK íŒŒì¼ì´ ìˆìŠµë‹ˆë‹¤:"
            find apk-archive -name "*.apk" | xargs ls -la
          else
            echo "âŒ APK íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"
            echo "No APK files found" > apk-archive/build-failed.txt
          fi
          
          echo "===================================================="
        '''
        
        archiveArtifacts artifacts: 'apk-archive/**', fingerprint: true, allowEmptyArchive: true
      }
    }

    stage('Deploy to Firebase') {
      steps {
        withCredentials([
          string(credentialsId: 'FIREBASE_TOKEN', variable: 'FIREBASE_TOKEN')
        ]) {
          sh '''
            echo "===================================================="
            echo "ğŸ”¥ Firebase ë°°í¬"
            echo "===================================================="
            
            # APK íŒŒì¼ ì°¾ê¸°
            APK_FILE=$(find "${WORKSPACE}/apk-archive" -name "*.apk" | head -1)
            
            if [ -z "$APK_FILE" ]; then
              echo "âŒ APK íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ Firebase ë°°í¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤"
              exit 0
            fi
            
            echo "âœ… ì—…ë¡œë“œí•  APK íŒŒì¼: $APK_FILE"
            
            # Firebase ë°°í¬ ì‹¤í–‰
            docker run --rm \
              -v "${APK_FILE}:/app.apk" \
              -e FIREBASE_TOKEN="$FIREBASE_TOKEN" \
              -e FIREBASE_APP_ID="$FIREBASE_APP_ID" \
              ${DOCKER_IMAGE} \
              bash -c '
                # Firebase CLI ì„¤ì¹˜
                npm install -g firebase-tools
                
                echo "ğŸ”¥ Firebase App Distribution ì‹¤í–‰"
                firebase appdistribution:distribute "/app.apk" \
                  --app "$FIREBASE_APP_ID" \
                  --token "$FIREBASE_TOKEN" \
                  --groups "testers" \
                  --release-notes "Jenkins CI ìë™ ë°°í¬ ë¹Œë“œ #${BUILD_ID} (${GIT_COMMIT})"
              '
            
            echo "===================================================="
          '''
        }
      }
    }
  }

  post {
    success {
      sh '''
        echo "===================================================="
        echo "âœ… Frontend CI/CD ì„±ê³µ ğŸ‰"
        echo "===================================================="
      '''
    }
    failure {
      sh '''
        echo "===================================================="
        echo "âŒ Frontend CI/CD ì‹¤íŒ¨ â—"
        echo "===================================================="
        
        # ë””ë²„ê¹… ì •ë³´ ìˆ˜ì§‘
        echo "# ë¹Œë“œ ì‹¤íŒ¨ ë””ë²„ê¹… ì •ë³´" > debug-info.md
        echo "" >> debug-info.md
        
        echo "## ë¹Œë“œ ë””ë ‰í† ë¦¬ ì •ë³´" >> debug-info.md
        ls -la ${WORK_DIR} 2>/dev/null >> debug-info.md || echo "ë¹Œë“œ ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤" >> debug-info.md
        echo "" >> debug-info.md
        
        echo "## package.json íŒŒì¼ ë‚´ìš©" >> debug-info.md
        cat ${WORK_DIR}/package.json 2>/dev/null >> debug-info.md || echo "package.json íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤" >> debug-info.md
        echo "" >> debug-info.md
        
        echo "## Docker ìƒíƒœ" >> debug-info.md
        docker info 2>/dev/null >> debug-info.md || echo "Docker ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" >> debug-info.md
        echo "" >> debug-info.md
        
        # ë””ë²„ê¹… ì •ë³´ ì•„ì¹´ì´ë¸Œ
        mkdir -p debug-archive
        cp debug-info.md debug-archive/
        
        echo "ğŸ“¦ ë””ë²„ê¹… ì •ë³´ê°€ debug-archiveì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤"
      '''
      
      archiveArtifacts artifacts: 'debug-archive/**', fingerprint: true, allowEmptyArchive: true
    }
    always {
      sh '''
        echo "===================================================="
        echo "ğŸ§¹ ì‘ì—… ê³µê°„ ì •ë¦¬"
        echo "===================================================="
        
        # ì„ì‹œ ë””ë ‰í† ë¦¬ ì •ë¦¬
        rm -rf ${WORK_DIR} workspace.tar.gz apk apk-archive debug-archive || true
      '''
      cleanWs()
    }
  }
}